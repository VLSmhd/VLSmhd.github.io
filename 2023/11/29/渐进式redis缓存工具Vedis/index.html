<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>渐进式redis缓存工具Vedis | VLS_Blog</title><meta name="author" content="Vlong_shen"><meta name="copyright" content="Vlong_shen"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="环境搭建 git命令封装 提交当前变更： 12345git pullgit add .git commit -m &quot;[Feature] add for new&quot;git pushgit status 项目格式搭建   image-20231204145729602   Vedis-api： Vedis-core Vedis-test：测试项目模块  总">
<meta property="og:type" content="article">
<meta property="og:title" content="渐进式redis缓存工具Vedis">
<meta property="og:url" content="https://vlsmhd.github.io/2023/11/29/%E6%B8%90%E8%BF%9B%E5%BC%8Fredis%E7%BC%93%E5%AD%98%E5%B7%A5%E5%85%B7Vedis/index.html">
<meta property="og:site_name" content="VLS_Blog">
<meta property="og:description" content="环境搭建 git命令封装 提交当前变更： 12345git pullgit add .git commit -m &quot;[Feature] add for new&quot;git pushgit status 项目格式搭建   image-20231204145729602   Vedis-api： Vedis-core Vedis-test：测试项目模块  总">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://vlsmhd.github.io/img/avatar.jpg">
<meta property="article:published_time" content="2023-11-29T13:45:19.032Z">
<meta property="article:modified_time" content="2024-01-14T13:00:01.938Z">
<meta property="article:author" content="Vlong_shen">
<meta property="article:tag" content="learn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://vlsmhd.github.io/img/avatar.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://vlsmhd.github.io/2023/11/29/%E6%B8%90%E8%BF%9B%E5%BC%8Fredis%E7%BC%93%E5%AD%98%E5%B7%A5%E5%85%B7Vedis/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '渐进式redis缓存工具Vedis',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-01-14 21:00:01'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="VLS_Blog" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">126</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">21</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">73</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/photos/"><i class="fa-fw fas fa-images"></i><span> Photo</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="VLS_Blog"><img class="site-icon" src="https://vlsmhd.github.io/img/avatar.jpg"/><span class="site-name">VLS_Blog</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/photos/"><i class="fa-fw fas fa-images"></i><span> Photo</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">渐进式redis缓存工具Vedis</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-11-29T13:45:19.032Z" title="发表于 2023-11-29 21:45:19">2023-11-29</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-01-14T13:00:01.938Z" title="更新于 2024-01-14 21:00:01">2024-01-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%A1%B9%E7%9B%AE/">项目</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%A1%B9%E7%9B%AE/redis/">redis</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="渐进式redis缓存工具Vedis"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="环境搭建">环境搭建</h1>
<h2 id="git命令封装">git命令封装</h2>
<p>提交当前变更：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git pull</span><br><span class="line">git add .</span><br><span class="line">git commit -m <span class="string">&quot;[Feature] add for new&quot;</span></span><br><span class="line">git push</span><br><span class="line">git status</span><br></pre></td></tr></table></figure>
<h2 id="项目格式搭建">项目格式搭建</h2>
<figure>
<img src="渐进式redis缓存工具Vedis/image-20231204145729602.png"
alt="image-20231204145729602" />
<figcaption aria-hidden="true">image-20231204145729602</figcaption>
</figure>
<ul>
<li>Vedis-api：</li>
<li>Vedis-core</li>
<li>Vedis-test：测试项目模块</li>
</ul>
<p>总项目pom文件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.vls<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>Vedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>Vedis-api<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>Vedis-core<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>Vedis-test<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--============================== All Plugins START ==============================--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin.compiler.version</span>&gt;</span>3.2<span class="tag">&lt;/<span class="name">plugin.compiler.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin.compiler.version</span>&gt;</span>3.2<span class="tag">&lt;/<span class="name">plugin.compiler.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin.surefire.version</span>&gt;</span>2.18.1<span class="tag">&lt;/<span class="name">plugin.surefire.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin.surefire.skip-it</span>&gt;</span>false<span class="tag">&lt;/<span class="name">plugin.surefire.skip-it</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin.surefire.ignore-failure</span>&gt;</span>false<span class="tag">&lt;/<span class="name">plugin.surefire.ignore-failure</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin.maven-source-plugin.version</span>&gt;</span>2.2.1<span class="tag">&lt;/<span class="name">plugin.maven-source-plugin.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin.maven-javadoc-plugin.version</span>&gt;</span>2.9.1<span class="tag">&lt;/<span class="name">plugin.maven-javadoc-plugin.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin.maven-gpg-plugin.version</span>&gt;</span>1.5<span class="tag">&lt;/<span class="name">plugin.maven-gpg-plugin.version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin.coveralls.version</span>&gt;</span>4.3.0<span class="tag">&lt;/<span class="name">plugin.coveralls.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin.cobertura.version</span>&gt;</span>2.7<span class="tag">&lt;/<span class="name">plugin.cobertura.version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--============================== MAIN ==============================--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.compiler.level</span>&gt;</span>1.7<span class="tag">&lt;/<span class="name">project.compiler.level</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--============================== INTER ==============================--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">heaven.version</span>&gt;</span>0.1.115<span class="tag">&lt;/<span class="name">heaven.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">test.version</span>&gt;</span>0.0.1<span class="tag">&lt;/<span class="name">test.version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--============================== OTHER ==============================--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">junit.version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">junit.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--============================== SELF ==============================--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.vls<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>Vedis-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.vls<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>Vedis-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!--============================== INTER ==============================--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.houbb<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>heaven<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;heaven.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.houbb<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>test-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;test.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!--============================== OTHER ==============================--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;junit.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--compiler plugin --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;plugin.compiler.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>$&#123;project.compiler.level&#125;<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>$&#123;project.compiler.level&#125;<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>$&#123;project.build.sourceEncoding&#125;<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">compilerArgument</span>&gt;</span>-proc:none<span class="tag">&lt;/<span class="name">compilerArgument</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- Javadoc --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-javadoc-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;plugin.maven-javadoc-plugin.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--============================== ADD For sonatype START ==============================--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>cache<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>cache is a java bean copy tool.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.sonatype.oss<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>oss-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">licenses</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">license</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>The Apache Software License, Version 2.0<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://www.apache.org/licenses/LICENSE-2.0.txt<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">distribution</span>&gt;</span>repo<span class="tag">&lt;/<span class="name">distribution</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">license</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">licenses</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scm</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://github.com/houbb/cache<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">connection</span>&gt;</span>https://github.com/houbb/cache.git<span class="tag">&lt;/<span class="name">connection</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">developerConnection</span>&gt;</span>https://houbb.github.io/<span class="tag">&lt;/<span class="name">developerConnection</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">scm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">developers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">developer</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>houbb<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">email</span>&gt;</span>houbinbin.echo@gmail.com<span class="tag">&lt;/<span class="name">email</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://houbb.github.io/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">developer</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">developers</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--============================== ADD For sonatype END ==============================--&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--mvn clean deploy -P release -Darguments=&quot;gpg.passphrase=设置gpg设置密钥时候输入的Passphrase&quot;--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">profiles</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>release<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!-- Source --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-source-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;plugin.maven-source-plugin.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">goal</span>&gt;</span>jar-no-fork<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!-- Javadoc --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-javadoc-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;plugin.maven-javadoc-plugin.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">goal</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!-- GPG --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-gpg-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;plugin.maven-gpg-plugin.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">phase</span>&gt;</span>verify<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">goal</span>&gt;</span>sign<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">&lt;!--=================================== coveralls START ===================================--&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!--mvn cobertura:cobertura coveralls:report -DrepoToken=yourcoverallsprojectrepositorytoken--&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.eluder.coveralls<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>coveralls-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;plugin.coveralls.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.codehaus.mojo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cobertura-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;plugin.cobertura.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">format</span>&gt;</span>xml<span class="tag">&lt;/<span class="name">format</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">maxmem</span>&gt;</span>256m<span class="tag">&lt;/<span class="name">maxmem</span>&gt;</span></span><br><span class="line">                            <span class="comment">&lt;!-- aggregated reports for multi-module projects --&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">aggregate</span>&gt;</span>true<span class="tag">&lt;/<span class="name">aggregate</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">instrumentation</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>**/*Test.class<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">instrumentation</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!--=================================== coveralls END ===================================--&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">distributionManagement</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">snapshotRepository</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">id</span>&gt;</span>oss<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://oss.sonatype.org/content/repositories/snapshots/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">snapshotRepository</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">id</span>&gt;</span>oss<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://oss.sonatype.org/service/local/staging/deploy/maven2/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">distributionManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>子项目pom文件：</p>
<p>api：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.vls<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>Vedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>Vedis-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>core：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.vls<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>Vedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>Vedis-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.vls<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>Vedis-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="基础固定大小缓存">基础固定大小缓存</h1>
<h2 id="接口定义">接口定义</h2>
<p>ICache：缓存接口，供使用的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> VLS</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: 定义最基本的map接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/12/4 15:31</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ICache</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">Map</span>&lt;K,V&gt; &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ICacheContext：缓存上下文对象，核心容器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> VLS</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/12/4 17:35</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ICacheContext</span>&lt;K,V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     *  获取容器</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Map&lt;K,V&gt; <span class="title function_">map</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 获取容器大小限制</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">sizeLimit</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 淘汰策略</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ICacheEvict&lt;K,V&gt; <span class="title function_">cacheEvict</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="核心实现">核心实现</h2>
<h3 id="全局异常"><strong>全局异常</strong></h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheRuntimeException</span> <span class="keyword">extends</span> <span class="title class_">RuntimeException</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CacheRuntimeException</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CacheRuntimeException</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CacheRuntimeException</span><span class="params">(String message, Throwable cause)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(message, cause);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CacheRuntimeException</span><span class="params">(Throwable cause)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(cause);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CacheRuntimeException</span><span class="params">(String message, Throwable cause, <span class="type">boolean</span> enableSuppression, <span class="type">boolean</span> writableStackTrace)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(message, cause, enableSuppression, writableStackTrace);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="cache">Cache</h3>
<p><strong>成员变量和构造方法</strong></p>
<p>cache类由上下文创建</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;K, V&gt; map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> sizeLimit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ICacheEvict&lt;K,V&gt; cacheEvict;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">Cache</span><span class="params">(ICacheContext&lt;K,V&gt; context)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.map = context.map();</span><br><span class="line">    <span class="built_in">this</span>.sizeLimit = context.sizeLimit();</span><br><span class="line">    cacheEvict = context.cahceEvict();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>成员变量从上下文中获取得到初始化</li>
<li>final：这些变量只能在context中修改，cache只能使用，不能更改引用</li>
</ul>
<p><strong>put方法</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">    <span class="comment">//1. 尝试淘汰内存,初始化一个CacheEvictContext</span></span><br><span class="line">    CacheEvictContext&lt;K, V&gt; context = <span class="keyword">new</span> <span class="title class_">CacheEvictContext</span>&lt;&gt;();</span><br><span class="line">    context.key(key).sizeLimit(sizeLimit).cache(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">    cacheEvict.evict(context);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. 淘汰后判断能否添加</span></span><br><span class="line">    <span class="keyword">if</span>(isSizeLimited())&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CacheRuntimeException</span>(<span class="string">&quot;当前缓存已满，数据添加失败！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> map.put(key, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isSizeLimited</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">curSize</span> <span class="operator">=</span> <span class="built_in">this</span>.size();<span class="comment">//加final防止并发</span></span><br><span class="line">    <span class="keyword">return</span> curSize &gt;= sizeLimit;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其它方法都是map封装好的，略</p>
<p><strong>获取当前缓存的元素个数</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span>: 当前缓存中存储元素的个数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> VLS</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/12/4 17:50</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">size</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> map.size();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="cachecontext">CacheContext</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: 缓存上下文信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> VLS</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/12/4 21:15</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheContext</span>&lt;K,V&gt; <span class="keyword">implements</span> <span class="title class_">ICacheContext</span>&lt;K,V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;K, V&gt; map;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> sizeLimit;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ICacheEvict&lt;K,V&gt; cacheEvict;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;K,V&gt; <span class="title function_">map</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> CacheContext&lt;K, V&gt; <span class="title function_">map</span><span class="params">(Map&lt;K, V&gt; map)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.map = map;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * 获取容器大小限制</span></span><br><span class="line"><span class="comment">    * @param</span></span><br><span class="line"><span class="comment">    * @return</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">sizeLimit</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sizeLimit;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> CacheContext&lt;K, V&gt; <span class="title function_">sizeLimit</span><span class="params">(<span class="type">int</span> sizeLimit)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sizeLimit = sizeLimit;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 淘汰策略</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ICacheEvict&lt;K,V&gt; <span class="title function_">cahceEvict</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> cacheEvict;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> CacheContext&lt;K, V&gt; <span class="title function_">cacheEvict</span><span class="params">(ICacheEvict&lt;K, V&gt; cacheEvict)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.cacheEvict = cacheEvict;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>流式编程：把成员变量的set抽象成单独的方法，返回值就是这个类的对象。
采用建造者模式，这样构建这个对象就会有流式体验</li>
</ul>
<h3 id="引导类">引导类</h3>
<p>位于guide包下，便于用户使用。</p>
<p>会给缓存中每一个变量赋初值，用户也可以自定义，采用建造者模式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: 指导类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> VLS</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/12/4 21:35</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">CacheGuide</span>&lt;K,V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//缓存变量, 真正创建map的地方</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;K,V&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">sizeLimit</span> <span class="operator">=</span> Integer.MAX_VALUE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ICacheEvict&lt;K,V&gt; cacheEvict = <span class="keyword">new</span> <span class="title class_">CacheEvictFIFO</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">CacheGuide</span><span class="params">()</span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 单例创建对象实例</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;K,V&gt; CacheGuide&lt;K,V&gt; <span class="title function_">newInstance</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CacheGuide</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 建造者模式，流式编程</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> CacheGuide&lt;K,V&gt; <span class="title function_">map</span><span class="params">(Map&lt;K,V&gt; map)</span>&#123;</span><br><span class="line">        ArgUtil.notNull(map, <span class="string">&quot;map&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.map = map;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> CacheGuide&lt;K,V&gt; <span class="title function_">sizeLimit</span><span class="params">(<span class="type">int</span> sizeLimit)</span>&#123;</span><br><span class="line">        ArgUtil.notNegative(sizeLimit, <span class="string">&quot;sizeLimit&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.sizeLimit = sizeLimit;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ICache&lt;K,V&gt; <span class="title function_">build</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//创建缓存上下文</span></span><br><span class="line">        CacheContext&lt;K, V&gt; context = <span class="keyword">new</span> <span class="title class_">CacheContext</span>&lt;&gt;();</span><br><span class="line">        context.map(map);</span><br><span class="line">        context.cacheEvict(cacheEvict);</span><br><span class="line">        context.sizeLimit(sizeLimit);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Cache</span>&lt;&gt;(context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="过期删除">过期删除</h1>
<h2 id="接口定义-1">接口定义</h2>
<p><strong>ICache接口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ICache</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">Map</span>&lt;K,V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    ICache&lt;K,V&gt; <span class="title function_">expire</span><span class="params">(K key, <span class="type">long</span> timeout, TimeUnit unit)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ICache&lt;K,V&gt; <span class="title function_">expireAt</span><span class="params">(K key, <span class="type">long</span> timeoutAt)</span>;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 获取缓存对应过期处理的策略类</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ICacheExpire&lt;K,V&gt; <span class="title function_">expire</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="icacheexpire">ICacheExpire</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ICacheExpire</span>&lt;K,V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 设置过期函数</span></span><br><span class="line"><span class="comment">     * @param expireAt: 在什么时候过期</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">expire</span><span class="params">(K key, <span class="type">long</span> expireAt)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 惰性删除策略</span></span><br><span class="line"><span class="comment">     * @param 需要处理的key集合</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">lazyRefresh</span><span class="params">(Collection&lt;K&gt; keys)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="基本缓存过期实现">基本缓存过期实现</h2>
<p>实现思路：利用定时任务，每一分钟、每一秒做一次轮询检查，<strong>开启额外线程</strong>执行。也需要把过期信息持久化，清理真正缓存中的数据</p>
<h3 id="cache-1">Cache</h3>
<p>实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 多少时间后过期</span></span><br><span class="line"><span class="comment"> * @param</span></span><br><span class="line"><span class="comment"> * @return</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ICache&lt;K, V&gt; <span class="title function_">expire</span><span class="params">(K key, <span class="type">long</span> timeout, TimeUnit unit)</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">mills</span> <span class="operator">=</span> unit.toMillis(timeout);</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="variable">timeoutAt</span> <span class="operator">=</span> System.currentTimeMillis() + mills;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.expireAt(key, timeoutAt);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ICache&lt;K, V&gt; <span class="title function_">expireAt</span><span class="params">(K key, <span class="type">long</span> timeoutAt)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.cacheExpire.expire(key, timeoutAt);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="过期信息存储">过期信息存储</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//存储设置了过期时间的缓存信息</span></span><br><span class="line">   <span class="keyword">private</span> Map&lt;K,Long&gt; expireMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">   </span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">expire</span><span class="params">(K key, <span class="type">long</span> expireAt)</span> &#123;</span><br><span class="line">       expireMap.put(key, expireAt);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="定期轮询清理清空缓存任务">定期轮询清理&amp;清空缓存任务</h3>
<p>利用JDK原生的<code>ScheduledExecutorService</code> 线程池来实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 初始化轮询任务</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line">        EXECUTOR_SERVICE.scheduleAtFixedRate(<span class="keyword">new</span> <span class="title class_">ExpireThread</span>(),<span class="number">100</span>, <span class="number">100</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">        CLEAN_LIMIT = <span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span>: 定义执行清理任务的单线程</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> VLS</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/12/5 16:07</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">ExpireThread</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(expireMap == <span class="literal">null</span> || expireMap.size() == <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (K key : expireMap.keySet()) &#123;</span><br><span class="line">                <span class="keyword">if</span>(count &gt;= CLEAN_LIMIT)&#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                cleanExpireKey(key);</span><br><span class="line">                count++;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">cleanExpireKey</span><span class="params">(K key)</span>&#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">expireAtMs</span> <span class="operator">=</span> expireMap.get(key);</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">currentTimeMillis</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(currentTimeMillis &gt;= expireAtMs)&#123;</span><br><span class="line">            log.debug(<span class="string">&quot;要清除的缓存key = &#123;&#125;&quot;</span>, key);</span><br><span class="line">            expireMap.remove(key);</span><br><span class="line">            cache.remove(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="排序的key-优化">排序的key-优化</h2>
<p>过期的应用场景不多，那么经常轮训的意义实际不大。比如我们的任务 99%
都是在凌晨清空数据，白天无论怎么轮询，纯粹是浪费资源。</p>
<p>相比于之前轮询访问每个缓存的key，比较耗时，我们需要快速判断需要处理的缓存才行</p>
<p>最直观的方法就是将key排序处理，将key升序排列放到容器中，过期时间相同的key放到同一列表中处理</p>
<h3 id="实现">实现</h3>
<p>实现：利用java中TreeMap实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheExpireSort</span>&lt;K,V&gt; <span class="keyword">implements</span> <span class="title class_">ICacheExpire</span>&lt;K,V&gt; &#123;</span><br><span class="line">    <span class="comment">//存储设置了过期时间的缓存信息</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Long, List&lt;K&gt;&gt; sortedExpireMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//便于获取key的过期时间</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;K, Long&gt; expireMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ICache&lt;K,V&gt; cache;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//每次清除的个数限制</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> CLEAN_LIMIT;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CacheExpireSort</span><span class="params">(ICache&lt;K,V&gt; cache)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sortedExpireMap = <span class="keyword">new</span> <span class="title class_">TreeMap</span>&lt;&gt;((o1, o2) -&gt; (<span class="type">int</span>)(o1 - o2));</span><br><span class="line">        <span class="built_in">this</span>.cache = cache;</span><br><span class="line">        <span class="built_in">this</span>.init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//单线程</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ScheduledExecutorService</span> <span class="variable">EXECUTOR_SERVICE</span> <span class="operator">=</span> Executors.newSingleThreadScheduledExecutor();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 初始化轮询任务</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line">        EXECUTOR_SERVICE.scheduleAtFixedRate(<span class="keyword">new</span> <span class="title class_">ExpireThread</span>(),<span class="number">1</span>, <span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">        CLEAN_LIMIT = <span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span>: 定义执行清理任务的单线程</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> VLS</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/12/5 16:07</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">ExpireThread</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(sortedExpireMap == <span class="literal">null</span> || sortedExpireMap.size() == <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;Long, List&lt;K&gt;&gt; entry : sortedExpireMap.entrySet()) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">Long</span> <span class="variable">expireAt</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">                List&lt;K&gt; keys = entry.getValue();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(CollectionUtil.isEmpty(keys))&#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(count &gt; CLEAN_LIMIT)&#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">long</span> <span class="variable">currentTimeMillis</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(currentTimeMillis &gt;= expireAt)&#123;</span><br><span class="line">                    Iterator&lt;K&gt; keysIterator = keys.iterator();</span><br><span class="line">                    <span class="keyword">while</span> (keysIterator.hasNext())&#123;</span><br><span class="line">                        <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> keysIterator.next();</span><br><span class="line">                        log.debug(<span class="string">&quot;删除的缓存key为&#123;&#125;&quot;</span>, key);</span><br><span class="line">                        keysIterator.remove();</span><br><span class="line">                        expireMap.remove(key);</span><br><span class="line"></span><br><span class="line">                        cache.remove(key);</span><br><span class="line">                        count++;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//剪枝操作，因为是有序遍历，当遍历到过期时间在未来的集合，直接返回，因为下面的过期时间只会更久远</span></span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">expire</span><span class="params">(K key, <span class="type">long</span> expireAt)</span> &#123;</span><br><span class="line">        List&lt;K&gt; keys = sortedExpireMap.get(expireAt);</span><br><span class="line">        <span class="keyword">if</span>(keys == <span class="literal">null</span>)&#123;</span><br><span class="line">            keys = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        keys.add(key);</span><br><span class="line">        sortedExpireMap.put(expireAt, keys);</span><br><span class="line">        expireMap.put(key, expireAt);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lazyRefresh</span><span class="params">(Collection&lt;K&gt; keys)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">expireTime</span><span class="params">(K key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> expireMap.get(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>缺陷：</p>
<ol type="1">
<li>遍历的大部分key是无效的遍历，比较耗费时间</li>
<li>key的选择不是随机的</li>
</ol>
<h2 id="惰性删除策略">惰性删除策略</h2>
<p>使用原因：</p>
<ol type="1">
<li>CPU友好，不会占用CPU资源</li>
<li>数据一致性比较好</li>
</ol>
<p>思路：不主动删除过期键，每次从数据库访问 key 时，都检测 key
是否过期，如果过期则删除该 key。</p>
<ul>
<li>也就是说要在get方法处添加</li>
</ul>
<p>惰性删除实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lazyRefresh</span><span class="params">(Collection&lt;K&gt; keys)</span> &#123;</span><br><span class="line">    <span class="comment">//要清理两个集合，一个是传入的key，另一个是当前expireMap</span></span><br><span class="line">    <span class="keyword">if</span>(CollectionUtil.isEmpty(keys))&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(keys.size() &lt;= expireMap.size())&#123;</span><br><span class="line">        <span class="keyword">for</span> (K key : keys) &#123;</span><br><span class="line">            cleanExpireKey(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (K key : expireMap.keySet()) &#123;</span><br><span class="line">            cleanExpireKey(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>惰性删除应用</p>
<p>Cache类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> V <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="type">K</span> <span class="variable">genericKey</span> <span class="operator">=</span> (K) key;</span><br><span class="line">    <span class="built_in">this</span>.cacheExpire.lazyRefresh( Collections.singletonList(genericKey));</span><br><span class="line">    <span class="keyword">return</span> map.get(key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Set&lt;K&gt; <span class="title function_">keySet</span><span class="params">()</span> &#123;</span><br><span class="line">    refreshExpireAllKeys();</span><br><span class="line">    <span class="keyword">return</span> map.keySet();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Collection&lt;V&gt; <span class="title function_">values</span><span class="params">()</span> &#123;</span><br><span class="line">    refreshExpireAllKeys();</span><br><span class="line">    <span class="keyword">return</span> map.values();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Set&lt;Entry&lt;K, V&gt;&gt; <span class="title function_">entrySet</span><span class="params">()</span> &#123;</span><br><span class="line">    refreshExpireAllKeys();</span><br><span class="line">    <span class="keyword">return</span> map.entrySet();</span><br><span class="line">&#125;</span><br><span class="line">。。。</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="随机删除策略">随机删除策略</h2>
<p>Redis内部维护一个定时任务，默认每秒运行10次（通过配置hz控制）。</p>
<p>定时任务中删除过期键逻辑采用了自适应算法，根据<strong>键的过期比例</strong>、使用<strong>快慢两种速率</strong>模式回收键，流程如下所示。</p>
<figure>
<img src="渐进式redis缓存工具Vedis/640.png" alt="redis过期策略流程" />
<figcaption aria-hidden="true">redis过期策略流程</figcaption>
</figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheExpireRandom</span>&lt;K,V&gt; <span class="keyword">implements</span> <span class="title class_">ICacheExpire</span>&lt;K,V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">COUNT_LIMIT</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">    <span class="comment">//是否启用快模式</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">fastMode</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;K, Long&gt; expireMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ICache&lt;K,V&gt; cache;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CacheExpireRandom</span><span class="params">(ICache&lt;K, V&gt; cache)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.cache = cache;</span><br><span class="line">        <span class="built_in">this</span>.init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ScheduledExecutorService</span> <span class="variable">EXECUTOR_SERVICE</span> <span class="operator">=</span> Executors.newSingleThreadScheduledExecutor();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        EXECUTOR_SERVICE.scheduleAtFixedRate(<span class="keyword">new</span> <span class="title class_">ExpireRandomThread</span>(), <span class="number">10</span>, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">ExpireRandomThread</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(MapUtil.isEmpty(expireMap)) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;expireMap 信息为空，直接跳过本次处理。&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(fastMode) &#123;</span><br><span class="line">                expireKeys(<span class="number">10L</span>);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            expireKeys(<span class="number">100L</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">expireKeys</span><span class="params">(<span class="type">long</span> timeMills)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">timeLimit</span> <span class="operator">=</span> timeMills + System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.fastMode = <span class="literal">false</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(count &gt;= COUNT_LIMIT) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;过期淘汰次数已经达到最大次数: &#123;&#125;，完成本次执行。&quot;</span>, COUNT_LIMIT);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(System.currentTimeMillis() &gt;= timeLimit) &#123;</span><br><span class="line">                fastMode = <span class="literal">true</span>;</span><br><span class="line">                log.debug(<span class="string">&quot;过期淘汰已经达到限制时间，中断本次执行，设置 fastMode=true&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> getRandomKeyWithList();</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isCleaned</span> <span class="operator">=</span> cleanExpireKey(key);</span><br><span class="line">            log.debug(<span class="string">&quot;key: &#123;&#125; 过期执行结果 &#123;&#125;&quot;</span>, key, isCleaned);</span><br><span class="line">            count++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> K <span class="title function_">getRandomKeyWithList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> ThreadLocalRandom.current();</span><br><span class="line">        ArrayList&lt;K&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(expireMap.keySet());</span><br><span class="line">        <span class="type">int</span> <span class="variable">randomIdx</span> <span class="operator">=</span> random.nextInt(list.size());</span><br><span class="line">        <span class="keyword">return</span> list.get(randomIdx);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> K <span class="title function_">getRandomKeyWithIterator</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> ThreadLocalRandom.current();</span><br><span class="line">        <span class="type">int</span> <span class="variable">randomIdx</span> <span class="operator">=</span> random.nextInt(expireMap.size());</span><br><span class="line">        Iterator&lt;K&gt; iterator = expireMap.keySet().iterator();</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(iterator.hasNext()) &#123;</span><br><span class="line">            <span class="keyword">if</span>(count == randomIdx) &#123;</span><br><span class="line">                <span class="keyword">return</span> iterator.next();</span><br><span class="line">            &#125;</span><br><span class="line">            count++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CacheRuntimeException</span>(<span class="string">&quot;Random 获取对应key: [error] 信息不存在&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">BATCH_RANDOM_KEY_SIZE_LIMIT</span> <span class="operator">=</span> <span class="number">50</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Set&lt;K&gt; <span class="title function_">getRandomKeyBatch</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> ThreadLocalRandom.current();</span><br><span class="line">        <span class="type">int</span> <span class="variable">randomIdx</span> <span class="operator">=</span> random.nextInt(expireMap.size());</span><br><span class="line">        Iterator&lt;K&gt; iterator = expireMap.keySet().iterator();</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        Set&lt;K&gt; keySet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//一次性最多取50个数据</span></span><br><span class="line">        <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">            <span class="keyword">if</span>(keySet.size() &gt;= BATCH_RANDOM_KEY_SIZE_LIMIT) &#123;</span><br><span class="line">                <span class="keyword">return</span> keySet;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">K</span> <span class="variable">curKey</span> <span class="operator">=</span> iterator.next();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(count &gt; randomIdx - <span class="number">50</span> &amp;&amp; count &lt;= randomIdx + <span class="number">50</span>) &#123;</span><br><span class="line">                keySet.add(curKey);</span><br><span class="line">            &#125;</span><br><span class="line">            count++;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> keySet;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * @param expireAt:设置的过期时间</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">cleanExpireKey</span><span class="params">(K key)</span>&#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">expireAtMs</span> <span class="operator">=</span> expireMap.get(key);</span><br><span class="line">        <span class="type">long</span> <span class="variable">currentTimeMillis</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(currentTimeMillis &gt;= expireAtMs)&#123;</span><br><span class="line">                expireMap.remove(key);</span><br><span class="line">                <span class="type">V</span> <span class="variable">removeValue</span> <span class="operator">=</span> cache.remove(key);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//过期监听器</span></span><br><span class="line">                CacheRemoveListenerContext&lt;K, V&gt; cacheRemoveListenerContext = CacheRemoveListenerContext.&lt;K, V&gt;newInstance()</span><br><span class="line">                        .setKey(key)</span><br><span class="line">                        .setValue(removeValue)</span><br><span class="line">                        .setType(CacheRemoveType.EXPIRE.getCode());</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (ICacheRemoveListener&lt;K, V&gt; removeListener : cache.removeListeners()) &#123;</span><br><span class="line">                    removeListener.listen(cacheRemoveListenerContext);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>,e);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">expire</span><span class="params">(K key, <span class="type">long</span> expireAt)</span> &#123;</span><br><span class="line">        expireMap.put(key, expireAt);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lazyRefresh</span><span class="params">(Collection&lt;K&gt; keyList)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(CollectionUtil.isEmpty(keyList)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断大小，小的作为外循环。一般都是过期的 keys 比较小。</span></span><br><span class="line">        <span class="keyword">if</span>(keyList.size() &lt;= expireMap.size()) &#123;</span><br><span class="line">            <span class="keyword">for</span>(K key : keyList) &#123;</span><br><span class="line">                cleanExpireKey(key);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span>(Map.Entry&lt;K, Long&gt; entry : expireMap.entrySet()) &#123;</span><br><span class="line">                cleanExpireKey(entry.getKey());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">expireTime</span><span class="params">(K key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> expireMap.get(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="持久化">持久化</h1>
<h2 id="rdb">RDB</h2>
<h3 id="接口定义-2">接口定义</h3>
<p><strong>ICache接口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ICacheLoad&lt;K,V&gt; <span class="title function_">load</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">ICachePersist&lt;K,V&gt; <span class="title function_">persist</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>
<h4 id="加载接口">加载接口</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ICacheLoad</span>&lt;K, V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 加载上次关机前的缓存信息</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">load</span><span class="params">(ICache&lt;K,V&gt; cache)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="持久化接口">持久化接口</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: 持久化策略接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> VLS</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/12/5 20:39</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ICachePersist</span>&lt;K,V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">persist</span><span class="params">(ICache&lt;K, V&gt; cache)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="策略工具类">策略工具类</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="json字符串形式持久化">JSON字符串形式持久化</h3>
<h4
id="持久化实现类cachepersistfilejson">持久化实现类CachePersistFileJson</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: JSON形式 RDB持久化</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> VLS</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/12/5 20:49</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CachePersistFileJson</span>&lt;K,V&gt; <span class="keyword">implements</span> <span class="title class_">ICachePersist</span>&lt;K,V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String filePath;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CachePersistFileJson</span><span class="params">(String filePath)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.filePath = filePath;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">persist</span><span class="params">(ICache&lt;K, V&gt; cache)</span> &#123;</span><br><span class="line">        Set&lt;Map.Entry&lt;K, V&gt;&gt; entries = cache.entrySet();</span><br><span class="line"></span><br><span class="line">        FileUtil.createFile(filePath);</span><br><span class="line">        <span class="comment">//清空文件内容</span></span><br><span class="line">        truncateFile(filePath);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;K, V&gt; entry : entries) &#123;</span><br><span class="line">            <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">            <span class="type">Long</span> <span class="variable">expireTime</span> <span class="operator">=</span> cache.expire().expireTime(key);</span><br><span class="line">            PersistRdbEntry&lt;K,V&gt; rdbEntry = <span class="keyword">new</span> <span class="title class_">PersistRdbEntry</span>&lt;&gt;();</span><br><span class="line">            rdbEntry.setKey(key);</span><br><span class="line">            rdbEntry.setValue(entry.getValue());</span><br><span class="line">            rdbEntry.setExpire(expireTime);</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">line</span> <span class="operator">=</span> JSON.toJSONString(rdbEntry);</span><br><span class="line">            FileUtil.write(filePath, line, StandardOpenOption.APPEND);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">truncateFile</span><span class="params">(String filePath)</span>&#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span>  <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(filePath);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">FileWriter</span> <span class="variable">fileWriter</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">FileWriter</span>(file);</span><br><span class="line">            fileWriter.write(<span class="string">&quot;&quot;</span>);</span><br><span class="line">            fileWriter.flush();</span><br><span class="line">            fileWriter.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="加载实现类cacheloadfilejson">加载实现类CacheLoadFileJson</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: JSON持久化加载实现</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> VLS</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/12/5 21:47</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheLoadFileJson</span>&lt;K,V&gt; <span class="keyword">implements</span> <span class="title class_">ICacheLoad</span>&lt;K,V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String filePath;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CacheLoadFileJson</span><span class="params">(String filePath)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.filePath = filePath;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">load</span><span class="params">(ICache&lt;K, V&gt; cache)</span> &#123;</span><br><span class="line">        List&lt;String&gt; lines = FileUtil.readAllLines(filePath);</span><br><span class="line">        log.debug(<span class="string">&quot;[load] 开始加载处理 path: &#123;&#125;&quot;</span>, filePath);</span><br><span class="line">        <span class="keyword">if</span>(CollectionUtil.isEmpty(lines)) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;[load] path: &#123;&#125; 文件内容为空，直接返回&quot;</span>, filePath);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (String line : lines) &#123;</span><br><span class="line">            <span class="keyword">if</span>(StringUtil.isEmpty(line))&#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            PersistRdbEntry&lt;K,V&gt; rdbEntry = JSONObject.parseObject(line, PersistRdbEntry.class);</span><br><span class="line">            <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> rdbEntry.getKey();</span><br><span class="line">            <span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> rdbEntry.getValue();</span><br><span class="line">            <span class="type">Long</span> <span class="variable">expire</span> <span class="operator">=</span> rdbEntry.getExpire();</span><br><span class="line"></span><br><span class="line">            cache.put(key, value);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(expire != <span class="literal">null</span>)&#123;</span><br><span class="line">                cache.expireAt(key, expire);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="定时rdb持久化任务实现">定时RDB持久化任务实现</h3>
<h4 id="innercachepersist">InnerCachePersist</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: 定时执行持久化策略</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> VLS</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/12/5 21:35</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InnerCachePersist</span>&lt;K,V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ICache&lt;K,V&gt; cache;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ICachePersist&lt;K,V&gt; cachePersist;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">InnerCachePersist</span><span class="params">(ICache&lt;K, V&gt; cache, ICachePersist&lt;K, V&gt; cachePersist)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.cache = cache;</span><br><span class="line">        <span class="built_in">this</span>.cachePersist = cachePersist;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//单线程</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ScheduledExecutorService</span> <span class="variable">EXECUTOR_SERVICE</span> <span class="operator">=</span> Executors.newSingleThreadScheduledExecutor();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 初始化轮询任务</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line">        EXECUTOR_SERVICE.scheduleAtFixedRate(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="type">SimpleDateFormat</span> <span class="variable">formatter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;开始持久化......  time : &#123;&#125;&quot;</span>, formatter.format(System.currentTimeMillis()));</span><br><span class="line">                cachePersist.persist(cache);</span><br><span class="line">                log.debug(<span class="string">&quot;完成持久化......  time : &#123;&#125;&quot;</span>, formatter.format(System.currentTimeMillis()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">0</span>, <span class="number">1</span>, TimeUnit.MINUTES);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="aof">AOF</h2>
<p>AOF是redis典型的持久化策略，将<strong>写命令</strong>，追加到aof文件内，这样下次重启redis，会加载这些命令初始化缓存容器。</p>
<p>具体思路：拦截器拦截方法执行，将调用的方法转化成json字符串，把字符串缓存到buffer中，随后根据设置的刷盘时间，把aof刷到磁盘中。</p>
<h3 id="注解定义">注解定义</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="meta">@Retention(value = RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> CacheInterceptor &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 是否开启aof持久化模式</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">aof</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在cache类的expireAt、put、remove等写方法上加入注解，并指定使用aof</p>
<h3 id="持久化aofentry定义">持久化aofEntry定义</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PersistAofEntry</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String methodName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object[] params;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">PersistAofEntry</span><span class="params">(String methodName, Object[] params)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.methodName = methodName;</span><br><span class="line">        <span class="built_in">this</span>.params = params;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> PersistAofEntry <span class="title function_">of</span><span class="params">(String methodName, Object[] params)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PersistAofEntry</span>(methodName, params);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="持久化拦截器">持久化拦截器</h3>
<p>专门服务于aof的拦截器</p>
<p>目的：当cache中定义的持久化方式是aof时，会把操作的信息放入到
CachePersistAof 的 buffer 列表中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheInterceptorAof</span>&lt;K,V&gt; <span class="keyword">implements</span> <span class="title class_">ICacheInterceptor</span>&lt;K,V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">(ICacheInterceptorContext&lt;K, V&gt; context)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">after</span><span class="params">(ICacheInterceptorContext&lt;K, V&gt; context)</span> &#123;</span><br><span class="line">        ICache&lt;K, V&gt; cache = context.cache();</span><br><span class="line">        ICachePersist&lt;K, V&gt; persist = cache.persist();</span><br><span class="line">        <span class="comment">//判断持久化策略</span></span><br><span class="line">        <span class="keyword">if</span>(persist <span class="keyword">instanceof</span> CachePersistAof)&#123;</span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> context.method();</span><br><span class="line">            Object[] params = context.params();</span><br><span class="line"></span><br><span class="line">            <span class="type">PersistAofEntry</span> <span class="variable">aofEntry</span> <span class="operator">=</span> PersistAofEntry.of(method.getName(), params);</span><br><span class="line">            <span class="type">String</span> <span class="variable">aofEntryJSON</span> <span class="operator">=</span> JSON.toJSONString(aofEntry);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//先添加到buffer</span></span><br><span class="line">            <span class="type">CachePersistAof</span> <span class="variable">cachePersistAof</span> <span class="operator">=</span> (CachePersistAof) persist;</span><br><span class="line"></span><br><span class="line">            log.debug(<span class="string">&quot;AOF 开始追加文件内容：&#123;&#125;&quot;</span>, aofEntryJSON);</span><br><span class="line">            cachePersistAof.appendBuffer(aofEntryJSON);</span><br><span class="line">            log.debug(<span class="string">&quot;AOF 完成追加文件内容：&#123;&#125;&quot;</span>, aofEntryJSON);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="实现aof">实现AOF</h3>
<h4 id="接口">接口</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ICachePersist</span>&lt;K,V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">persist</span><span class="params">(ICache&lt;K, V&gt; cache)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//aof + rdb 共同工作   需要以下参数</span></span><br><span class="line">    <span class="type">long</span> <span class="title function_">delay</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="title function_">period</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    TimeUnit <span class="title function_">timeUnit</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="实现-1">实现</h4>
<p><strong>CachePersistAof</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CachePersistAof</span>&lt;K,V&gt; <span class="keyword">implements</span> <span class="title class_">ICachePersist</span>&lt;K,V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String filePath;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;String&gt; bufferList;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CachePersistAof</span><span class="params">(String filePath)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.filePath = filePath;</span><br><span class="line">        bufferList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">persist</span><span class="params">(ICache&lt;K, V&gt; cache)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;开始 AOF 持久化到文件&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!FileUtils.exists(filePath))&#123;</span><br><span class="line">            FileUtils.createFile(filePath);</span><br><span class="line">        &#125;</span><br><span class="line">        FileUtils.append(filePath, bufferList);</span><br><span class="line"></span><br><span class="line">        bufferList.clear();</span><br><span class="line">        log.info(<span class="string">&quot;完成 AOF 持久化到文件&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">delay</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">period</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> TimeUnit <span class="title function_">timeUnit</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> TimeUnit.SECONDS;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="加载的实现">加载的实现</h3>
<p>思路：通过遍历cache类的全部方法，得到每一个方法，然后获得每一个方法的annotation也就是注解，然后判断这个注解的aof属性是否为true，把为true的method都添加到map里，然后读取aof文件，把文件的json字符串转化为aofEntry，然后通过entry的method名，调用map的get，获得方法本体，然后通过反射调用，达到初始化map。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheLoadAof</span>&lt;K,V&gt; <span class="keyword">implements</span> <span class="title class_">ICacheLoad</span>&lt;K,V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String filePath;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CacheLoadAof</span><span class="params">(String filePath)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.filePath = filePath;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, Method&gt; METHOD_MAP ;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化METHOD_MAP,这里是统计添加了CacheInterceptor拦截器的全部方法</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        METHOD_MAP = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Method[] methods = Cache.class.getMethods();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">            <span class="type">CacheInterceptor</span> <span class="variable">cacheInterceptor</span> <span class="operator">=</span> method.getAnnotation(CacheInterceptor.class);</span><br><span class="line">            <span class="keyword">if</span>(cacheInterceptor != <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(cacheInterceptor.aof())&#123;</span><br><span class="line">                    METHOD_MAP.put(method.getName(), method);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">load</span><span class="params">(ICache&lt;K, V&gt; cache)</span> &#123;</span><br><span class="line">        List&lt;String&gt; lines = FileUtil.readAllLines(filePath);</span><br><span class="line">        log.debug(<span class="string">&quot;[load] 开始加载处理 path: &#123;&#125;&quot;</span>, filePath);</span><br><span class="line">        <span class="keyword">if</span>(CollectionUtil.isEmpty(lines)) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;[load] path: &#123;&#125; 文件内容为空，直接返回&quot;</span>, filePath);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (String line : lines) &#123;</span><br><span class="line">            <span class="keyword">if</span>(StringUtil.isEmpty(line))&#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">PersistAofEntry</span> <span class="variable">aofEntry</span> <span class="operator">=</span> JSON.parseObject(line, PersistAofEntry.class);</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> aofEntry.getMethodName();</span><br><span class="line">            Object[] params = aofEntry.getParams();</span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> METHOD_MAP.get(methodName);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                method.invoke(cache, params);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException| InvocationTargetException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="淘汰策略">淘汰策略</h1>
<p>采用<strong>策略模式</strong>，策略类的顶层接口是<code>ICacheEvict</code>，核心方法是<code>void evict(ICacheEvictContext&lt;K,V&gt; context);</code></p>
<p>以下是具体的实现类，context是<code>ICacheEvictContext</code>，内部含有缓存基础信息，包括新添加的key，专门服务于<code>CacheEvic</code>接口，负责运行时选择具体的策略。同时也减少了<code>CacheContext</code>的职责。</p>
<h2 id="接口定义-3">接口定义</h2>
<h3 id="icacheevict">ICacheEvict</h3>
<p>ICacheEvict：内存驱逐/淘汰策略</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> VLS</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/12/4 17:37</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ICacheEvict</span>&lt;K,V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 定义  驱逐淘汰方法</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ICacheEntry&lt;K,V&gt; <span class="title function_">evict</span><span class="params">(ICacheEvictContext&lt;K,V&gt; context)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 服务于lru，将key添加到链表头</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">updateKey</span><span class="params">(K key)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 服务于lru，将key移除</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">removeKey</span><span class="params">(K key)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="icacheevictcontext">ICacheEvictContext</h3>
<p>ICacheEvictContext：内存驱逐/淘汰策略 上下文</p>
<p>功能：负责<strong>传递缓存上下文</strong>以及新元素key的作用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> VLS</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/12/4 17:41</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ICacheEvictContext</span>&lt;K,V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新加的 key，为具体缓存策略提供key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    K <span class="title function_">key</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * cache 实现</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> map</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ICache&lt;K, V&gt; <span class="title function_">cache</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取大小限制</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 大小</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">sizeLimit</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="抽象策略类">抽象策略类</h3>
<p>应用到<strong>模板方法模式</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractCacheEvict</span>&lt;K,V&gt; <span class="keyword">implements</span> <span class="title class_">ICacheEvict</span>&lt;K,V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ICacheEntry&lt;K, V&gt; <span class="title function_">evict</span><span class="params">(ICacheEvictContext&lt;K, V&gt; context)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> dpEvict(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> ICacheEntry&lt;K,V&gt; <span class="title function_">dpEvict</span><span class="params">(ICacheEvictContext&lt;K, V&gt; context)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateKey</span><span class="params">(K key)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeKey</span><span class="params">(K key)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样以后的策略只需专注实现dpEvict方法即可</p>
<h2 id="策略工具类-1">策略工具类</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: 策略工具类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> VLS</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/12/4 21:27</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">CacheEvicts</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">CacheEvicts</span><span class="params">()</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 无策略</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return  具体策略实现类CacheEvict</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;K,V&gt; ICacheEvict&lt;K,V&gt; <span class="title function_">none</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CacheEvictNone</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 无策略</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return  具体策略实现类CacheEvict</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;K,V&gt; ICacheEvict&lt;K,V&gt; <span class="title function_">fifo</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CacheEvictFIFO</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="具体实现">具体实现</h2>
<h3 id="cacheevictcontext">CacheEvictContext</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheEvictContext</span>&lt;K,V&gt; <span class="keyword">implements</span> <span class="title class_">ICacheEvictContext</span>&lt;K,V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> K key;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ICache&lt;K,V&gt; cache;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> sizeLimit;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新加的 key</span></span><br><span class="line"><span class="comment">     *  后跟set方法，返回值保证流式编程</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> K <span class="title function_">key</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> CacheEvictContext&lt;K, V&gt; <span class="title function_">key</span><span class="params">(K key)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.key = key;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * cache 实现</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> map</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ICache&lt;K, V&gt; <span class="title function_">cache</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> cache;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> CacheEvictContext&lt;K, V&gt; <span class="title function_">cache</span><span class="params">(ICache&lt;K, V&gt; cache)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.cache = cache;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取大小</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 大小</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">sizeLimit</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sizeLimit;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> CacheEvictContext&lt;K, V&gt; <span class="title function_">sizeLimit</span><span class="params">(<span class="type">int</span> sizeLimit)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sizeLimit = sizeLimit;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="无策略">无策略</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: 无淘汰策略</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> VLS</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/12/4 20:47</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheEvictNone</span> <span class="keyword">implements</span> <span class="title class_">ICacheEvict</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">evict</span><span class="params">(ICacheEvictContext context)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>采用模板方法模式，引入抽象策略类以后</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheEvictNone</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">AbstractCacheEvict</span>&lt;K,V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> ICacheEntry&lt;K, V&gt; <span class="title function_">dpEvict</span><span class="params">(ICacheEvictContext&lt;K, V&gt; context)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="fifo">FIFO</h3>
<p>先进先出的思想，具体采用链表实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: FIFO淘汰策略</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> VLS</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/12/4 20:57</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheEvictFIFO</span>&lt;K,V&gt; <span class="keyword">implements</span> <span class="title class_">ICacheEvict</span>&lt;K,V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Queue&lt;K&gt; queue;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CacheEvictFIFO</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.queue = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">evict</span><span class="params">(ICacheEvictContext&lt;K, V&gt; context)</span> &#123;</span><br><span class="line">        ICache&lt;K, V&gt; cache = context.cache();</span><br><span class="line">        <span class="keyword">if</span>(cache.size() &gt;= context.sizeLimit())&#123;</span><br><span class="line">            <span class="type">K</span> <span class="variable">removeKey</span> <span class="operator">=</span> queue.remove();</span><br><span class="line">            cache.remove(removeKey);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//这种final可加可不加，这是提高可读性的一种方式</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> context.key();</span><br><span class="line">        queue.add(key);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>采用模板方法模式，引入抽象策略类以后</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> ICacheEntry&lt;K, V&gt; <span class="title function_">dpEvict</span><span class="params">(ICacheEvictContext&lt;K, V&gt; context)</span> &#123;</span><br><span class="line">    ICache&lt;K, V&gt; cache = context.cache();</span><br><span class="line">    ICacheEntry&lt;K,V&gt; result = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span>(cache.size() &gt;= context.sizeLimit())&#123;</span><br><span class="line">        <span class="type">K</span> <span class="variable">removeKey</span> <span class="operator">=</span> queue.remove();</span><br><span class="line">        <span class="type">V</span> <span class="variable">removeValue</span> <span class="operator">=</span> cache.remove(removeKey);</span><br><span class="line">        result = <span class="keyword">new</span> <span class="title class_">CacheEntry</span>&lt;&gt;(removeKey, removeValue);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//这种final可加可不加，这是提高可读性的一种方式</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> context.key();</span><br><span class="line">    queue.add(key);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="朴素lru">朴素LRU</h3>
<p>连续性准则：</p>
<ul>
<li>时间连续性：对于信息的访问，最近被访问过，被再次访问的可能性会很高。缓存就是基于这个理念进行数据淘汰的。</li>
<li>空间连续性：对于磁盘信息的访问，将很有可能访问连续的空间信息。所以会有
page 预取来提升性能。</li>
</ul>
<p>实现思路：创建一个链表实现</p>
<ol type="1">
<li>新数据放到链表头部</li>
<li>缓存命中的时候，将对应的数据移动到头部
<ul>
<li>命中缓存，删除这个缓存，再添加到头部</li>
</ul></li>
<li>链表满的时候，从尾部淘汰数据</li>
</ol>
<p>具体实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheEvictLRU</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">AbstractCacheEvict</span>&lt;K,V&gt;&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;K&gt; list = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> ICacheEntry&lt;K, V&gt; <span class="title function_">dpEvict</span><span class="params">(ICacheEvictContext&lt;K, V&gt; context)</span> &#123;</span><br><span class="line">        ICache&lt;K, V&gt; cache = context.cache();</span><br><span class="line">        <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> context.key();</span><br><span class="line">        <span class="type">int</span> <span class="variable">sizeLimit</span> <span class="operator">=</span> context.sizeLimit();</span><br><span class="line">        ICacheEntry&lt;K, V&gt; removeEntry = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(cache.size() &gt;= sizeLimit)&#123;</span><br><span class="line">            <span class="comment">//获取最后一个结点的key</span></span><br><span class="line">            <span class="type">K</span> <span class="variable">removeKey</span> <span class="operator">=</span> list.get(list.size() - <span class="number">1</span>);</span><br><span class="line">            <span class="type">V</span> <span class="variable">removeValue</span> <span class="operator">=</span> cache.remove(removeKey);</span><br><span class="line">             removeEntry = CacheEntry.of(removeKey, removeValue);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> removeEntry;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeKey</span><span class="params">(K key)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.list.remove(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateKey</span><span class="params">(K key)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.list.remove(key);</span><br><span class="line">        <span class="comment">//头插</span></span><br><span class="line">        <span class="built_in">this</span>.list.add(<span class="number">0</span>,key);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>新添加的方法具体在哪使用，如下：</p>
<p>注解添加：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">evict</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>
<p>在<strong>containsKey</strong>、<strong>get</strong>、<strong>put</strong>、<strong>remove</strong>方法上使用</p>
<h4 id="驱逐拦截器的实现">驱逐拦截器的实现</h4>
<p>放在方法之后更新，不然每次当前操作的 key 都会被放在最前面。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheInterceptorEvict</span>&lt;K,V&gt; <span class="keyword">implements</span> <span class="title class_">ICacheInterceptor</span>&lt;K,V&gt; &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">(ICacheInterceptorContext&lt;K, V&gt; context)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 额外配置lru功能</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">after</span><span class="params">(ICacheInterceptorContext&lt;K, V&gt; context)</span> &#123;</span><br><span class="line">        ICache&lt;K, V&gt; cache = context.cache();</span><br><span class="line">        ICacheEvict&lt;K, V&gt; evict = cache.evict();</span><br><span class="line"></span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> context.method();</span><br><span class="line">        Object[] params = context.params();</span><br><span class="line">        <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> (K)params[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;remove&quot;</span>.equals(method.getName()))&#123;</span><br><span class="line">            evict.removeKey(key);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            evict.updateKey(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>驱逐拦截器投入使用：</p>
<ol type="1">
<li>CacheInterceptors定义获取方法evict()</li>
<li>核心代理类CacheProxyGuide定义成员变量，并且在interceptorHandler增强方法中投入使用</li>
</ol>
<h3 id="双向链表-哈希表lru优化">双向链表 + 哈希表LRU优化</h3>
<p>我们的目标是要把淘汰算法的搜索时间复杂度将下去，降为O(1)。</p>
<h4 id="接口定义-4">接口定义</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ILruMap</span>&lt;K,V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    ICacheEntry&lt;K,V&gt; <span class="title function_">removeOldest</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">updateKey</span><span class="params">(K key)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">removeKey</span><span class="params">(K key)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">containsKey</span><span class="params">(K key)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isEmpty</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="实现-2">实现</h4>
<p>双向链表的结点定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DoubleListNode</span>&lt;K,V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> K key;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> V value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DoubleListNode&lt;K,V&gt; pre;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DoubleListNode&lt;K,V&gt; next;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> K <span class="title function_">key</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DoubleListNode</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> DoubleListNode&lt;K, V&gt; <span class="title function_">key</span><span class="params">(K key)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.key = key;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> V <span class="title function_">value</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> DoubleListNode&lt;K, V&gt; <span class="title function_">value</span><span class="params">(V value)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.value = value;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> DoubleListNode&lt;K, V&gt; <span class="title function_">pre</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> pre;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> DoubleListNode&lt;K, V&gt; <span class="title function_">pre</span><span class="params">(DoubleListNode&lt;K, V&gt; pre)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.pre = pre;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> DoubleListNode&lt;K, V&gt; <span class="title function_">next</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> DoubleListNode&lt;K, V&gt; <span class="title function_">next</span><span class="params">(DoubleListNode&lt;K, V&gt; next)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.next = next;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>双向链表数据结构实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LruMapDoubleList</span>&lt;K,V&gt; <span class="keyword">implements</span> <span class="title class_">ILruMap</span>&lt;K,V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DoubleListNode&lt;K,V&gt; head;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DoubleListNode&lt;K,V&gt; tail;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;K, DoubleListNode&lt;K,V&gt;&gt; map;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LruMapDoubleList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.head = <span class="keyword">new</span> <span class="title class_">DoubleListNode</span>&lt;&gt;();</span><br><span class="line">        <span class="built_in">this</span>.tail = <span class="keyword">new</span> <span class="title class_">DoubleListNode</span>&lt;&gt;();</span><br><span class="line">        <span class="built_in">this</span>.map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.head.next(<span class="built_in">this</span>.tail);</span><br><span class="line">        <span class="built_in">this</span>.tail.pre(<span class="built_in">this</span>.head);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ICacheEntry&lt;K, V&gt; <span class="title function_">removeOldest</span><span class="params">()</span> &#123;</span><br><span class="line">        DoubleListNode&lt;K, V&gt; tailPre = <span class="built_in">this</span>.tail.pre();</span><br><span class="line">        <span class="keyword">if</span>(tailPre == <span class="built_in">this</span>.head)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CacheRuntimeException</span>(<span class="string">&quot;链表中无结点，头结点无法删除!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        ICacheEntry&lt;K, V&gt; entry = CacheEntry.&lt;K, V&gt;of(tailPre.key(), tailPre.value());</span><br><span class="line">        removeKey(tailPre.key());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> entry;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateKey</span><span class="params">(K key)</span> &#123;</span><br><span class="line">        DoubleListNode&lt;K, V&gt; updateNode = map.get(key);</span><br><span class="line">        <span class="keyword">if</span>(ObjectUtils.isNull(updateNode)) &#123;</span><br><span class="line">            updateNode = <span class="keyword">new</span> <span class="title class_">DoubleListNode</span>&lt;&gt;();</span><br><span class="line">            updateNode.key(key);</span><br><span class="line">        &#125;</span><br><span class="line">        removeKey(key);</span><br><span class="line">        <span class="comment">//头插</span></span><br><span class="line">        updateNode.next(head.next());</span><br><span class="line">        updateNode.pre(head);</span><br><span class="line">        head.next().pre(updateNode);</span><br><span class="line">        head.next(updateNode);</span><br><span class="line"></span><br><span class="line">        map.put(key, updateNode);</span><br><span class="line">        log.debug(<span class="string">&quot;在 LruMapDoubleList 中更新, key: &#123;&#125;&quot;</span>, key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeKey</span><span class="params">(K key)</span> &#123;</span><br><span class="line">        DoubleListNode&lt;K, V&gt; removeNode = map.get(key);</span><br><span class="line">        <span class="keyword">if</span>(ObjectUtils.isNull(removeNode)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        removeNode.pre().next(removeNode.next());</span><br><span class="line">        removeNode.next().pre(removeNode.pre());</span><br><span class="line"></span><br><span class="line">        map.remove(key);</span><br><span class="line">        log.debug(<span class="string">&quot;从 LruMapDoubleList 中移除, key: &#123;&#125;&quot;</span>, key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">containsKey</span><span class="params">(K key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> map.containsKey(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEmpty</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> map.isEmpty();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="cacheevictlrudoublelistmap">CacheEvictLRUDoubleListMap</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheEvictLRUDoubleListMap</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">AbstractCacheEvict</span>&lt;K,V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DoubleListNode&lt;K,V&gt; head;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DoubleListNode&lt;K,V&gt; tail;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;K, DoubleListNode&lt;K,V&gt;&gt; map;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CacheEvictLRUDoubleListMap</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.head = <span class="keyword">new</span> <span class="title class_">DoubleListNode</span>&lt;&gt;();</span><br><span class="line">        <span class="built_in">this</span>.tail = <span class="keyword">new</span> <span class="title class_">DoubleListNode</span>&lt;&gt;();</span><br><span class="line">        <span class="built_in">this</span>.map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.head.next(<span class="built_in">this</span>.tail);</span><br><span class="line">        <span class="built_in">this</span>.tail.pre(<span class="built_in">this</span>.head);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> ICacheEntry&lt;K,V&gt; <span class="title function_">doEvict</span><span class="params">(ICacheEvictContext&lt;K,V&gt; context)</span> &#123;</span><br><span class="line">        ICache&lt;K, V&gt; cache = context.cache();</span><br><span class="line">        ICacheEntry&lt;K, V&gt; removeEntry = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(map.size() &gt;= context.sizeLimit())&#123;</span><br><span class="line">            removeEntry = removeOldest();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> removeEntry;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateKey</span><span class="params">(K key)</span> &#123;</span><br><span class="line">        DoubleListNode&lt;K, V&gt; updateNode = map.get(key);</span><br><span class="line">        <span class="keyword">if</span>(ObjectUtils.isNull(updateNode)) &#123;</span><br><span class="line">            updateNode = <span class="keyword">new</span> <span class="title class_">DoubleListNode</span>&lt;&gt;();</span><br><span class="line">            updateNode.key(key);</span><br><span class="line">        &#125;</span><br><span class="line">        removeKey(key);</span><br><span class="line">        <span class="comment">//头插</span></span><br><span class="line">        updateNode.next(head.next());</span><br><span class="line">        updateNode.pre(head);</span><br><span class="line">        head.next().pre(updateNode);</span><br><span class="line">        head.next(updateNode);</span><br><span class="line"></span><br><span class="line">        map.put(key, updateNode);</span><br><span class="line">        log.debug(<span class="string">&quot;在 LruMapDoubleList 中更新, key: &#123;&#125;&quot;</span>, key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeKey</span><span class="params">(K key)</span> &#123;</span><br><span class="line">        DoubleListNode&lt;K, V&gt; removeNode = map.get(key);</span><br><span class="line">        <span class="keyword">if</span>(ObjectUtils.isNull(removeNode)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        removeNode.pre().next(removeNode.next());</span><br><span class="line">        removeNode.next().pre(removeNode.pre());</span><br><span class="line"></span><br><span class="line">        map.remove(key);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ICacheEntry&lt;K, V&gt; <span class="title function_">removeOldest</span><span class="params">()</span> &#123;</span><br><span class="line">        DoubleListNode&lt;K, V&gt; tailPre = <span class="built_in">this</span>.tail.pre();</span><br><span class="line">        <span class="keyword">if</span>(tailPre == <span class="built_in">this</span>.head)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CacheRuntimeException</span>(<span class="string">&quot;链表中无结点，头结点无法删除!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        ICacheEntry&lt;K, V&gt; entry = CacheEntry.&lt;K, V&gt;of(tailPre.key(), tailPre.value());</span><br><span class="line">        removeKey(tailPre.key());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> entry;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="cacheevictlrulinkedhashmap">CacheEvictLruLinkedHashMap</h5>
<p>这个类是jdk自带的 双向链表 + hashmap的实现，我们可以直接用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheEvictLruLinkedHashMap</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">LinkedHashMap</span>&lt;K,V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> capacity;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CacheEvictLruLinkedHashMap</span><span class="params">(<span class="type">int</span> capacity)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(capacity, <span class="number">0.75f</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="built_in">this</span>.capacity = capacity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">removeEldestEntry</span><span class="params">(Map.Entry&lt;K, V&gt; eldest)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.size() &gt;= capacity;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="lru2q">LRU2Q</h3>
<p>2Q将LRU-2算法中的访问历史队列（注意这不是缓存数据的）改为一个<strong>FIFO缓存队列</strong>。</p>
<p>数据第一次访问，添加到FIFO缓存队列，第二次访问，再放到LRU缓存队列。</p>
<p>两个队列有各自的淘汰策略</p>
<h4 id="实现-3">实现</h4>
<p>具体淘汰模式：</p>
<p>先淘汰fifo队列，再淘汰lruMap中数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheEvictLRU2Q</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">AbstractCacheEvict</span>&lt;K,V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Queue&lt;K&gt; fifoQueue;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">QUEUE_LIMIT</span> <span class="operator">=</span> <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LruMapDoubleList&lt;K,V&gt; lruMapDoubleList;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CacheEvictLRU2Q</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.fifoQueue = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        <span class="built_in">this</span>.lruMapDoubleList = <span class="keyword">new</span> <span class="title class_">LruMapDoubleList</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> ICacheEntry&lt;K, V&gt; <span class="title function_">doEvict</span><span class="params">(ICacheEvictContext&lt;K, V&gt; context)</span> &#123;</span><br><span class="line">        ICache&lt;K, V&gt; cache = context.cache();</span><br><span class="line">        <span class="type">K</span> <span class="variable">evictKey</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        ICacheEntry&lt;K, V&gt; result = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(cache.size() &gt;= context.sizeLimit())&#123;</span><br><span class="line">            <span class="keyword">if</span>(fifoQueue != <span class="literal">null</span>)&#123;</span><br><span class="line">                evictKey = fifoQueue.poll();</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                ICacheEntry&lt;K, V&gt; removeEntry = lruMapDoubleList.removeOldest();</span><br><span class="line">                evictKey = removeEntry.key();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">V</span> <span class="variable">remove</span> <span class="operator">=</span> cache.remove(evictKey);</span><br><span class="line">            result = CacheEntry.of(evictKey, remove);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeKey</span><span class="params">(K key)</span> &#123;</span><br><span class="line">        <span class="comment">//自顶向下</span></span><br><span class="line">        <span class="keyword">if</span> (lruMapDoubleList.containsKey(key)) &#123;</span><br><span class="line">            lruMapDoubleList.removeKey(key);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//O(n)的时间复杂度</span></span><br><span class="line">            fifoQueue.remove(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateKey</span><span class="params">(K key)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (lruMapDoubleList.containsKey(key) || fifoQueue.contains(key)) &#123;</span><br><span class="line">            removeKey(key);</span><br><span class="line">            lruMapDoubleList.updateKey(key);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        fifoQueue.offer(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="lru-2">LRU-2</h3>
<p>LRU-2是LRU-K的最佳实践。</p>
<p><strong>LRU-K介绍</strong></p>
<ul>
<li>K：最近访问的次数</li>
</ul>
<p>目的：解决缓存污染问题</p>
<p>数据结构：LRU需要多维护一个队列，表示缓存被访问的历史，数据的访问次数达到K次，就放入缓存。</p>
<p>淘汰规则：会淘汰第K次访问时
间距当前时间最大的数据；数据第一次被访问时，加入到历史访问列表，如果数据在访问历史列表中没有达到K次访问，则按照一定的规则（FIFO,LRU）淘汰；</p>
<p>添加缓存规则：当访问历史队列中的数据访问次数达到K次后，将数据索引从历史队列中删除，将数据移到缓存队列中，并缓存数据，缓存队列重新按照时间排序；</p>
<p>底层数据结构还是<code>lru</code> 的双向链表 + map</p>
<h4 id="实现-4">实现</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheEvictLRU2</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">AbstractCacheEvict</span>&lt;K,V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ILruMap&lt;K,V&gt; firstVisitLruMap;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ILruMap&lt;K,V&gt; moreVisitLruMap;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CacheEvictLRU2</span><span class="params">()</span>&#123;</span><br><span class="line">        firstVisitLruMap = <span class="keyword">new</span> <span class="title class_">LruMapDoubleList</span>&lt;&gt;();</span><br><span class="line">        moreVisitLruMap = <span class="keyword">new</span> <span class="title class_">LruMapDoubleList</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> ICacheEntry&lt;K, V&gt; <span class="title function_">doEvict</span><span class="params">(ICacheEvictContext&lt;K, V&gt; context)</span> &#123;</span><br><span class="line">        ICache&lt;K, V&gt; cache = context.cache();</span><br><span class="line">        ICacheEntry&lt;K, V&gt; result = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(cache.size() &gt;= context.sizeLimit()) &#123;</span><br><span class="line">            ICacheEntry&lt;K, V&gt; removeEntry = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span>(!firstVisitLruMap.isEmpty())&#123;</span><br><span class="line">                removeEntry = firstVisitLruMap.removeOldest();</span><br><span class="line">                log.debug(<span class="string">&quot;[lru-2]: 从 firstVisitLruMap 中淘汰数据 key：&#123;&#125;&quot;</span>, removeEntry.key());</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                removeEntry = moreVisitLruMap.removeOldest();</span><br><span class="line">                log.debug(<span class="string">&quot;[lru-2]: 从 moreVisitLruMap 中淘汰数据 key：&#123;&#125;&quot;</span>, removeEntry.key());</span><br><span class="line">            &#125;</span><br><span class="line">            result = removeEntry;</span><br><span class="line">            cache.remove(result.key());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeKey</span><span class="params">(K key)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(moreVisitLruMap.containsKey(key)) &#123;</span><br><span class="line">            moreVisitLruMap.removeKey(key);</span><br><span class="line">            log.debug(<span class="string">&quot;[lru-2]: 从 moreVisitLruMap 中移除 key：&#123;&#125;&quot;</span>, key);</span><br><span class="line">        &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">            firstVisitLruMap.removeKey(key);</span><br><span class="line">            log.debug(<span class="string">&quot;[lru-2]: 从 firstVisitLruMap 中移除 key：&#123;&#125;&quot;</span>, key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateKey</span><span class="params">(K key)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(moreVisitLruMap.containsKey(key) || firstVisitLruMap.containsKey(key))&#123;</span><br><span class="line">            removeKey(key);</span><br><span class="line">            moreVisitLruMap.updateKey(key);</span><br><span class="line">            log.debug(<span class="string">&quot;key: &#123;&#125; 多次访问，加入到 moreLruMap 中&quot;</span>, key);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            firstVisitLruMap.updateKey(key);</span><br><span class="line">            log.debug(<span class="string">&quot;key: &#123;&#125; 为第一次访问，加入到 firstLruMap 中&quot;</span>, key);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="lfu">LFU</h3>
<p>LFU(Least Frequently
Used)即最近最不常用，是基于访问频次的一种算法</p>
<p>存储空间上会多出一些，存储元素的访问次数</p>
<p>淘汰性能：</p>
<p>O(n)： <code>HashMap&lt;String, Interger&gt;</code>, String 对应 key
信息，Integer 对应次数。每次访问到就去+1，设置和读取的时间复杂度都是
O(1)；不过删除就比较麻烦了，需要全部遍历对比，时间复杂度为 O(n);</p>
<p>O(logn)：利用小顶堆+hashmap，小顶堆插入、删除操作都能达到O(logn)时间复杂度，因此效率相比第一种实现方法更加高效。</p>
<p>本项目实现基于O(1)形式：</p>
<p>0(1)：都需要hash操作，参考用于HTTP协议的缓存网络代理应用程序</p>
<p>浏览器经常出现循环请求的场景，这时用lfu命中率会大大提高</p>
<p>LFU支持的操作：</p>
<ol type="1">
<li>插入数据</li>
<li>对数据的频次自增</li>
<li>从缓存中逐出使用次数最少的数据</li>
</ol>
<p>数据结构演示：</p>
<p><img src="渐进式redis缓存工具Vedis/image-20231212180338056.png" alt="LFU-O(1)时间复杂度数据结构" style="zoom:67%;" /></p>
<p>通过维护2个链接列表来实现，一个用于访问频率，另一个用于访问相同频率的全部结点。</p>
<ul>
<li>哈希表：按key访问元素</li>
<li>双向列表：存放不同频率的集合</li>
</ul>
<h4 id="实现-5">实现</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheEvictLFU</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">AbstractCacheEvict</span>&lt;K,V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;K, FreqNode&lt;K,V&gt;&gt; keyMap;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;Integer, LinkedHashSet&lt;FreqNode&lt;K,V&gt;&gt;&gt; freqMap;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> minFreq;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CacheEvictLFU</span><span class="params">()</span> &#123;</span><br><span class="line">        keyMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        freqMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        minFreq = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> ICacheEntry&lt;K, V&gt; <span class="title function_">doEvict</span><span class="params">(ICacheEvictContext&lt;K, V&gt; context)</span> &#123;</span><br><span class="line">        ICache&lt;K, V&gt; cache = context.cache();</span><br><span class="line">        ICacheEntry&lt;K,V&gt; result = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(cache.size() &gt;= context.sizeLimit())&#123;</span><br><span class="line">            FreqNode&lt;K, V&gt; evictNode = getMinFreqNode();</span><br><span class="line">            <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> evictNode.key();</span><br><span class="line">            <span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> cache.remove(key);</span><br><span class="line">            <span class="built_in">this</span>.removeKey(key);</span><br><span class="line">            log.debug(<span class="string">&quot;淘汰最小频率信息, key: &#123;&#125;, value: &#123;&#125;, freq: &#123;&#125;&quot;</span>,</span><br><span class="line">                    key, value, evictNode.frequency());</span><br><span class="line">            result = CacheEntry.of(key, value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> FreqNode&lt;K,V&gt; <span class="title function_">getMinFreqNode</span><span class="params">()</span> &#123;</span><br><span class="line">        LinkedHashSet&lt;FreqNode&lt;K, V&gt;&gt; minFreqSet = freqMap.get(minFreq);</span><br><span class="line">        <span class="keyword">if</span>(CollectionUtil.isNotEmpty(minFreqSet))&#123;</span><br><span class="line">            <span class="comment">//返回第一个元素</span></span><br><span class="line">            <span class="keyword">return</span> minFreqSet.iterator().next();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CacheRuntimeException</span>(<span class="string">&quot;未发现最小频率的 Key&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateKey</span><span class="params">(K key)</span> &#123;</span><br><span class="line">        FreqNode&lt;K, V&gt; freqNode = keyMap.get(key);</span><br><span class="line">        <span class="keyword">if</span>(ObjectUtils.isNotEmpty(freqNode))&#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">oldFrequency</span> <span class="operator">=</span> freqNode.frequency();</span><br><span class="line">            LinkedHashSet&lt;FreqNode&lt;K, V&gt;&gt; preSet = freqMap.get(oldFrequency);</span><br><span class="line">            preSet.remove(freqNode);</span><br><span class="line">            <span class="comment">//更新min</span></span><br><span class="line">            <span class="keyword">if</span>(minFreq == oldFrequency &amp;&amp; preSet.isEmpty())&#123;</span><br><span class="line">                minFreq++;</span><br><span class="line">                log.debug(<span class="string">&quot;minFreq 增加为：&#123;&#125;&quot;</span>, minFreq);</span><br><span class="line">            &#125;</span><br><span class="line">            addToFreqMap(oldFrequency + <span class="number">1</span> , freqNode);</span><br><span class="line">            freqNode.frequency(oldFrequency + <span class="number">1</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            freqNode = <span class="keyword">new</span> <span class="title class_">FreqNode</span>&lt;&gt;(key);</span><br><span class="line">            keyMap.put(key, freqNode);</span><br><span class="line">            addToFreqMap(<span class="number">1</span>, freqNode);</span><br><span class="line">            <span class="comment">//更新min</span></span><br><span class="line">            minFreq = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addToFreqMap</span><span class="params">(<span class="type">int</span> frequency, FreqNode&lt;K, V&gt; freqNode)</span> &#123;</span><br><span class="line">        LinkedHashSet&lt;FreqNode&lt;K, V&gt;&gt; set = freqMap.get(frequency);</span><br><span class="line">        <span class="keyword">if</span>(set == <span class="literal">null</span>)&#123;</span><br><span class="line">            set = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        set.add(freqNode);</span><br><span class="line">        freqMap.put(frequency, set);</span><br><span class="line">        log.debug(<span class="string">&quot;[freqMap]: freq=&#123;&#125; 添加元素节点：&#123;&#125;&quot;</span>, frequency, freqNode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeKey</span><span class="params">(K key)</span> &#123;</span><br><span class="line">        FreqNode&lt;K, V&gt; removeNode = keyMap.remove(key);</span><br><span class="line">        <span class="type">int</span> <span class="variable">frequency</span> <span class="operator">=</span> removeNode.frequency();</span><br><span class="line">        LinkedHashSet&lt;FreqNode&lt;K, V&gt;&gt; freqNodeLinkedHashSet = freqMap.get(frequency);</span><br><span class="line">        freqNodeLinkedHashSet.remove(removeNode);</span><br><span class="line">        <span class="comment">//更新min</span></span><br><span class="line">        <span class="keyword">if</span>(freqNodeLinkedHashSet.isEmpty() &amp;&amp; minFreq == frequency)&#123;</span><br><span class="line">            minFreq--;</span><br><span class="line">            log.debug(<span class="string">&quot;minFreq 减少为：&#123;&#125;&quot;</span>, minFreq);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="clock">Clock</h3>
<h4 id="实现-6">实现</h4>
<p>思路：对于每一个缓存数据，定义中都带有一个accessFlag标识位，初始为0，表示该数据进入缓存以后到目前为止未被访问过。</p>
<p>数据结构的实现：</p>
<p>环形双向链表 + lru</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LruMapCircleList</span>&lt;K,V&gt; <span class="keyword">implements</span> <span class="title class_">ILruMap</span>&lt;K,V&gt; &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> CircleListNode&lt;K,V&gt; head;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> CircleListNode&lt;K,V&gt; pre;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;K,CircleListNode&lt;K,V&gt;&gt; indexMap;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LruMapCircleList</span><span class="params">()</span> &#123;</span><br><span class="line">        head = <span class="keyword">new</span> <span class="title class_">CircleListNode</span>&lt;&gt;(<span class="literal">null</span>);</span><br><span class="line">        indexMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        pre = head;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.head.next(<span class="built_in">this</span>.head);</span><br><span class="line">        <span class="built_in">this</span>.head.pre(<span class="built_in">this</span>.head);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ICacheEntry&lt;K, V&gt; <span class="title function_">removeOldest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(isEmpty())&#123;</span><br><span class="line">            log.error(<span class="string">&quot;当前列表为空，无法进行删除&quot;</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CacheRuntimeException</span>(<span class="string">&quot;不可删除头结点!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        CircleListNode&lt;K, V&gt; cur = <span class="built_in">this</span>.pre;</span><br><span class="line">        <span class="keyword">while</span> (cur.next() != head)&#123;</span><br><span class="line">            cur = cur.next();</span><br><span class="line">            <span class="keyword">if</span>(cur.accessFlag())&#123;</span><br><span class="line">                cur.accessFlag(<span class="literal">false</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                removeKey(cur.key());</span><br><span class="line">                <span class="keyword">return</span> CacheEntry.of(cur.key(), cur.value());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//循环一圈都没找到，降级为FIFO</span></span><br><span class="line">        pre = head;</span><br><span class="line">        CircleListNode&lt;K,V&gt; firstNode = <span class="built_in">this</span>.head.next();</span><br><span class="line">        removeKey(head.next().key());</span><br><span class="line">        <span class="keyword">return</span> CacheEntry.of(firstNode.key(), firstNode.value());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateKey</span><span class="params">(K key)</span> &#123;</span><br><span class="line">        CircleListNode&lt;K, V&gt; node = indexMap.get(key);</span><br><span class="line">        <span class="keyword">if</span>(ObjectUtils.isNotEmpty(node)) &#123;</span><br><span class="line">            node.accessFlag(<span class="literal">true</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;节点已存在，设置节点访问标识为 true, key: &#123;&#125;&quot;</span>, key);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            node = <span class="keyword">new</span> <span class="title class_">CircleListNode</span>&lt;&gt;(key);</span><br><span class="line">            CircleListNode&lt;K, V&gt; tail = head.pre();</span><br><span class="line">            node.next(head);</span><br><span class="line">            node.pre(tail);</span><br><span class="line">            tail.next(node);</span><br><span class="line">            head.pre(node);</span><br><span class="line">            indexMap.put(key, node);</span><br><span class="line">            log.debug(<span class="string">&quot;节点不存在，新增节点到链表中：&#123;&#125;&quot;</span>, key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeKey</span><span class="params">(K key)</span> &#123;</span><br><span class="line">        CircleListNode&lt;K, V&gt; removeNode = indexMap.get(key);</span><br><span class="line">        <span class="keyword">if</span>(ObjectUtils.isEmpty(removeNode)) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;对应的删除信息不存在：&#123;&#125;&quot;</span>, key);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        CircleListNode&lt;K, V&gt; pre = removeNode.pre();</span><br><span class="line">        CircleListNode&lt;K, V&gt; next = removeNode.next();</span><br><span class="line"></span><br><span class="line">        pre.next(next);</span><br><span class="line">        next.pre(pre);</span><br><span class="line">        indexMap.remove(key);</span><br><span class="line">        log.debug(<span class="string">&quot;Key: &#123;&#125; 从循环链表中移除&quot;</span>, key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">containsKey</span><span class="params">(K key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> indexMap.containsKey(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEmpty</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> indexMap.isEmpty();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>策略类实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheEvictClock</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">AbstractCacheEvict</span>&lt;K,V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LruMapCircleList&lt;K,V&gt; circleList;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CacheEvictClock</span><span class="params">()</span> &#123;</span><br><span class="line">        circleList = <span class="keyword">new</span> <span class="title class_">LruMapCircleList</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> ICacheEntry&lt;K, V&gt; <span class="title function_">doEvict</span><span class="params">(ICacheEvictContext&lt;K, V&gt; context)</span> &#123;</span><br><span class="line">        CacheEntry&lt;K,V&gt; result = <span class="literal">null</span>;</span><br><span class="line">        ICache&lt;K, V&gt; cache = context.cache();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(cache.size() &gt;= context.sizeLimit()) &#123;</span><br><span class="line">            result = (CacheEntry&lt;K, V&gt;) circleList.removeOldest();</span><br><span class="line">            <span class="type">V</span> <span class="variable">removeValue</span> <span class="operator">=</span> cache.remove(result.key());</span><br><span class="line">            log.debug(<span class="string">&quot;基于 clock 算法淘汰 key：&#123;&#125;, value: &#123;&#125;&quot;</span>, result.key(), removeValue);</span><br><span class="line">            result.value(removeValue);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeKey</span><span class="params">(K key)</span> &#123;</span><br><span class="line">        circleList.removeKey(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateKey</span><span class="params">(K key)</span> &#123;</span><br><span class="line">        circleList.updateKey(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="监听器">监听器</h1>
<h2 id="删除监听器">删除监听器</h2>
<p>应用场景：</p>
<ul>
<li>evict驱逐场景</li>
<li>expire过期场景</li>
</ul>
<h3 id="接口定义-5">接口定义</h3>
<p><strong>ICacheRemoveListener</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: 监听器删除接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> VLS</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/12/6 20:07</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ICacheRemoveListener</span>&lt;K,V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span>: 监听动作</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> VLS</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/12/6 20:19</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">listen</span><span class="params">(ICacheRemoveListenerContext&lt;K,V&gt; removeListenerContext)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ICacheRemoveListenerContext</strong></p>
<p>监听所需要的信息都存储在这个上下文中，由上下文传递：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: 监听器上下文</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> VLS</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/12/6 20:21</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ICacheRemoveListenerContext</span>&lt;K,V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 返回淘汰或者清空的key</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    K <span class="title function_">key</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    V <span class="title function_">value</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 清空类型: 过期淘汰 or 内存满了的淘汰</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">type</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="实现-7">实现</h3>
<h4 id="cacheremovelistener">CacheRemoveListener</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheRemoveListener</span>&lt;K,V&gt; <span class="keyword">implements</span> <span class="title class_">ICacheRemoveListener</span>&lt;K,V&gt; &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> removeListenerContext</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span>: 监听动作</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> VLS</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/12/6 20:19</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listen</span><span class="params">(ICacheRemoveListenerContext&lt;K, V&gt; removeListenerContext)</span> &#123;</span><br><span class="line">        <span class="type">SimpleDateFormat</span> <span class="variable">formatter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line"></span><br><span class="line">        log.debug(<span class="string">&quot;Remove key: &#123;&#125;, value: &#123;&#125;, type: &#123;&#125;, timeAt: &#123;&#125;&quot;</span>,</span><br><span class="line">                removeListenerContext.key(),</span><br><span class="line">                removeListenerContext.value(),</span><br><span class="line">                removeListenerContext.type(),</span><br><span class="line">                formatter.format(System.currentTimeMillis()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="cacheremovelistenercontext">CacheRemoveListenerContext</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheRemoveListenerContext</span>&lt;K,V&gt; <span class="keyword">implements</span> <span class="title class_">ICacheRemoveListenerContext</span>&lt;K,V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> K key;</span><br><span class="line">    <span class="keyword">private</span> V value;</span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;K,V&gt; CacheRemoveListenerContext&lt;K,V&gt; <span class="title function_">newInstance</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CacheRemoveListenerContext</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> K <span class="title function_">key</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> CacheRemoveListenerContext&lt;K,V&gt; <span class="title function_">setKey</span><span class="params">(K key)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.key = key;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> V <span class="title function_">value</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> CacheRemoveListenerContext&lt;K,V&gt; <span class="title function_">setValue</span><span class="params">(V value)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.value = value;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">type</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> CacheRemoveListenerContext&lt;K,V&gt; <span class="title function_">setType</span><span class="params">(String type)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.type = type;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="cacheremovelisteners">CacheRemoveListeners</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheRemoveListeners</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">CacheRemoveListeners</span><span class="params">()</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span>  &lt;K,V&gt; List&lt;ICacheRemoveListener&lt;K,V&gt;&gt; <span class="title function_">defaults</span><span class="params">()</span>&#123;</span><br><span class="line">        List&lt;ICacheRemoveListener&lt;K,V&gt;&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        list.add(<span class="keyword">new</span> <span class="title class_">CacheRemoveListener</span>&lt;&gt;());</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="慢操作监听器">慢操作监听器</h2>
<p>redis 中会存储慢操作的相关日志信息，日志主要是由两个参数构成：</p>
<ul>
<li>slowlog-log-slower-than
预设阈值,它的单位是毫秒(1秒=1000000微秒)默认值是10000、</li>
<li>slowlog-max-len 最多存储多少条的慢日志记录</li>
</ul>
<p>作用：打印出每个对缓存的操作的操作时间，这个时间有个阈值由用户来设置，比如超过
100ms，用户可以选择输出 warn 日志；超过
1s，可能影响到业务了，可以直接接入报警系统。</p>
<h3 id="接口定义-6">接口定义</h3>
<p><strong>ICacheSlowListener</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ICacheSlowListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">listen</span><span class="params">(ICacheSlowListenerContext context)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 慢日志触发阈值</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">long</span> <span class="title function_">slowerThanMills</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>那它要打印哪些东西呢？ 由上下文对象带给他</p></li>
<li><p>没用泛型的原因：因为打印的东西不需要具体的缓存内容，Key
Value不需要，所以不需要定义K,V</p></li>
</ul>
<p><strong>ICacheSlowListenerContext</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ICacheSlowListenerContext</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 方法/操作 名</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">methodName</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 方法参数</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Object[] params();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 方法返回值</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Object <span class="title function_">result</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="title function_">startTimeMills</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="title function_">endTimeMills</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="title function_">costTimeMills</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="实现-8">实现</h3>
<h4 id="cacheslowlistener"><strong>CacheSlowListener</strong></h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheSlowListener</span> <span class="keyword">implements</span> <span class="title class_">ICacheSlowListener</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listen</span><span class="params">(ICacheSlowListenerContext context)</span> &#123;</span><br><span class="line">        log.warn(<span class="string">&quot;[Slow] methodName: &#123;&#125;, params: &#123;&#125;, cost time: &#123;&#125;&quot;</span>,</span><br><span class="line">                context.methodName(), JSON.toJSON(context.params()), context.costTimeMills());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">slowerThanMills</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//超过1s就打印</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1000</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="cacheslowlistenercontext">CacheSlowListenerContext</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheSlowListenerContext</span> <span class="keyword">implements</span> <span class="title class_">ICacheSlowListenerContext</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String methodName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object[] params;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object result;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> startTimeMills;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> endTimeMills;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> costTimeMills;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">methodName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> methodName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> CacheSlowListenerContext <span class="title function_">setMethodName</span><span class="params">(String methodName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.methodName = methodName;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object[] params() &#123;</span><br><span class="line">        <span class="keyword">return</span> params;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> CacheSlowListenerContext <span class="title function_">setParams</span><span class="params">(Object[] params)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.params = params;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">result</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> CacheSlowListenerContext <span class="title function_">setResult</span><span class="params">(Object result)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.result = result;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">startTimeMills</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> startTimeMills;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> CacheSlowListenerContext <span class="title function_">setStartTimeMills</span><span class="params">(<span class="type">long</span> startTimeMills)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.startTimeMills = startTimeMills;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">endTimeMills</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> endTimeMills;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> CacheSlowListenerContext <span class="title function_">setEndTimeMills</span><span class="params">(<span class="type">long</span> endTimeMills)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.endTimeMills = endTimeMills;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">costTimeMills</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> costTimeMills;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> CacheSlowListenerContext <span class="title function_">setCostTimeMills</span><span class="params">(<span class="type">long</span> costTimeMills)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.costTimeMills = costTimeMills;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="cacheslowlisteners">CacheSlowListeners</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">CacheSlowListeners</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">CacheSlowListeners</span><span class="params">()</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 无</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 监听类列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 0.0.9</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;ICacheSlowListener&gt; <span class="title function_">none</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 默认实现</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 默认</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 0.0.9</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ICacheSlowListener <span class="title function_">defaults</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CacheSlowListener</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="耗时拦截器">耗时拦截器</h3>
<p>这个拦截器是获取方法执行的时间的，专门服务于slow日志操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheInterceptorCost</span>&lt;K,V&gt; <span class="keyword">implements</span> <span class="title class_">ICacheInterceptor</span>&lt;K,V&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">(ICacheInterceptorContext&lt;K, V&gt; context)</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;Cost start, method: &#123;&#125;&quot;</span>, context.method().getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">after</span><span class="params">(ICacheInterceptorContext&lt;K, V&gt; context)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">costMills</span> <span class="operator">=</span> context.endMills() - context.startMills();</span><br><span class="line">        <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> context.method().getName();</span><br><span class="line">        log.debug(<span class="string">&quot;Cost end, method: &#123;&#125;, cost: &#123;&#125;ms&quot;</span>, methodName, costMills);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//添加慢日志操作</span></span><br><span class="line">        List&lt;ICacheSlowListener&gt; slowListeners = context.cache().slowListeners();</span><br><span class="line">        <span class="keyword">if</span>(CollectionUtil.isNotEmpty(slowListeners))&#123;</span><br><span class="line">            <span class="type">CacheSlowListenerContext</span> <span class="variable">slowListenerContext</span> <span class="operator">=</span> CacheSlowListenerContext.newInstance()</span><br><span class="line">                    .setCostTimeMills(costMills)</span><br><span class="line">                    .setEndTimeMills(context.endMills())</span><br><span class="line">                    .setStartTimeMills(context.startMills())</span><br><span class="line">                    .setMethodName(methodName)</span><br><span class="line">                    .setParams(context.params())</span><br><span class="line">                    .setResult(context.result());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (ICacheSlowListener slowListener : slowListeners) &#123;</span><br><span class="line">                <span class="comment">//根据设置的阈值</span></span><br><span class="line">                <span class="type">long</span> <span class="variable">slowerThanMills</span> <span class="operator">=</span> slowListener.slowerThanMills();</span><br><span class="line">                <span class="keyword">if</span>(costMills &gt; slowerThanMills)&#123;</span><br><span class="line">                    slowListener.listen(slowListenerContext);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>交给代理类去整合增强即可</p>
<h2 id="实体类cacheentry优化">实体类CacheEntry优化</h2>
<p>因为监听器需要获取删除元素的Key和Value，之前我们定义的方法返回值都是void，优化一下：</p>
<p>ICacheEntry接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ICacheEntry</span>&lt;K,V&gt; &#123;</span><br><span class="line">    K <span class="title function_">key</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    V <span class="title function_">value</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheEntry</span>&lt;K,V&gt; <span class="keyword">implements</span> <span class="title class_">ICacheEntry</span>&lt;K,V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> K key;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> V value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CacheEntry</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.key = key;</span><br><span class="line">        <span class="built_in">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;K,V&gt; ICacheEntry&lt;K,V&gt; <span class="title function_">of</span><span class="params">(K key, V value)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CacheEntry</span>&lt;&gt;(key, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> K <span class="title function_">key</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> V <span class="title function_">value</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;CacheEntry &#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;key=&quot;</span> + key +</span><br><span class="line">                <span class="string">&quot;, value=&quot;</span> + value +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="应用">应用</h3>
<h4 id="evict">evict</h4>
<p><code>ICacheEvict</code>接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ICacheEntry&lt;K,V&gt; <span class="title function_">evict</span><span class="params">(ICacheEvictContext&lt;K,V&gt; context)</span>;</span><br></pre></td></tr></table></figure>
<h2
id="cache缓存内部导入使用删除监听器">Cache缓存内部导入使用删除监听器</h2>
<ol type="1">
<li><p>接口定义get()方法 构建者模式命名</p></li>
<li><p>添加成员变量</p></li>
<li><p>添加set()方法 构建者模式命名</p></li>
<li><p>在指定的方法添加</p>
<ol type="1">
<li><p>删除监听器：加在evict位置或者expire位置</p>
<p>cache类put方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">    <span class="comment">//1. 尝试淘汰内存,初始化一个CacheEvictContext 服务于策略</span></span><br><span class="line">    CacheEvictContext&lt;K, V&gt; context = <span class="keyword">new</span> <span class="title class_">CacheEvictContext</span>&lt;&gt;();</span><br><span class="line">    context.key(key).sizeLimit(sizeLimit).cache(<span class="built_in">this</span>);</span><br><span class="line">      </span><br><span class="line">    <span class="comment">//添加拦截器</span></span><br><span class="line">    ICacheEntry&lt;K, V&gt; evictEntry = cacheEvict.evict(context);</span><br><span class="line">    <span class="keyword">if</span>(ObjectUtils.isNotEmpty(evictEntry))&#123;</span><br><span class="line">        CacheRemoveListenerContext&lt;K, V&gt; cacheRemoveListenerContext = CacheRemoveListenerContext.&lt;K, V&gt;newInstance()</span><br><span class="line">                .setKey(evictEntry.key())</span><br><span class="line">                .setValue(evictEntry.value())</span><br><span class="line">                .setType(CacheRemoveType.EVICT.getCode());</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">for</span> (ICacheRemoveListener&lt;K, V&gt; removeListener : <span class="built_in">this</span>.removeListeners) &#123;</span><br><span class="line">            removeListener.listen(cacheRemoveListenerContext);</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">      </span><br><span class="line">    <span class="comment">//2. 淘汰后判断能否添加</span></span><br><span class="line">    <span class="keyword">if</span>(isSizeLimited())&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CacheRuntimeException</span>(<span class="string">&quot;当前缓存已满，数据添加失败！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">      </span><br><span class="line">    <span class="keyword">return</span> map.put(key, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CacheExpire类cleanExpireKey方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">cleanExpireKey</span><span class="params">(K key)</span>&#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">expireAtMs</span> <span class="operator">=</span> expireMap.get(key);</span><br><span class="line">      </span><br><span class="line">    <span class="type">long</span> <span class="variable">currentTimeMillis</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">      </span><br><span class="line">    <span class="keyword">if</span>(currentTimeMillis &gt;= expireAtMs)&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;删除的缓存key为&#123;&#125;&quot;</span>, key);</span><br><span class="line">        expireMap.remove(key);</span><br><span class="line">        <span class="type">V</span> <span class="variable">removeValue</span> <span class="operator">=</span> cache.remove(key);</span><br><span class="line">      </span><br><span class="line">        <span class="comment">//过期监听器</span></span><br><span class="line">        CacheRemoveListenerContext&lt;K, V&gt; cacheRemoveListenerContext = CacheRemoveListenerContext.&lt;K, V&gt;newInstance()</span><br><span class="line">                .setKey(key)</span><br><span class="line">                .setValue(removeValue)</span><br><span class="line">                .setType(CacheRemoveType.EXPIRE.getCode());</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">for</span> (ICacheRemoveListener&lt;K, V&gt; removeListener : cache.removeListeners()) &#123;</span><br><span class="line">            removeListener.listen(cacheRemoveListenerContext);</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol></li>
</ol>
<h1 id="代理">代理</h1>
<p>通过代理类去创建我们的缓存对象。</p>
<h2 id="代理如何使用拦截器">*代理如何使用拦截器</h2>
<p>拦截器组件实现完成以后：</p>
<figure>
<img src="渐进式redis缓存工具Vedis/image-20231208174917994.png"
alt="image-20231208174917994" />
<figcaption aria-hidden="true">image-20231208174917994</figcaption>
</figure>
<p>这只是一个组件，然后由CacheInterceptors，作为对外提供的工具类。</p>
<p>而代理，不仅要代理这个方法，还要对这个方法进行增强，那他就需要一个代理Guide上下文，去获取方法的全部信息。</p>
<p>随后核心实现类<code>CacheProxyGuide</code>：整合了代理Guide上下文和<code>CacheInterceptors</code>的拦截器，两者结合使用，达到外部代理增强方法的一个作用。</p>
<h2 id="接口-1">接口</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ICacheProxy</span> &#123;</span><br><span class="line"></span><br><span class="line">    Object <span class="title function_">proxy</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代理的策略也有多种，定义一个接口规范，提供proxy接口，这个方法会返回具体的代理对象。</p>
<p>像之前的慢日志、aof拦截器都可以在代理中增强，由代理去增强之前的代码</p>
<h2 id="实现-9">实现</h2>
<h3 id="无代理">无代理</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NoneProxy</span> <span class="keyword">implements</span> <span class="title class_">ICacheProxy</span>, InvocationHandler &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object target;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">NoneProxy</span><span class="params">(Object target)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.target = target;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">proxy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> target;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(proxy, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="cglib代理">CGLIB代理</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CglibProxy</span> <span class="keyword">implements</span> <span class="title class_">ICacheProxy</span>, MethodInterceptor &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ICache target;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CglibProxy</span><span class="params">(ICache target)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.target = target;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">proxy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Enhancer</span> <span class="variable">enhancer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Enhancer</span>();</span><br><span class="line">        <span class="comment">//要代理的目标对象</span></span><br><span class="line">        enhancer.setSuperclass(target.getClass());</span><br><span class="line"></span><br><span class="line">        enhancer.setCallback(<span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">return</span> enhancer.create();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Object o, Method method, Object[] params, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">CacheProxyGuideContext</span> <span class="variable">context</span> <span class="operator">=</span> CacheProxyGuideContext.newInstance()</span><br><span class="line">                .setMethod(method).setParams(params).target(<span class="built_in">this</span>.target);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> CacheProxyGuide.newInstance().setContext(context).execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="jdk动态代理">JDK动态代理</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicProxy</span> <span class="keyword">implements</span> <span class="title class_">ICacheProxy</span>, InvocationHandler &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ICache target;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DynamicProxy</span><span class="params">(ICache target)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.target = target;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">proxy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 我们要代理哪个真实对象，就将该对象传进去，最后是通过该真实对象来调用其方法的</span></span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">invocationHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DynamicProxy</span>(target);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Proxy.newProxyInstance</span><br><span class="line">                (invocationHandler.getClass().getClassLoader(), target.getClass().getInterfaces(), invocationHandler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">CacheProxyGuideContext</span> <span class="variable">context</span> <span class="operator">=</span> CacheProxyGuideContext.newInstance()</span><br><span class="line">                .setMethod(method).setParams(args).target(<span class="built_in">this</span>.target);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> CacheProxyGuide.newInstance().setContext(context).execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="guideproxy">*GuideProxy</h2>
<h3 id="icacheproxyguidecontext">ICacheProxyGuideContext</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ICacheProxyGuideContext</span> &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 代理的对象</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ICache <span class="title function_">target</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    CacheInterceptor <span class="title function_">interceptor</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 代理对象的代理增强类</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ICacheProxyGuideContext <span class="title function_">target</span><span class="params">(ICache cache)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Object[] params();</span><br><span class="line"></span><br><span class="line">    Method <span class="title function_">method</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    Object <span class="title function_">invoke</span><span class="params">()</span> <span class="keyword">throws</span> Throwable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>包含了被增强方法的一切属性：方法参数、结果、注解等等</p>
<h3 id="cacheproxyguidecontext">CacheProxyGuideContext</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheProxyGuideContext</span> <span class="keyword">implements</span> <span class="title class_">ICacheProxyGuideContext</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ICache target;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object[] params;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Method method;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> CacheInterceptor interceptor;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> CacheProxyGuideContext <span class="title function_">newInstance</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CacheProxyGuideContext</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ICache <span class="title function_">target</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> target;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> CacheProxyGuideContext <span class="title function_">setTarget</span><span class="params">(ICache target)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.target = target;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CacheInterceptor <span class="title function_">interceptor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> interceptor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CacheProxyGuideContext <span class="title function_">target</span><span class="params">(ICache cache)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.target = cache;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object[] params() &#123;</span><br><span class="line">        <span class="keyword">return</span> params;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> CacheProxyGuideContext <span class="title function_">setParams</span><span class="params">(Object[] params)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.params = params;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Method <span class="title function_">method</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> method;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> CacheProxyGuideContext <span class="title function_">setMethod</span><span class="params">(Method method)</span> &#123;</span><br><span class="line">        <span class="comment">//这里的method，是那些被增强的方法，所以Interceptor的set方法在这set</span></span><br><span class="line">        <span class="built_in">this</span>.method = method;</span><br><span class="line">        <span class="built_in">this</span>.interceptor = method.getAnnotation(CacheInterceptor.class);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">()</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(target, params);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意：这里
invoke()；是单独执行未增强的方法，真正增强了的实现是在下面这个类，融合了两者以后的执行，所以要用下面这个类的execute方法去执行。</p>
<h3 id="cacheproxyguide">CacheProxyGuide</h3>
<p>拦截器的具体功能启用都在该类定义实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheProxyGuide</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">CacheProxyGuide</span><span class="params">()</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ICacheProxyGuideContext context;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> CacheProxyGuide <span class="title function_">setContext</span><span class="params">(ICacheProxyGuideContext context)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.context = context;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> CacheProxyGuide <span class="title function_">newInstance</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CacheProxyGuide</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 持久化拦截器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 0.0.10</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;all&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ICacheInterceptor</span> <span class="variable">persistInterceptors</span> <span class="operator">=</span> CacheInterceptors.aof();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 启动代理增强   这里其实就是拦截器增强的流程  before -&gt; 方法 -&gt; after</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return 代理的方法的执行结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">execute</span><span class="params">()</span> <span class="keyword">throws</span> Throwable&#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">startMills</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">ICache</span> <span class="variable">cache</span> <span class="operator">=</span> context.target();</span><br><span class="line">        <span class="type">CacheInterceptorContext</span> <span class="variable">interceptorContext</span> <span class="operator">=</span> CacheInterceptorContext.newInstance()</span><br><span class="line">                .setStartMills(startMills)</span><br><span class="line">                .setMethod(context.method())</span><br><span class="line">                .setParams(context.params())</span><br><span class="line">                .setCache(cache);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取刷新注解信息</span></span><br><span class="line">        <span class="type">CacheInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> context.interceptor();</span><br><span class="line">        <span class="comment">//先执行拦截器的before</span></span><br><span class="line">        <span class="built_in">this</span>.interceptorHandler(interceptor, interceptorContext, cache, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//加了注解的方法的执行   真正执行方法的是代理，不可能是拦截器，所以不要调用CacheInterceptorContext.result</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> context.invoke();</span><br><span class="line">        <span class="type">long</span> <span class="variable">endMills</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//把剩余信息提供给拦截器</span></span><br><span class="line">        interceptorContext.setEndMills(endMills).setResult(result);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//再执行拦截器的after</span></span><br><span class="line">        <span class="built_in">this</span>.interceptorHandler(interceptor, interceptorContext, cache, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">interceptorHandler</span><span class="params">(CacheInterceptor interceptor,</span></span><br><span class="line"><span class="params">                                    CacheInterceptorContext interceptorContext,</span></span><br><span class="line"><span class="params">                                    ICache cache,</span></span><br><span class="line"><span class="params">                                    <span class="type">boolean</span> before)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(interceptor != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//aof追加</span></span><br><span class="line">            <span class="type">ICachePersist</span> <span class="variable">persist</span> <span class="operator">=</span> cache.persist();</span><br><span class="line">            <span class="keyword">if</span>(interceptor.aof() &amp;&amp; (persist <span class="keyword">instanceof</span> CachePersistAof))&#123;</span><br><span class="line">                <span class="keyword">if</span>(before)&#123;</span><br><span class="line">                    persistInterceptors.before(interceptorContext);</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    persistInterceptors.after(interceptorContext);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//cost统计方法时长</span></span><br><span class="line">            <span class="keyword">if</span>(interceptor.common())&#123;</span><br><span class="line">                <span class="keyword">for</span> (ICacheInterceptor costInterceptor : costInterceptors) &#123;</span><br><span class="line">                    <span class="keyword">if</span>(before)&#123;</span><br><span class="line">                        costInterceptor.before(interceptorContext);</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        costInterceptor.after(interceptorContext);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="手写hashmap">手写HashMap</h1>
<p>这是初版自定义hashmap，仿照redis的在后面</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProgressiveRehashMap</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">AbstractMap</span>&lt;K,V&gt; <span class="keyword">implements</span> <span class="title class_">Map</span>&lt;K,V&gt;&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> capacity;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> <span class="variable">factor</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;List&lt;Entry&lt;K,V&gt;&gt;&gt; table;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">debugMode</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> <span class="variable">reduceFactor</span> <span class="operator">=</span> <span class="number">0.5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">MIN_CAPACITY</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">DefaultEntry</span>&lt;K,V&gt; <span class="keyword">implements</span> <span class="title class_">Map</span>.Entry&lt;K,V&gt; &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> hash;</span><br><span class="line">        <span class="keyword">final</span> K key;</span><br><span class="line">        V value;</span><br><span class="line">        ProgressiveRehashMap.DefaultEntry&lt;K,V&gt; next;</span><br><span class="line"></span><br><span class="line">        DefaultEntry(<span class="type">int</span> hash, K key, V value, ProgressiveRehashMap.DefaultEntry&lt;K,V&gt; next) &#123;</span><br><span class="line">            <span class="built_in">this</span>.hash = hash;</span><br><span class="line">            <span class="built_in">this</span>.key = key;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">            <span class="built_in">this</span>.next = next;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        DefaultEntry(K key, V value, <span class="type">int</span> hash) &#123;</span><br><span class="line">            <span class="built_in">this</span>.key = key;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">            <span class="built_in">this</span>.hash = hash;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> K <span class="title function_">getKey</span><span class="params">()</span>         &#123; <span class="keyword">return</span> key; &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> V <span class="title function_">getValue</span><span class="params">()</span>      &#123; <span class="keyword">return</span> value; &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Objects.hashCode(key) ^ Objects.hashCode(value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> V <span class="title function_">setValue</span><span class="params">(V newValue)</span> &#123;</span><br><span class="line">            <span class="type">V</span> <span class="variable">oldValue</span> <span class="operator">=</span> value;</span><br><span class="line">            value = newValue;</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (o == <span class="built_in">this</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (o <span class="keyword">instanceof</span> Map.Entry) &#123;</span><br><span class="line">                Map.Entry&lt;?,?&gt; e = (Map.Entry&lt;?,?&gt;)o;</span><br><span class="line">                <span class="keyword">if</span> (Objects.equals(key, e.getKey()) &amp;&amp;</span><br><span class="line">                        Objects.equals(value, e.getValue()))</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&#123;&quot;</span> +key +</span><br><span class="line">                    <span class="string">&quot;: &quot;</span> + value +</span><br><span class="line">                    <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ProgressiveRehashMap</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(<span class="number">8</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ProgressiveRehashMap</span><span class="params">(<span class="type">int</span> capacity)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(capacity, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ProgressiveRehashMap</span><span class="params">(<span class="type">int</span> capacity, <span class="type">boolean</span> debugMode)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(capacity &lt; MIN_CAPACITY) &#123;</span><br><span class="line">            capacity = MIN_CAPACITY;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.capacity = capacity;</span><br><span class="line">        table = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(capacity);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; capacity; i++) &#123;</span><br><span class="line">            table.add(i, <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;Entry&lt;K,V&gt;&gt;());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.debugMode = debugMode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> HashUtils.hash(key);</span><br><span class="line">        <span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> (capacity - <span class="number">1</span>) &amp; hash;</span><br><span class="line"></span><br><span class="line">        List&lt;Entry&lt;K, V&gt;&gt; entries = table.get(idx);</span><br><span class="line">        <span class="comment">//遍历链表，查看key是否已存在</span></span><br><span class="line">        <span class="keyword">for</span> (Entry&lt;K, V&gt; entry : entries) &#123;</span><br><span class="line">            <span class="type">K</span> <span class="variable">entryKey</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">            <span class="keyword">if</span>(ObjectUtils.isNull(key, entryKey)</span><br><span class="line">            || key.equals(entryKey)) &#123;</span><br><span class="line">                entry.setValue(value);</span><br><span class="line">                <span class="keyword">if</span>(debugMode) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;put 为替换元素，table 信息为：&quot;</span>);</span><br><span class="line">                    printTable();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        createNewEntry(hash, idx, key, value);</span><br><span class="line">        size++;</span><br><span class="line">        <span class="keyword">if</span>(debugMode) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;put 为新增元素，table 信息为：&quot;</span>);</span><br><span class="line">            printTable();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">createNewEntry</span><span class="params">(<span class="type">int</span> hash, <span class="type">int</span> idx, K key, V value)</span> &#123;</span><br><span class="line">        Entry&lt;K, V&gt; entry = <span class="keyword">new</span> <span class="title class_">DefaultEntry</span>&lt;&gt;(key, value, hash);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断扩容</span></span><br><span class="line">        <span class="keyword">if</span>(isNeedSpand()) &#123;</span><br><span class="line">            <span class="built_in">this</span>.capacity = capacity * <span class="number">2</span>;</span><br><span class="line">            rehash(capacity);</span><br><span class="line">            <span class="comment">//更新新的下标</span></span><br><span class="line">            idx = (capacity - <span class="number">1</span>) &amp; hash;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//添加元素</span></span><br><span class="line">        List&lt;Entry&lt;K, V&gt;&gt; entries = table.get(idx);</span><br><span class="line">        entries.add(entry);</span><br><span class="line">        <span class="keyword">if</span>(debugMode) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;Key: &#123;&#125; 对应的 tableIndex: &#123;&#125;&quot;</span>, key, idx);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.table.set(idx, entries);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isNeedSpand</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (size * <span class="number">1.0</span> / capacity) &gt;= factor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">printTable</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span>(List&lt;Entry&lt;K, V&gt;&gt; list : <span class="built_in">this</span>.table) &#123;</span><br><span class="line">            <span class="keyword">for</span>(Entry&lt;K,V&gt; entry : list) &#123;</span><br><span class="line">                System.out.print(entry + <span class="string">&quot; &quot;</span>) ;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">rehash</span><span class="params">(<span class="type">int</span> newCapacity)</span> &#123;</span><br><span class="line">        <span class="comment">//1. 初始化</span></span><br><span class="line">        List&lt;List&lt;Entry&lt;K, V&gt;&gt;&gt; newTable = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(newCapacity);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; newCapacity; i++) &#123;</span><br><span class="line">            newTable.add(i,<span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.遍历原来元素</span></span><br><span class="line">        <span class="keyword">for</span>(List&lt;Entry&lt;K, V&gt;&gt; list : table) &#123;</span><br><span class="line">            <span class="keyword">for</span>(Entry&lt;K, V&gt; entry : list) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> HashUtils.hash(entry);</span><br><span class="line">                <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> (newCapacity - <span class="number">1</span>) &amp; hash;</span><br><span class="line">                <span class="comment">//  添加元素</span></span><br><span class="line">                <span class="comment">// 获取列表，避免数组越界</span></span><br><span class="line">                List&lt;Entry&lt;K,V&gt;&gt; newList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">                <span class="keyword">if</span>(index &lt; newTable.size()) &#123;</span><br><span class="line">                    newList = newTable.get(index);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 添加元素到列表</span></span><br><span class="line">                <span class="comment">// 元素不存在重复，所以不需要考虑更新</span></span><br><span class="line">                newList.add(entry);</span><br><span class="line">                newTable.set(index, newList);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.table = newTable;</span><br><span class="line">        <span class="keyword">if</span>(debugMode) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;rehash 新容量: &#123;&#125; 完成，table 内容为：&quot;</span>, newCapacity);</span><br><span class="line">            printTable();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Set&lt;Entry&lt;K, V&gt;&gt; <span class="title function_">entrySet</span><span class="params">()</span> &#123;</span><br><span class="line">        Set&lt;Entry&lt;K, V&gt;&gt; set = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span>(CollectionUtil.isEmpty(table)) &#123;</span><br><span class="line">            <span class="keyword">return</span> set;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (List&lt;Entry&lt;K, V&gt;&gt; entries : table) &#123;</span><br><span class="line">            <span class="keyword">if</span>(CollectionUtil.isNotEmpty(entries)) &#123;</span><br><span class="line">                set.addAll(entries);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> set;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> V <span class="title function_">remove</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> HashUtils.hash(key);</span><br><span class="line">        <span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> (capacity - <span class="number">1</span>) &amp; hash;</span><br><span class="line"></span><br><span class="line">        List&lt;Entry&lt;K, V&gt;&gt; entries = table.get(idx);</span><br><span class="line">        <span class="keyword">if</span>(CollectionUtil.isEmpty(entries)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CacheRuntimeException</span>(<span class="string">&quot;[ProgressiveRehashMap] 哈希桶为空，要删除的元素不存在！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">V</span> <span class="variable">removeValue</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (Entry&lt;K, V&gt; entry : entries) &#123;</span><br><span class="line">            <span class="type">K</span> <span class="variable">entryKey</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">            <span class="keyword">if</span>(ObjectUtils.isNull(key, entryKey) || key.equals(entryKey)) &#123;</span><br><span class="line">                entries.remove(entry);</span><br><span class="line">                removeValue = entry.getValue();</span><br><span class="line">                <span class="keyword">if</span> (debugMode) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;移除元素，table 信息为：&#123;&#125;&quot;</span>, entry);</span><br><span class="line">                    printTable();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(isNeedReduce()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (debugMode) &#123;</span><br><span class="line">                        log.debug(<span class="string">&quot;触发缩容操作&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    capacity = capacity &gt;&gt; <span class="number">1</span>;</span><br><span class="line">                    rehash(capacity);</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> removeValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isNeedReduce</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (size * <span class="number">1.0</span> / capacity) &lt;= reduceFactor &amp;&amp; (capacity &gt;= MIN_CAPACITY);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>rehash流程</strong></p>
<ol type="1">
<li>创建新table，大小为原来的两倍，并且初始化</li>
<li>遍历原来的元素，重新 hash 计算下标之后，放到新的 table 中</li>
<li>将 table 赋值为新的 table 信息。</li>
</ol>
<h1 id="扩容缩容rehash">扩容缩容rehash</h1>
<p>rehash：扩容时，重新计算容量，并将之前的元素，重新计算哈希值并且重新找到新的位置。</p>
<h2 id="redis扩容缩容机制">redis扩容缩容机制</h2>
<p>redis 的 rehash 动作并不是一次性、集中式地完成的，
而是<strong>分多次、渐进式地完成的</strong>。</p>
<h3 id="渐进式rehash">渐进式rehash</h3>
<p>redis内部维护两个hashtable，ht[0]、ht[1]，hash[0]是正在使用的。具体rehash步骤如下：</p>
<ol type="1">
<li>为ht[1] 分配空间，让字典同时持有 ht[0] 和ht[1] 两个哈希表</li>
<li>在字典中维持一个索引计数器变量 <code>rehashidx</code>
，初始为0，表示rehash工作正式开始</li>
<li>rehash期间，程序进行CRUD时，除了完成指定的操作以外，还要将 ht[0]
哈希表在 <code>rehashidx</code> 索引上的键值对 rehash 到ht[1]，当 rehash
工作完成之后， 程序将 rehashidx 属性的值增1。</li>
<li>随着字典操作的不断执行， 最终在某个时间点上， ht[0]
的所有键值对都会被 rehash 至 ht[1] ， 这时程序将 <code>rehashidx</code>
属性的值设为 -1 ， 表示 rehash 操作已完成。</li>
</ol>
<p>渐进式 rehash 的好处在于它采取<strong>分而治之</strong>的方式， 将
rehash
键值对所需的计算工作均滩到对字典的每个添加、删除、查找和更新操作上，
从而避免了集中式 rehash 而带来的庞大计算量。</p>
<p>那我基本的CRUD怎么兼容，两个表如何选择？</p>
<ol type="1">
<li>对于get：两个表都去查询</li>
<li>对于put：新数据添加到ht[1]</li>
<li>对于update：旧表新表同步更新，可能旧表的key已经迁移到新表，所以两个表都要更新，旧表更新完就等着被rehash即可</li>
</ol>
<h4 id="图解流程">图解流程</h4>
<p>1）准备 rehash</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/72ylNdFOwKCLKrhOedGTUaiaq4S1PEX2RcdIKbDibHw5DTlia8vnnavyzj2upxqJlYMft5oAwKRAaN8JWicbicMibBIg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片" style="zoom: 67%;" /></p>
<p>（2）rehash index=0</p>
<p><img src="渐进式redis缓存工具Vedis/640-17027982657691.png" alt="图片" style="zoom:67%;" /></p>
<p>（3）rehash index=1</p>
<p><img src="渐进式redis缓存工具Vedis/640-17027982657692.png" alt="图片" style="zoom:67%;" /></p>
<p>（4）rehash index=2</p>
<p><img src="渐进式redis缓存工具Vedis/640-17027982657693.png" alt="图片" style="zoom:67%;" /></p>
<p>（5）rehash index=3</p>
<p><img src="渐进式redis缓存工具Vedis/640-17027982657694.png" alt="图片" style="zoom:67%;" /></p>
<p>（6）rehash 完成</p>
<p><img src="渐进式redis缓存工具Vedis/640-17027982657695.png" alt="图片" style="zoom:67%;" /></p>
<h4 id="扩容条件">扩容条件</h4>
<p>哈希表的负载因子超过某个值</p>
<p>扩容的大小：原来的两倍。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Expand the hash table if needed */</span></span><br><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="title function_">_dictExpandIfNeeded</span><span class="params">(dict *d)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* Incremental rehashing already in progress. Return. */</span></span><br><span class="line">    <span class="comment">// 如果正在进行渐进式扩容，则返回OK</span></span><br><span class="line">    <span class="keyword">if</span> (dictIsRehashing(d)) <span class="keyword">return</span> DICT_OK;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If the hash table is empty expand it to the initial size. */</span></span><br><span class="line">    <span class="comment">// 如果哈希表ht[0]的大小为0，则初始化字典</span></span><br><span class="line">    <span class="keyword">if</span> (d-&gt;ht[<span class="number">0</span>].size == <span class="number">0</span>) <span class="keyword">return</span> dictExpand(d, DICT_HT_INITIAL_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If we reached the 1:1 ratio, and we are allowed to resize the hash</span></span><br><span class="line"><span class="comment">     * table (global setting) or we should avoid it but the ratio between</span></span><br><span class="line"><span class="comment">     * elements/buckets is over the &quot;safe&quot; threshold, we resize doubling</span></span><br><span class="line"><span class="comment">     * the number of buckets. */</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 如果哈希表ht[0]中保存的key个数与哈希表大小的比例已经达到1:1，即保存的节点数已经大于哈希表大小</span></span><br><span class="line"><span class="comment">     * 且redis服务当前允许执行rehash，或者保存的节点数与哈希表大小的比例超过了安全阈值（默认值为5）</span></span><br><span class="line"><span class="comment">     * 则将哈希表大小扩容为原来的两倍</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (d-&gt;ht[<span class="number">0</span>].used &gt;= d-&gt;ht[<span class="number">0</span>].size &amp;&amp;</span><br><span class="line">        (dict_can_resize ||</span><br><span class="line">         d-&gt;ht[<span class="number">0</span>].used/d-&gt;ht[<span class="number">0</span>].size &gt; dict_force_resize_ratio))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> dictExpand(d, d-&gt;ht[<span class="number">0</span>].used*<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> DICT_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（1）服务器目前没有在执行 BGSAVE/BGREWRITEAOF 命令，
并且哈希表的负载因子大于等于 1；</p>
<p>（2）服务器目前正在执行 BGSAVE/BGREWRITEAOF 命令，
并且哈希表的负载因子大于等于 5；</p>
<p>这里其实体现了作者的一种设计思想：如果负载因子超过5，说明信息已经很多了，管你在不在保存，都要执行扩容，优先保证服务可用性。如果没那么高，那就等持久化完成再做
rehash。</p>
<h4 id="缩容条件">缩容条件</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* If the percentage of used slots in the HT reaches HASHTABLE_MIN_FILL</span></span><br><span class="line"><span class="comment"> * we resize the hash table to save memory */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">tryResizeHashTables</span><span class="params">(<span class="type">int</span> dbid)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (htNeedsResize(server.db[dbid].dict))</span><br><span class="line">        dictResize(server.db[dbid].dict);</span><br><span class="line">    <span class="keyword">if</span> (htNeedsResize(server.db[dbid].expires))</span><br><span class="line">        dictResize(server.db[dbid].expires);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Hash table parameters */</span></span><br><span class="line">#define HASHTABLE_MIN_FILL        <span class="number">10</span>      <span class="comment">/* Minimal hash table fill 10% */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">htNeedsResize</span><span class="params">(dict *dict)</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> size, used;</span><br><span class="line"></span><br><span class="line">    size = dictSlots(dict);</span><br><span class="line">    used = dictSize(dict);</span><br><span class="line">    <span class="keyword">return</span> (size &gt; DICT_HT_INITIAL_SIZE &amp;&amp;</span><br><span class="line">            (used*<span class="number">100</span>/size &lt; HASHTABLE_MIN_FILL));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Resize the table to the minimal size that contains all the elements,</span></span><br><span class="line"><span class="comment"> * but with the invariant of a USED/BUCKETS ratio near to &lt;= 1 */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">dictResize</span><span class="params">(dict *d)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> minimal;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!dict_can_resize || dictIsRehashing(d)) <span class="keyword">return</span> DICT_ERR;</span><br><span class="line">    minimal = d-&gt;ht[<span class="number">0</span>].used;</span><br><span class="line">    <span class="keyword">if</span> (minimal &lt; DICT_HT_INITIAL_SIZE)</span><br><span class="line">        minimal = DICT_HT_INITIAL_SIZE;</span><br><span class="line">    <span class="keyword">return</span> dictExpand(d, minimal);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>缩容到多少？</p>
<p><strong>缩容后的大小为第一个大于等于当前key数量的2的n次方。</strong></p>
<h2 id="实现-10">实现</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProgressiveRehashMap</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">AbstractMap</span>&lt;K,V&gt; <span class="keyword">implements</span> <span class="title class_">Map</span>&lt;K,V&gt;&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> capacity;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> <span class="variable">factor</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;List&lt;Entry&lt;K,V&gt;&gt;&gt; table;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;List&lt;Entry&lt;K,V&gt;&gt;&gt; rehashTable;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> rehashIdx;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处于 rehash 状态的  新哈希表容量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> rehashCapacity;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">debugMode</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> <span class="variable">reduceFactor</span> <span class="operator">=</span> <span class="number">0.5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">MIN_CAPACITY</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">DefaultEntry</span>&lt;K,V&gt; <span class="keyword">implements</span> <span class="title class_">Map</span>.Entry&lt;K,V&gt; &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> hash;</span><br><span class="line">        <span class="keyword">final</span> K key;</span><br><span class="line">        V value;</span><br><span class="line">        ProgressiveRehashMap.DefaultEntry&lt;K,V&gt; next;</span><br><span class="line"></span><br><span class="line">        DefaultEntry(<span class="type">int</span> hash, K key, V value, ProgressiveRehashMap.DefaultEntry&lt;K,V&gt; next) &#123;</span><br><span class="line">            <span class="built_in">this</span>.hash = hash;</span><br><span class="line">            <span class="built_in">this</span>.key = key;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">            <span class="built_in">this</span>.next = next;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        DefaultEntry(K key, V value, <span class="type">int</span> hash) &#123;</span><br><span class="line">            <span class="built_in">this</span>.key = key;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">            <span class="built_in">this</span>.hash = hash;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> K <span class="title function_">getKey</span><span class="params">()</span>         &#123; <span class="keyword">return</span> key; &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> V <span class="title function_">getValue</span><span class="params">()</span>      &#123; <span class="keyword">return</span> value; &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Objects.hashCode(key) ^ Objects.hashCode(value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> V <span class="title function_">setValue</span><span class="params">(V newValue)</span> &#123;</span><br><span class="line">            <span class="type">V</span> <span class="variable">oldValue</span> <span class="operator">=</span> value;</span><br><span class="line">            value = newValue;</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="meta">@SuppressWarnings(value = &quot;all&quot;)</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (o == <span class="built_in">this</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (o <span class="keyword">instanceof</span> Map.Entry) &#123;</span><br><span class="line">                Map.Entry&lt;?,?&gt; e = (Map.Entry&lt;?,?&gt;)o;</span><br><span class="line">                <span class="keyword">if</span> (Objects.equals(key, e.getKey()) &amp;&amp;</span><br><span class="line">                        Objects.equals(value, e.getValue()))</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&#123;&quot;</span> +key +</span><br><span class="line">                    <span class="string">&quot;: &quot;</span> + value +</span><br><span class="line">                    <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ProgressiveRehashMap</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(<span class="number">8</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ProgressiveRehashMap</span><span class="params">(<span class="type">int</span> capacity)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(capacity, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ProgressiveRehashMap</span><span class="params">(<span class="type">int</span> capacity, <span class="type">boolean</span> debugMode)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(capacity &lt; MIN_CAPACITY) &#123;</span><br><span class="line">            capacity = MIN_CAPACITY;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.capacity = capacity;</span><br><span class="line">        table = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(capacity);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; capacity; i++) &#123;</span><br><span class="line">            table.add(i, <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;Entry&lt;K,V&gt;&gt;());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.debugMode = debugMode;</span><br><span class="line"></span><br><span class="line">        rehashIdx = -<span class="number">1</span>;</span><br><span class="line">        rehashCapacity = -<span class="number">1</span>;</span><br><span class="line">        rehashTable = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">        <span class="comment">//判断是否需要更新</span></span><br><span class="line">        <span class="keyword">if</span>(isInRehash()) &#123;</span><br><span class="line">            <span class="keyword">if</span>(debugMode) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;当前处于渐进式 rehash 阶段，额外执行一次渐进式 rehash 的动作&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            rehashToNewTable();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//原table更新</span></span><br><span class="line">            Pair&lt;Boolean, V&gt; pair1 = update(key, value, table, capacity);</span><br><span class="line">            <span class="keyword">if</span>(pair1.getValueOne()) &#123;</span><br><span class="line">                <span class="type">V</span> <span class="variable">oldVal</span> <span class="operator">=</span> pair1.getValueTwo();</span><br><span class="line">                <span class="keyword">if</span>(debugMode) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;此次为更新 table 操作。key: &#123;&#125;, value: &#123;&#125;&quot;</span>, key, value);</span><br><span class="line">                    printTable(<span class="built_in">this</span>.table);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> oldVal;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//新table更新</span></span><br><span class="line">            Pair&lt;Boolean, V&gt; pair2 = update(key, value, rehashTable, rehashCapacity);</span><br><span class="line">            <span class="keyword">if</span>(pair2.getValueOne()) &#123;</span><br><span class="line">                <span class="type">V</span> <span class="variable">oldVal</span> <span class="operator">=</span> pair2.getValueTwo();</span><br><span class="line">                <span class="keyword">if</span>(debugMode) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;此次为更新 rehashTable 操作。key: &#123;&#125;, value: &#123;&#125;&quot;</span>, key, value);</span><br><span class="line">                    printTable(<span class="built_in">this</span>.table);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> oldVal;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//原table更新</span></span><br><span class="line">            Pair&lt;Boolean, V&gt; pair1 = update(key, value, table, capacity);</span><br><span class="line">            <span class="keyword">if</span>(pair1.getValueOne()) &#123;</span><br><span class="line">                <span class="type">V</span> <span class="variable">oldVal</span> <span class="operator">=</span> pair1.getValueTwo();</span><br><span class="line">                <span class="keyword">if</span>(debugMode) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;此次为更新 table 操作。key: &#123;&#125;, value: &#123;&#125;&quot;</span>, key, value);</span><br><span class="line">                    printTable(<span class="built_in">this</span>.table);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> oldVal;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> createNewEntry(key, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return  Pair二元组  1. 为true就是更新操作，否则就是新增操作</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Pair&lt;Boolean, V&gt; <span class="title function_">update</span><span class="params">(K key, V value, List&lt;List&lt;Entry&lt;K,V&gt;&gt;&gt; table, <span class="type">int</span> capacity)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> HashUtils.hash(key);</span><br><span class="line">        <span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> (capacity - <span class="number">1</span>) &amp; hash;</span><br><span class="line"></span><br><span class="line">        List&lt;Entry&lt;K, V&gt;&gt; entries = table.get(idx);</span><br><span class="line">        <span class="comment">//遍历链表，查看key是否已存在</span></span><br><span class="line">        <span class="keyword">for</span> (Entry&lt;K, V&gt; entry : entries) &#123;</span><br><span class="line">            <span class="type">K</span> <span class="variable">entryKey</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">            <span class="type">V</span> <span class="variable">oldValue</span> <span class="operator">=</span> entry.getValue();</span><br><span class="line">            <span class="keyword">if</span>(ObjectUtils.isNull(key, entryKey)</span><br><span class="line">                    || key.equals(entryKey)) &#123;</span><br><span class="line">                entry.setValue(value);</span><br><span class="line">                <span class="keyword">if</span>(debugMode) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;put 为替换元素，table 信息为：&quot;</span>);</span><br><span class="line">                    printTable(table);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> Pair.of(<span class="literal">true</span>, oldValue);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Pair.of(<span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isInRehash</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> rehashIdx != -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param  新增结点到map中</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> V <span class="title function_">createNewEntry</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> HashUtils.hash(key);</span><br><span class="line">        Entry&lt;K, V&gt; entry = <span class="keyword">new</span> <span class="title class_">DefaultEntry</span>&lt;&gt;(key, value, hash);</span><br><span class="line">        <span class="keyword">if</span>(isInRehash()) &#123;</span><br><span class="line">            <span class="comment">//新结点添加到新table</span></span><br><span class="line">            addNewEntryToRehashTable(hash,  entry);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//不在rehash阶段</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(isNeedExpand()) &#123;</span><br><span class="line">            <span class="comment">//旧的table已经不够了</span></span><br><span class="line">            rehash(capacity &lt;&lt; <span class="number">1</span>);</span><br><span class="line">            addNewEntryToRehashTable(hash, entry);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            addNewEntryToTable(hash, entry);</span><br><span class="line">        &#125;</span><br><span class="line">        size++;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addNewEntryToTable</span><span class="params">(<span class="type">int</span> hash, Entry&lt;K,V&gt; entry)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> (capacity - <span class="number">1</span>) &amp; hash;</span><br><span class="line">        List&lt;Entry&lt;K, V&gt;&gt; entries = table.get(idx);</span><br><span class="line">        entries.add(entry );</span><br><span class="line">        <span class="keyword">if</span>(debugMode) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;目前不处于 rehash 中，元素直接插入到 table 中。&quot;</span>);</span><br><span class="line">            printTable(<span class="built_in">this</span>.table);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addNewEntryToRehashTable</span><span class="params">(<span class="type">int</span> hash, Entry&lt;K, V&gt; entry)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> (rehashCapacity - <span class="number">1</span>) &amp; hash;</span><br><span class="line">        List&lt;Entry&lt;K, V&gt;&gt; entries = rehashTable.get(idx);</span><br><span class="line">        entries.add(entry);</span><br><span class="line">        <span class="keyword">if</span> (debugMode) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;目前处于 rehash 中，元素直接插入到 rehashTable 中。&quot;</span>);</span><br><span class="line">            printTable(<span class="built_in">this</span>.rehashTable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isNeedExpand</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (size * <span class="number">1.0</span> / capacity) &gt;= factor &amp;&amp; !isInRehash();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">printTable</span><span class="params">(List&lt;List&lt;Entry&lt;K,V&gt;&gt;&gt; table)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span>(List&lt;Entry&lt;K, V&gt;&gt; list : table) &#123;</span><br><span class="line">            <span class="keyword">for</span>(Entry&lt;K,V&gt; entry : list) &#123;</span><br><span class="line">                System.out.print(entry + <span class="string">&quot; &quot;</span>) ;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">printAllTable</span><span class="params">()</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;[printAllTable] 打印table -----------------&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(List&lt;Entry&lt;K, V&gt;&gt; list : <span class="built_in">this</span>.table) &#123;</span><br><span class="line">            <span class="keyword">for</span>(Entry&lt;K,V&gt; entry : list) &#123;</span><br><span class="line">                System.out.print(entry + <span class="string">&quot; &quot;</span>) ;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println();</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;[printAllTable] 打印rehashTable -----------&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(List&lt;Entry&lt;K, V&gt;&gt; list : <span class="built_in">this</span>.rehashTable) &#123;</span><br><span class="line">            <span class="keyword">for</span>(Entry&lt;K,V&gt; entry : list) &#123;</span><br><span class="line">                System.out.print(entry + <span class="string">&quot; &quot;</span>) ;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">rehash</span><span class="params">(<span class="type">int</span> rehashCapacity)</span> &#123;</span><br><span class="line">        <span class="comment">//1. 判断是否处于rehash阶段  处于，直接返回</span></span><br><span class="line">        <span class="keyword">if</span>(isInRehash()) &#123;</span><br><span class="line">            <span class="keyword">if</span>(debugMode) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;当前处于渐进式 rehash 阶段，不能重复进行 rehash!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//2. 创建新的rehashtable</span></span><br><span class="line">        <span class="built_in">this</span>.rehashCapacity = rehashCapacity;</span><br><span class="line">        rehashTable = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="built_in">this</span>.rehashCapacity);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; rehashCapacity; i++) &#123;</span><br><span class="line">            rehashTable.add(i,<span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//3. 先将table[0]的数据  rehash到 新表中   然后table[0]设置为空</span></span><br><span class="line">        rehashToNewTable();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">rehashToNewTable</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(!isInRehash()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//添加到新table</span></span><br><span class="line">        rehashIdx++;</span><br><span class="line">        List&lt;Entry&lt;K, V&gt;&gt; entries = table.get(rehashIdx);</span><br><span class="line">        <span class="keyword">for</span> (Entry&lt;K, V&gt; entry : entries) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> HashUtils.hash(entry.getKey());</span><br><span class="line">            <span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> hash &amp; (rehashCapacity - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            List&lt;Entry&lt;K, V&gt;&gt; entryList = rehashTable.get(idx);</span><br><span class="line">            entryList.add(entry);</span><br><span class="line">            rehashTable.set(idx, entryList);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//清空旧table</span></span><br><span class="line">        table.remove(rehashIdx);</span><br><span class="line">        <span class="comment">//判断是否结束rehash</span></span><br><span class="line">        <span class="keyword">if</span>(rehashIdx == table.size() - <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.capacity = <span class="built_in">this</span>.rehashCapacity;</span><br><span class="line">            <span class="built_in">this</span>.rehashCapacity = -<span class="number">1</span>;</span><br><span class="line">            <span class="built_in">this</span>.rehashIdx = -<span class="number">1</span>;</span><br><span class="line">            <span class="built_in">this</span>.table = rehashTable;</span><br><span class="line">            <span class="built_in">this</span>.rehashTable = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(debugMode) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;渐进式 rehash 已经完成。&quot;</span>);</span><br><span class="line">                printTable(<span class="built_in">this</span>.table);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(debugMode) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;渐进式 rehash 处理中, 目前 index：&#123;&#125; 已完成&quot;</span>, rehashIdx);</span><br><span class="line">                printAllTable();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Set&lt;Entry&lt;K, V&gt;&gt; <span class="title function_">entrySet</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(isInRehash()) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;调用entrySet，rehash中......&quot;</span>);</span><br><span class="line">            rehashToNewTable();</span><br><span class="line">        &#125;</span><br><span class="line">        Set&lt;Entry&lt;K, V&gt;&gt; set = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span>(CollectionUtil.isEmpty(table) &amp;&amp; CollectionUtil.isEmpty(rehashTable)) &#123;</span><br><span class="line">            <span class="keyword">return</span> set;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (List&lt;Entry&lt;K, V&gt;&gt; entries : table) &#123;</span><br><span class="line">            <span class="keyword">if</span>(CollectionUtil.isNotEmpty(entries)) &#123;</span><br><span class="line">                set.addAll(entries);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (List&lt;Entry&lt;K, V&gt;&gt; entries : rehashTable) &#123;</span><br><span class="line">            <span class="keyword">if</span>(CollectionUtil.isNotEmpty(entries)) &#123;</span><br><span class="line">                set.addAll(entries);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> set;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> V <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(isInRehash()) &#123;</span><br><span class="line">            <span class="keyword">if</span>(debugMode) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;当前处于渐进式 rehash 状态，额外执行一次操作&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            rehashToNewTable();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//从第一个table找</span></span><br><span class="line">        <span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> getValue((K) key, table, capacity);</span><br><span class="line">        <span class="keyword">if</span>(value != <span class="literal">null</span>) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;[get] 从table中找到对应的key : &#123;&#125;，返回value : &#123;&#125;&quot;</span>, key,value);</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//从rehashtable找</span></span><br><span class="line">        <span class="keyword">if</span> (isInRehash()) &#123;</span><br><span class="line">            <span class="type">V</span> <span class="variable">value1</span> <span class="operator">=</span> getValue((K) key, rehashTable, rehashCapacity);</span><br><span class="line">            <span class="keyword">if</span>(value1 != <span class="literal">null</span>) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;[get] 从rehashTable中找到对应的key : &#123;&#125;，返回value : &#123;&#125;&quot;</span>, key,value1);</span><br><span class="line">                <span class="keyword">return</span> value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> V <span class="title function_">getValue</span><span class="params">(K key, List&lt;List&lt;Entry&lt;K,V&gt;&gt;&gt; table, <span class="type">int</span> capacity)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> HashUtils.hash(key);</span><br><span class="line">        <span class="type">int</span> <span class="variable">idx1</span> <span class="operator">=</span> (capacity - <span class="number">1</span>) &amp; hash;</span><br><span class="line">        List&lt;Entry&lt;K, V&gt;&gt; entryList = table.get(idx1);</span><br><span class="line">        <span class="keyword">for</span> (Entry&lt;K, V&gt; entry : entryList) &#123;</span><br><span class="line">            <span class="type">K</span> <span class="variable">entryKey</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">            <span class="keyword">if</span>(ObjectUtils.isNull(key, entryKey) || key.equals(entryKey)) &#123;</span><br><span class="line">                <span class="keyword">return</span> entry.getValue();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> V <span class="title function_">remove</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(isInRehash()) &#123;</span><br><span class="line">            <span class="keyword">if</span>(debugMode) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;当前处于渐进式 rehash 状态，额外执行一次操作&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            rehashToNewTable();</span><br><span class="line"></span><br><span class="line">            <span class="type">V</span> <span class="variable">removeValue</span> <span class="operator">=</span> removeFromTable((K) key, table, capacity);</span><br><span class="line">            <span class="keyword">if</span>(removeValue != <span class="literal">null</span>) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;[remove] 从table中找到对应的key : &#123;&#125;，删除value : &#123;&#125;&quot;</span>, key,removeValue);</span><br><span class="line">                <span class="keyword">return</span> removeValue;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            removeValue = removeFromTable((K) key, rehashTable, rehashCapacity);</span><br><span class="line">            <span class="keyword">if</span>(removeValue != <span class="literal">null</span>) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;[remove] 从rehashTable中找到对应的key : &#123;&#125;，删除value : &#123;&#125;&quot;</span>, key,removeValue);</span><br><span class="line">                <span class="keyword">return</span> removeValue;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(isNeedReduce()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (debugMode) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;触发缩容操作&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            capacity = capacity &gt;&gt; <span class="number">1</span>;</span><br><span class="line">            rehash(capacity);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">V</span> <span class="variable">removeValue</span> <span class="operator">=</span> removeFromTable((K) key, table, capacity);</span><br><span class="line">            <span class="keyword">if</span>(removeValue != <span class="literal">null</span>) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;[remove] 从table中找到对应的key : &#123;&#125;，删除value : &#123;&#125;&quot;</span>, key,removeValue);</span><br><span class="line">                <span class="keyword">return</span> removeValue;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> V <span class="title function_">removeFromTable</span><span class="params">(K key, List&lt;List&lt;Entry&lt;K,V&gt;&gt;&gt; table, <span class="type">int</span> capacity)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> HashUtils.hash(key);</span><br><span class="line">        <span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> (capacity - <span class="number">1</span>) &amp; hash;</span><br><span class="line"></span><br><span class="line">        List&lt;Entry&lt;K, V&gt;&gt; entries = table.get(idx);</span><br><span class="line">        <span class="keyword">if</span>(CollectionUtil.isEmpty(entries)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CacheRuntimeException</span>(<span class="string">&quot;[remove] 哈希桶为空，要删除的元素不存在！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">V</span> <span class="variable">removeValue</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (Entry&lt;K, V&gt; entry : entries) &#123;</span><br><span class="line">            <span class="type">K</span> <span class="variable">entryKey</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">            <span class="keyword">if</span>(ObjectUtils.isNull(key, entryKey) || key.equals(entryKey)) &#123;</span><br><span class="line">                entries.remove(entry);</span><br><span class="line">                removeValue = entry.getValue();</span><br><span class="line">                <span class="keyword">if</span> (debugMode) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;移除元素，table 信息为：&#123;&#125;&quot;</span>, entry);</span><br><span class="line">                    printTable(table);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> removeValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isNeedReduce</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (size * <span class="number">1.0</span> / capacity) &lt;= reduceFactor &amp;&amp; (capacity &gt;= MIN_CAPACITY) &amp;&amp; !isInRehash();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="测试">测试</h1>
<h2 id="固定大小缓存">固定大小缓存</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 大小指定测试</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 0.0.2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">helloTest</span><span class="params">()</span> &#123;</span><br><span class="line">    ICache&lt;String, String&gt; cache = CacheGuide.&lt;String,String&gt;newInstance()</span><br><span class="line">            .sizeLimit(<span class="number">2</span>)</span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line">    cache.put(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">    cache.put(<span class="string">&quot;2&quot;</span>, <span class="string">&quot;2&quot;</span>);</span><br><span class="line">    cache.put(<span class="string">&quot;3&quot;</span>, <span class="string">&quot;3&quot;</span>);</span><br><span class="line">    cache.put(<span class="string">&quot;4&quot;</span>, <span class="string">&quot;4&quot;</span>);</span><br><span class="line"></span><br><span class="line">    Assert.assertEquals(<span class="number">2</span>, cache.size());</span><br><span class="line">    System.out.println(cache.keySet());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="expire">expire</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 过期测试</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 0.0.3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">expireTest</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    ICache&lt;String, String&gt; cache = CacheGuide.&lt;String,String&gt;newInstance()</span><br><span class="line">            .sizeLimit(<span class="number">3</span>)</span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line">    cache.put(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">    cache.put(<span class="string">&quot;2&quot;</span>, <span class="string">&quot;2&quot;</span>);</span><br><span class="line"></span><br><span class="line">    cache.expire(<span class="string">&quot;1&quot;</span>, <span class="number">50</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">    System.out.println(cache.keySet());</span><br><span class="line">    Assert.assertEquals(<span class="number">2</span>, cache.size());</span><br><span class="line"></span><br><span class="line">    TimeUnit.MILLISECONDS.sleep(<span class="number">200</span>);</span><br><span class="line">    Assert.assertEquals(<span class="number">1</span>, cache.size());</span><br><span class="line">    System.out.println(cache.keySet());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="持久化-1">持久化</h2>
<h3 id="rdb-1">RDB</h3>
<p>自定义加载类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//真正实现的时候，要把泛型具体化</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyCacheLoad</span> <span class="keyword">implements</span> <span class="title class_">ICacheLoad</span>&lt;String,String&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">load</span><span class="params">(ICache&lt;String, String&gt; cache)</span> &#123;</span><br><span class="line">        cache.put(<span class="string">&quot;mhd&quot;</span>, <span class="string">&quot;mhd&quot;</span>);</span><br><span class="line">        cache.put(<span class="string">&quot;cml&quot;</span>, <span class="string">&quot;cml&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>cache设置初始化方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">this</span>.cacheExpire = <span class="keyword">new</span> <span class="title class_">CacheExpire</span>&lt;&gt;(<span class="built_in">this</span>);</span><br><span class="line">    <span class="built_in">this</span>.load.load(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.persist != <span class="literal">null</span> &amp;&amp; !(<span class="built_in">this</span>.persist <span class="keyword">instanceof</span> CachePersistNone))&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InnerCachePersist</span>(<span class="built_in">this</span>, persist);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">rdbTest</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    ICache&lt;String, String&gt; cache = CacheGuide.&lt;String, String&gt;newInstance()</span><br><span class="line">            .load(<span class="keyword">new</span> <span class="title class_">MyCacheLoad</span>())</span><br><span class="line">            .persist(CachePersists.&lt;String, String&gt;fileJson(<span class="string">&quot;test1.rdb&quot;</span>))</span><br><span class="line">            .build();</span><br><span class="line">    Assert.assertEquals(<span class="number">2</span>, cache.size());</span><br><span class="line">    TimeUnit.SECONDS.sleep(<span class="number">120</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="测试bug">测试bug</h4>
<h5 id="创建文件失败">创建文件失败</h5>
<p>原因：</p>
<figure>
<img src="渐进式redis缓存工具Vedis/image-20231206164045568.png"
alt="image-20231206164045568" />
<figcaption aria-hidden="true">image-20231206164045568</figcaption>
</figure>
<p>这个dir为空，后面无法进行。</p>
<p>本质原因：filePath设置的是单独的文件名，可能无法解析</p>
<p>解决方式：</p>
<figure>
<img src="渐进式redis缓存工具Vedis/image-20231206165254938.png"
alt="image-20231206165254938" />
<figcaption aria-hidden="true">image-20231206165254938</figcaption>
</figure>
<p>把创建文件夹注释掉，因为默认输入单独的文件名会生成在项目文件夹下</p>
<h3 id="aof-1">AOF</h3>
<p>测试代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">aofTest</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    ICache&lt;String, String&gt; cache = CacheGuide.&lt;String,String&gt;newInstance()</span><br><span class="line">            .persist(CachePersists.&lt;String, String&gt;aof(<span class="string">&quot;1.aof&quot;</span>))</span><br><span class="line">            .build();</span><br><span class="line">    cache.put(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">    cache.expireAt(<span class="string">&quot;1&quot;</span>, <span class="number">10</span>);</span><br><span class="line">    cache.remove(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    TimeUnit.SECONDS.sleep(<span class="number">100</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="evict-1">evict</h2>
<h3 id="lru策略">LRU策略</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lruTest</span><span class="params">()</span> &#123;</span><br><span class="line">        ICache&lt;String, String&gt; cache = CacheGuide.&lt;String,String&gt;newInstance()</span><br><span class="line">                .sizeLimit(<span class="number">3</span>)</span><br><span class="line">                .evict(CacheEvicts.&lt;String, String&gt;lru())</span><br><span class="line">                .build();</span><br><span class="line">        cache.put(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        cache.put(<span class="string">&quot;B&quot;</span>, <span class="string">&quot;world&quot;</span>);</span><br><span class="line">        cache.put(<span class="string">&quot;C&quot;</span>, <span class="string">&quot;FIFO&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 访问一次A</span></span><br><span class="line">        cache.get(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">        cache.put(<span class="string">&quot;D&quot;</span>, <span class="string">&quot;LRU&quot;</span>);</span><br><span class="line">        Assert.assertEquals(<span class="number">3</span>, cache.size());</span><br><span class="line"></span><br><span class="line">        System.out.println(cache.keySet());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="测试bug-1">测试bug</h4>
<h5 id="lru的list不会自动清除淘汰key">lru的list不会自动清除淘汰key</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lruTest</span><span class="params">()</span> &#123;</span><br><span class="line">        ICache&lt;String, String&gt; cache = CacheGuide.&lt;String,String&gt;newInstance()</span><br><span class="line">                .sizeLimit(<span class="number">3</span>)</span><br><span class="line">                .evict(CacheEvicts.&lt;String, String&gt;lru())</span><br><span class="line">                .build();</span><br><span class="line">        cache.put(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        cache.put(<span class="string">&quot;B&quot;</span>, <span class="string">&quot;world&quot;</span>);</span><br><span class="line">        cache.put(<span class="string">&quot;C&quot;</span>, <span class="string">&quot;FIFO&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 访问一次A</span></span><br><span class="line">        cache.get(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">        System.out.println(cache.keySet());</span><br><span class="line">        cache.put(<span class="string">&quot;D&quot;</span>, <span class="string">&quot;LRU&quot;</span>);</span><br><span class="line">        cache.put(<span class="string">&quot;E&quot;</span>, <span class="string">&quot;LRU&quot;</span>);</span><br><span class="line">        Assert.assertEquals(<span class="number">3</span>, cache.size());</span><br><span class="line"></span><br><span class="line">        System.out.println(cache.keySet());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>具体错误：添加E的时候，报出了无法添加异常。</p>
<p>具体原因是，lru里的list，再添加完D之后，还存在B这个key，也就是说，添加D
的时候，没有走下面这个逻辑：</p>
<figure>
<img src="渐进式redis缓存工具Vedis/image-20231210170743556.png"
alt="image-20231210170743556" />
<figcaption aria-hidden="true">image-20231210170743556</figcaption>
</figure>
<p>本质就是拦截器没触发：</p>
<figure>
<img src="渐进式redis缓存工具Vedis/image-20231210170818025.png"
alt="image-20231210170818025" />
<figcaption aria-hidden="true">image-20231210170818025</figcaption>
</figure>
<p>拦截器不起作用，原因只有一个，代理失效，为什么代理失效，就是执行remove方法的cache：</p>
<figure>
<img src="渐进式redis缓存工具Vedis/image-20231210170855247.png"
alt="image-20231210170855247" />
<figcaption aria-hidden="true">image-20231210170855247</figcaption>
</figure>
<p>其实不是代理对象，就是本来的cache对象。</p>
<p>暂时没有关于代理的修正方案</p>
<p>我的改正方案：</p>
<figure>
<img src="渐进式redis缓存工具Vedis/image-20231210173330630.png"
alt="image-20231210173330630" />
<figcaption aria-hidden="true">image-20231210173330630</figcaption>
</figure>
<h2 id="淘汰策略-1">淘汰策略</h2>
<h3 id="lfu-1">lfu</h3>
<p>测试代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lfuTest</span><span class="params">()</span> &#123;</span><br><span class="line">        ICache&lt;String, String&gt; cache = CacheGuide.&lt;String,String&gt;newInstance()</span><br><span class="line">                .sizeLimit(<span class="number">3</span>)</span><br><span class="line">                .evict(CacheEvicts.&lt;String, String&gt;lfu())</span><br><span class="line">                .build();</span><br><span class="line">        cache.put(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        cache.get(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">        cache.get(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">        cache.put(<span class="string">&quot;B&quot;</span>, <span class="string">&quot;world&quot;</span>);</span><br><span class="line">        cache.get(<span class="string">&quot;B&quot;</span>);</span><br><span class="line">        cache.put(<span class="string">&quot;C&quot;</span>, <span class="string">&quot;bug&quot;</span>);</span><br><span class="line">        cache.put(<span class="string">&quot;D&quot;</span>, <span class="string">&quot;bug&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        cache.put(&quot;C&quot;, &quot;FIFO&quot;);</span></span><br><span class="line"><span class="comment">//// 访问一次A</span></span><br><span class="line"><span class="comment">//        cache.get(&quot;A&quot;);</span></span><br><span class="line"><span class="comment">//        cache.put(&quot;D&quot;, &quot;LRU&quot;);</span></span><br><span class="line"><span class="comment">//        cache.put(&quot;E&quot;, &quot;LRU&quot;);</span></span><br><span class="line"><span class="comment">//        cache.put(&quot;F&quot;, &quot;LRU&quot;);</span></span><br><span class="line"></span><br><span class="line">        Assert.assertEquals(<span class="number">3</span>, cache.size());</span><br><span class="line">        System.out.println(cache.keySet());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="测试bug-2">测试bug</h4>
<h5 id="lfu集合内存冗余">lfu集合内存冗余</h5>
<p>问题描述：</p>
<p>第二次<code>get("A")</code>以后，在lru的数据结构中，两个map需要更新，freqmap则是无法清除上一个集合的数据结点。</p>
<p>造成，freqMap频率为2 的列表和频率为3的列表，都包含
<code>&#123;FreqNode@1235&#125; "FreqNode&#123;key=A, value=null, frequency=3&#125;</code>这一数据对象，也就是之前的
<code>&#123;FreqNode@1235&#125; "FreqNode&#123;key=A, value=null, frequency=2&#125;</code>数据没删掉，分析原因，发现是freqNode类重写了hash方法，造成两个对象计算的哈希值不一致（时间戳问题？），删除失败，因此我们取消掉重写的hash方法即可。</p>
<h2 id="打包发布">打包发布</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">:: 用于 release 当前项目(windows)</span><br><span class="line">:: author: houbb</span><br><span class="line">:: LastUpdateTime:  <span class="number">2018</span>-<span class="number">1</span>-<span class="number">22</span> 09:08:<span class="number">52</span></span><br><span class="line">:: 用法：双击运行，或者当前路径 cmd 直接输入 release.bat</span><br><span class="line"></span><br><span class="line">:: 关闭回显</span><br><span class="line"><span class="meta">@echo</span> OFF</span><br><span class="line"></span><br><span class="line">ECHO <span class="string">&quot;============================= RELEASE START...&quot;</span></span><br><span class="line"></span><br><span class="line">:: 版本号信息(需要手动指定)</span><br><span class="line">:::: 旧版本名称</span><br><span class="line">SET version=<span class="number">0.0</span><span class="number">.9</span></span><br><span class="line">:::: 新版本名</span><br><span class="line">SET newVersion=<span class="number">0.0</span>。<span class="number">10</span></span><br><span class="line">:::: 组织名称</span><br><span class="line">SET groupName=com.vls</span><br><span class="line">:::: 项目名称</span><br><span class="line">SET projectName=vedis</span><br><span class="line"></span><br><span class="line">:: release 项目版本</span><br><span class="line">:::: snapshot 版本号</span><br><span class="line">SET snapshot_version=%version%<span class="string">&quot;-SNAPSHOT&quot;</span></span><br><span class="line">:::: 新的版本号</span><br><span class="line">SET release_version=%version%</span><br><span class="line"></span><br><span class="line">call mvn versions:set -DgroupId=%groupName% -DartifactId=%projectName% -DoldVersion=%snapshot_version% -DnewVersion=%release_version%</span><br><span class="line">call mvn -N versions:update-child-modules</span><br><span class="line">call mvn versions:commit</span><br><span class="line">call echo <span class="string">&quot;1. RELEASE %snapshot_version% TO %release_version% DONE.&quot;</span></span><br><span class="line"></span><br><span class="line">:: 发布到 mvn 中央仓库</span><br><span class="line">mvn clean deploy -P release</span><br><span class="line"></span><br><span class="line">ECHO <span class="string">&quot;2. PUSH TO MAVEN CENTER DONE.&quot;</span></span><br><span class="line"></span><br><span class="line">:: 合并到 master 分支</span><br><span class="line">:::: 分支名称</span><br><span class="line">::SET branchName=<span class="string">&quot;release_&quot;</span>%version%</span><br><span class="line">::git checkout master</span><br><span class="line">::git pull</span><br><span class="line">::git checkout %branchName%</span><br><span class="line">::git rebase master</span><br><span class="line">::git checkout master</span><br><span class="line">::git merge %branchName%</span><br><span class="line">::git push</span><br><span class="line">::</span><br><span class="line">::ECHO <span class="string">&quot;3. MERGE TO MASTER DONE.&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">:::: 拉取新的分支</span><br><span class="line">::SET newBranchName=<span class="string">&quot;release_&quot;</span>%newVersion%</span><br><span class="line">::git branch %newBranchName%</span><br><span class="line">::git checkout %newBranchName%</span><br><span class="line">::git push --set-upstream origin %newBranchName%</span><br><span class="line">::</span><br><span class="line">::ECHO <span class="string">&quot;4. NEW BRANCH DONE.&quot;</span></span><br><span class="line">::</span><br><span class="line">:::: 修改新分支的版本号</span><br><span class="line">::SET snapshot_new_version=%newVersion%<span class="string">&quot;-SNAPSHOT&quot;</span></span><br><span class="line">::call mvn versions:set -DgroupId=%groupName% -DartifactId=%projectName% -DoldVersion=%release_version% -DnewVersion=%snapshot_new_version%</span><br><span class="line">::call mvn -N versions:update-child-modules</span><br><span class="line">::call mvn versions:commit</span><br><span class="line">::</span><br><span class="line">::git add .</span><br><span class="line">::git commit -m <span class="string">&quot;modify branch %release_version% TO %snapshot_new_version%&quot;</span></span><br><span class="line">::git push</span><br><span class="line">::git status</span><br><span class="line">::ECHO <span class="string">&quot;5. MODIFY %release_version% TO %snapshot_new_version% DONE.&quot;</span></span><br><span class="line">::</span><br><span class="line">::ECHO <span class="string">&quot;============================= RELEASE END...&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>目前暂未发布</p>
<h1 id="工具类">工具类</h1>
<h2 id="文件">文件</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileUtils</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">createFile</span><span class="params">(String filePath)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtil.isEmpty(filePath)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (exists(filePath)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(filePath);</span><br><span class="line"><span class="comment">//            File dir = file.getParentFile();</span></span><br><span class="line"><span class="comment">//            if (notExists(dir)) &#123;</span></span><br><span class="line"><span class="comment">//                boolean mkdirResult = dir.mkdirs();</span></span><br><span class="line"><span class="comment">//                if (!mkdirResult) &#123;</span></span><br><span class="line"><span class="comment">//                    return false;</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> file.createNewFile();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException var4) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CommonRuntimeException</span>(var4);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">exists</span><span class="params">(String filePath, LinkOption... options)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtil.isEmpty(filePath)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">Path</span> <span class="variable">path</span> <span class="operator">=</span> Paths.get(filePath);</span><br><span class="line">            <span class="keyword">return</span> Files.exists(path, options);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">truncateFile</span><span class="params">(String filePath)</span>&#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span>  <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(filePath);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">FileWriter</span> <span class="variable">fileWriter</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">FileWriter</span>(file);</span><br><span class="line">            fileWriter.write(<span class="string">&quot;&quot;</span>);</span><br><span class="line">            fileWriter.flush();</span><br><span class="line">            fileWriter.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="面试">面试</h1>
<h2 id="项目整体介绍">项目整体介绍</h2>
<p>项目是用纯java写的，偏轮子项目，实现了基于内存，也就是java应用程序的缓存工具类，具备缓存的基本特性，底层采用多种淘汰算法、驱逐策略，支持持久化与日志监测机制，并且实现了扩容rehash的渐进式特性。项目应用到较多的设计模式，如策略模式、代理模式、构建者模式，利用构建者模式的特性，保证一个流式编程体验。</p>
<h2 id="过期特性">过期特性</h2>
<p>过期的定义：我的cache中，有两个方法，expire和expireAt，expire方法最后也是调用expireAt方法，含义就是在某一时刻过期。精确到毫秒级别。</p>
<h3 id="定时">定时</h3>
<p>用到了线程池，有个ScheduledExecutorService，有个方法叫scheduleAtFixedRate，开启额外的一个线程去定期执行这个任务。</p>
<p>具体的任务呢，就是Runnable接口：对于设置了过期时间的数据，我会额外把它放到另一个集合，也就是expireMap，这个Runnable
Task
就会遍历这个集合，判断某个key是否过期，如果过期，就把他从expireMap以及cache中移除。</p>
<h4 id="排序集合优化">排序集合优化</h4>
<p>在expireMap的基础上，添加了一种新的集合sortedExpireMap，借助了TreeMap。以时间戳为Key，value是同一过期时间段
key集合，这样runnable的task任务可以优化为，从map的第一个元素开始遍历（因为是从小到大排序嘛），按照时间戳递增的顺序搜索，判断每个时间段是否过期，过期了就把这个时间戳对应的集合中的key全部清除。</p>
<h3 id="惰性删除">惰性删除</h3>
<p>当调用缓存的get方法的时候，会顺带进行惰性删除，也就是</p>
<h3 id="随机key删除">随机key删除</h3>
<p>大致的实现跟前几个策略相同，采用了策略模式嘛，实现的细节略有不同</p>
<p>线程依旧是单线程，只不过频率是10ms一次，既然要随机key，那就需要写几个获取随机key的方法，提供了有获取单个key、获取批量key的方法。</p>
<p>单个key就很简单，就是取一个随机数，然后获取map的key集合进行遍历，这里遍历也分两种实现，一种是转成arraylist然后直接用get方法取，另一种就是利用keyset的迭代器去遍历。</p>
<p>多个key呢，设置了集合的上限，就是过期的key如果达到了50个，就停止继续向下查找，因为我额外的清除线程是每10ms运行一次，那一次清理过多可能影响下一次的运行，所以批量清除每次清除上限就是50个。</p>
<h2 id="内存驱逐策略">内存驱逐策略</h2>
<p>对于驱逐，就是缓存空间满了，对于新进来的缓存数据的一种处理策略。</p>
<h3 id="lru">LRU</h3>
<h4 id="双向链表-hash表">双向链表 + hash表</h4>
<p>对于get、update这种方法就要对具体的key做一个迁移操作，把key移动到链表前端。</p>
<p>基本的LRU存在缓存污染问题，比如说：某一时刻我一次性加入很多数据到缓存，这些数据可能就读取一次，但我本来的热点数据被这些新的数据挤掉了，因此不太合理。</p>
<h3 id="lru-2-1">LRU-2</h3>
<p>LRU-K算法的延伸，就是一个数据被访问K次才会进行一个迁移操作，目前最佳实践是LRU-2，就是访问两次，进行一个迁移操作处理。</p>
<p>具体实现：采用两个LRUmap，第一次访问的放到第一层，第二次访问的放到第二层。当进行淘汰时，优先淘汰第一层的数据，第二层的数据要淘汰就放到第一层去，类似于redis中对于LRU的改进：分为老年代新生代。</p>
<h3 id="lru2q-1">LRU2Q</h3>
<p>不采用两个lrumap，而采用一个fifo队列 +
一个lrumap，新进来的数据放到fifo队列，随后再次被访问就放入真正的lrumap中。</p>
<h3 id="lfu-2">LFU</h3>
<p>首先，LFU的结点定义与LRU不同的地方在于，结点定义了一个属性叫频率。</p>
<p>定义了两个Map结构：一个是</p>
<h3 id="clock-1">CLOCK</h3>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://vlsmhd.github.io">Vlong_shen</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://vlsmhd.github.io/2023/11/29/%E6%B8%90%E8%BF%9B%E5%BC%8Fredis%E7%BC%93%E5%AD%98%E5%B7%A5%E5%85%B7Vedis/">https://vlsmhd.github.io/2023/11/29/%E6%B8%90%E8%BF%9B%E5%BC%8Fredis%E7%BC%93%E5%AD%98%E5%B7%A5%E5%85%B7Vedis/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://vlsmhd.github.io" target="_blank">VLS_Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/img/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/12/18/JVM%E5%AD%A6%E4%B9%A0/" title="JVM学习"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">JVM学习</div></div></a></div><div class="next-post pull-right"><a href="/2023/11/27/%E6%89%8B%E5%86%99springMVC/" title="手写springMVC"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">手写springMVC</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Vlong_shen</div><div class="author-info__description">一名热爱编程的程序员</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">126</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">21</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">73</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/VLSmhd"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/VLSmhd" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="/-" target="_blank" title="联系我QQ：1067853293"><i class="fab fa-qq"></i></a><a class="social-icon" href="/-" target="_blank" title="微信：18956757208"><i class="fa fa-wechat"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.</span> <span class="toc-text">环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#git%E5%91%BD%E4%BB%A4%E5%B0%81%E8%A3%85"><span class="toc-number">1.1.</span> <span class="toc-text">git命令封装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E6%A0%BC%E5%BC%8F%E6%90%AD%E5%BB%BA"><span class="toc-number">1.2.</span> <span class="toc-text">项目格式搭建</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E5%9B%BA%E5%AE%9A%E5%A4%A7%E5%B0%8F%E7%BC%93%E5%AD%98"><span class="toc-number">2.</span> <span class="toc-text">基础固定大小缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-number">2.1.</span> <span class="toc-text">接口定义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.2.</span> <span class="toc-text">核心实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%BC%82%E5%B8%B8"><span class="toc-number">2.2.1.</span> <span class="toc-text">全局异常</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cache"><span class="toc-number">2.2.2.</span> <span class="toc-text">Cache</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cachecontext"><span class="toc-number">2.2.3.</span> <span class="toc-text">CacheContext</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%95%E5%AF%BC%E7%B1%BB"><span class="toc-number">2.2.4.</span> <span class="toc-text">引导类</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%87%E6%9C%9F%E5%88%A0%E9%99%A4"><span class="toc-number">3.</span> <span class="toc-text">过期删除</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89-1"><span class="toc-number">3.1.</span> <span class="toc-text">接口定义</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#icacheexpire"><span class="toc-number">3.1.1.</span> <span class="toc-text">ICacheExpire</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E7%BC%93%E5%AD%98%E8%BF%87%E6%9C%9F%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.2.</span> <span class="toc-text">基本缓存过期实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#cache-1"><span class="toc-number">3.2.1.</span> <span class="toc-text">Cache</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%87%E6%9C%9F%E4%BF%A1%E6%81%AF%E5%AD%98%E5%82%A8"><span class="toc-number">3.2.2.</span> <span class="toc-text">过期信息存储</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E6%9C%9F%E8%BD%AE%E8%AF%A2%E6%B8%85%E7%90%86%E6%B8%85%E7%A9%BA%E7%BC%93%E5%AD%98%E4%BB%BB%E5%8A%A1"><span class="toc-number">3.2.3.</span> <span class="toc-text">定期轮询清理&amp;清空缓存任务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%92%E5%BA%8F%E7%9A%84key-%E4%BC%98%E5%8C%96"><span class="toc-number">3.3.</span> <span class="toc-text">排序的key-优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.3.1.</span> <span class="toc-text">实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%83%B0%E6%80%A7%E5%88%A0%E9%99%A4%E7%AD%96%E7%95%A5"><span class="toc-number">3.4.</span> <span class="toc-text">惰性删除策略</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9A%8F%E6%9C%BA%E5%88%A0%E9%99%A4%E7%AD%96%E7%95%A5"><span class="toc-number">3.5.</span> <span class="toc-text">随机删除策略</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">4.</span> <span class="toc-text">持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#rdb"><span class="toc-number">4.1.</span> <span class="toc-text">RDB</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89-2"><span class="toc-number">4.1.1.</span> <span class="toc-text">接口定义</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E6%8E%A5%E5%8F%A3"><span class="toc-number">4.1.1.1.</span> <span class="toc-text">加载接口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96%E6%8E%A5%E5%8F%A3"><span class="toc-number">4.1.1.2.</span> <span class="toc-text">持久化接口</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-number">4.1.2.</span> <span class="toc-text">策略工具类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#json%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%BD%A2%E5%BC%8F%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">4.1.3.</span> <span class="toc-text">JSON字符串形式持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96%E5%AE%9E%E7%8E%B0%E7%B1%BBcachepersistfilejson"><span class="toc-number">4.1.3.1.</span> <span class="toc-text">持久化实现类CachePersistFileJson</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E5%AE%9E%E7%8E%B0%E7%B1%BBcacheloadfilejson"><span class="toc-number">4.1.3.2.</span> <span class="toc-text">加载实现类CacheLoadFileJson</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6rdb%E6%8C%81%E4%B9%85%E5%8C%96%E4%BB%BB%E5%8A%A1%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.1.4.</span> <span class="toc-text">定时RDB持久化任务实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#innercachepersist"><span class="toc-number">4.1.4.1.</span> <span class="toc-text">InnerCachePersist</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#aof"><span class="toc-number">4.2.</span> <span class="toc-text">AOF</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E8%A7%A3%E5%AE%9A%E4%B9%89"><span class="toc-number">4.2.1.</span> <span class="toc-text">注解定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96aofentry%E5%AE%9A%E4%B9%89"><span class="toc-number">4.2.2.</span> <span class="toc-text">持久化aofEntry定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-number">4.2.3.</span> <span class="toc-text">持久化拦截器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0aof"><span class="toc-number">4.2.4.</span> <span class="toc-text">实现AOF</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3"><span class="toc-number">4.2.4.1.</span> <span class="toc-text">接口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-1"><span class="toc-number">4.2.4.2.</span> <span class="toc-text">实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.2.5.</span> <span class="toc-text">加载的实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5"><span class="toc-number">5.</span> <span class="toc-text">淘汰策略</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89-3"><span class="toc-number">5.1.</span> <span class="toc-text">接口定义</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#icacheevict"><span class="toc-number">5.1.1.</span> <span class="toc-text">ICacheEvict</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#icacheevictcontext"><span class="toc-number">5.1.2.</span> <span class="toc-text">ICacheEvictContext</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%BD%E8%B1%A1%E7%AD%96%E7%95%A5%E7%B1%BB"><span class="toc-number">5.1.3.</span> <span class="toc-text">抽象策略类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E5%B7%A5%E5%85%B7%E7%B1%BB-1"><span class="toc-number">5.2.</span> <span class="toc-text">策略工具类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.3.</span> <span class="toc-text">具体实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#cacheevictcontext"><span class="toc-number">5.3.1.</span> <span class="toc-text">CacheEvictContext</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E7%AD%96%E7%95%A5"><span class="toc-number">5.3.2.</span> <span class="toc-text">无策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fifo"><span class="toc-number">5.3.3.</span> <span class="toc-text">FIFO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%B4%E7%B4%A0lru"><span class="toc-number">5.3.4.</span> <span class="toc-text">朴素LRU</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A9%B1%E9%80%90%E6%8B%A6%E6%88%AA%E5%99%A8%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.3.4.1.</span> <span class="toc-text">驱逐拦截器的实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8C%E5%90%91%E9%93%BE%E8%A1%A8-%E5%93%88%E5%B8%8C%E8%A1%A8lru%E4%BC%98%E5%8C%96"><span class="toc-number">5.3.5.</span> <span class="toc-text">双向链表 + 哈希表LRU优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89-4"><span class="toc-number">5.3.5.1.</span> <span class="toc-text">接口定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-2"><span class="toc-number">5.3.5.2.</span> <span class="toc-text">实现</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#cacheevictlrudoublelistmap"><span class="toc-number">5.3.5.2.1.</span> <span class="toc-text">CacheEvictLRUDoubleListMap</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#cacheevictlrulinkedhashmap"><span class="toc-number">5.3.5.2.2.</span> <span class="toc-text">CacheEvictLruLinkedHashMap</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lru2q"><span class="toc-number">5.3.6.</span> <span class="toc-text">LRU2Q</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-3"><span class="toc-number">5.3.6.1.</span> <span class="toc-text">实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lru-2"><span class="toc-number">5.3.7.</span> <span class="toc-text">LRU-2</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-4"><span class="toc-number">5.3.7.1.</span> <span class="toc-text">实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lfu"><span class="toc-number">5.3.8.</span> <span class="toc-text">LFU</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-5"><span class="toc-number">5.3.8.1.</span> <span class="toc-text">实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#clock"><span class="toc-number">5.3.9.</span> <span class="toc-text">Clock</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-6"><span class="toc-number">5.3.9.1.</span> <span class="toc-text">实现</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%9B%91%E5%90%AC%E5%99%A8"><span class="toc-number">6.</span> <span class="toc-text">监听器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E7%9B%91%E5%90%AC%E5%99%A8"><span class="toc-number">6.1.</span> <span class="toc-text">删除监听器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89-5"><span class="toc-number">6.1.1.</span> <span class="toc-text">接口定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-7"><span class="toc-number">6.1.2.</span> <span class="toc-text">实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#cacheremovelistener"><span class="toc-number">6.1.2.1.</span> <span class="toc-text">CacheRemoveListener</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cacheremovelistenercontext"><span class="toc-number">6.1.2.2.</span> <span class="toc-text">CacheRemoveListenerContext</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cacheremovelisteners"><span class="toc-number">6.1.2.3.</span> <span class="toc-text">CacheRemoveListeners</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%85%A2%E6%93%8D%E4%BD%9C%E7%9B%91%E5%90%AC%E5%99%A8"><span class="toc-number">6.2.</span> <span class="toc-text">慢操作监听器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89-6"><span class="toc-number">6.2.1.</span> <span class="toc-text">接口定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-8"><span class="toc-number">6.2.2.</span> <span class="toc-text">实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#cacheslowlistener"><span class="toc-number">6.2.2.1.</span> <span class="toc-text">CacheSlowListener</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cacheslowlistenercontext"><span class="toc-number">6.2.2.2.</span> <span class="toc-text">CacheSlowListenerContext</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cacheslowlisteners"><span class="toc-number">6.2.2.3.</span> <span class="toc-text">CacheSlowListeners</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%80%97%E6%97%B6%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-number">6.2.3.</span> <span class="toc-text">耗时拦截器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E4%BD%93%E7%B1%BBcacheentry%E4%BC%98%E5%8C%96"><span class="toc-number">6.3.</span> <span class="toc-text">实体类CacheEntry优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8"><span class="toc-number">6.3.1.</span> <span class="toc-text">应用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#evict"><span class="toc-number">6.3.1.1.</span> <span class="toc-text">evict</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cache%E7%BC%93%E5%AD%98%E5%86%85%E9%83%A8%E5%AF%BC%E5%85%A5%E4%BD%BF%E7%94%A8%E5%88%A0%E9%99%A4%E7%9B%91%E5%90%AC%E5%99%A8"><span class="toc-number">6.4.</span> <span class="toc-text">Cache缓存内部导入使用删除监听器</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%A3%E7%90%86"><span class="toc-number">7.</span> <span class="toc-text">代理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%90%86%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-number">7.1.</span> <span class="toc-text">*代理如何使用拦截器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3-1"><span class="toc-number">7.2.</span> <span class="toc-text">接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-9"><span class="toc-number">7.3.</span> <span class="toc-text">实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E4%BB%A3%E7%90%86"><span class="toc-number">7.3.1.</span> <span class="toc-text">无代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cglib%E4%BB%A3%E7%90%86"><span class="toc-number">7.3.2.</span> <span class="toc-text">CGLIB代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jdk%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86"><span class="toc-number">7.3.3.</span> <span class="toc-text">JDK动态代理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#guideproxy"><span class="toc-number">7.4.</span> <span class="toc-text">*GuideProxy</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#icacheproxyguidecontext"><span class="toc-number">7.4.1.</span> <span class="toc-text">ICacheProxyGuideContext</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cacheproxyguidecontext"><span class="toc-number">7.4.2.</span> <span class="toc-text">CacheProxyGuideContext</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cacheproxyguide"><span class="toc-number">7.4.3.</span> <span class="toc-text">CacheProxyGuide</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%89%8B%E5%86%99hashmap"><span class="toc-number">8.</span> <span class="toc-text">手写HashMap</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%89%A9%E5%AE%B9%E7%BC%A9%E5%AE%B9rehash"><span class="toc-number">9.</span> <span class="toc-text">扩容缩容rehash</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#redis%E6%89%A9%E5%AE%B9%E7%BC%A9%E5%AE%B9%E6%9C%BA%E5%88%B6"><span class="toc-number">9.1.</span> <span class="toc-text">redis扩容缩容机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B8%90%E8%BF%9B%E5%BC%8Frehash"><span class="toc-number">9.1.1.</span> <span class="toc-text">渐进式rehash</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%BE%E8%A7%A3%E6%B5%81%E7%A8%8B"><span class="toc-number">9.1.1.1.</span> <span class="toc-text">图解流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A9%E5%AE%B9%E6%9D%A1%E4%BB%B6"><span class="toc-number">9.1.1.2.</span> <span class="toc-text">扩容条件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%A9%E5%AE%B9%E6%9D%A1%E4%BB%B6"><span class="toc-number">9.1.1.3.</span> <span class="toc-text">缩容条件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-10"><span class="toc-number">9.2.</span> <span class="toc-text">实现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">10.</span> <span class="toc-text">测试</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%BA%E5%AE%9A%E5%A4%A7%E5%B0%8F%E7%BC%93%E5%AD%98"><span class="toc-number">10.1.</span> <span class="toc-text">固定大小缓存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#expire"><span class="toc-number">10.2.</span> <span class="toc-text">expire</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96-1"><span class="toc-number">10.3.</span> <span class="toc-text">持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#rdb-1"><span class="toc-number">10.3.1.</span> <span class="toc-text">RDB</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95bug"><span class="toc-number">10.3.1.1.</span> <span class="toc-text">测试bug</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%96%87%E4%BB%B6%E5%A4%B1%E8%B4%A5"><span class="toc-number">10.3.1.1.1.</span> <span class="toc-text">创建文件失败</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#aof-1"><span class="toc-number">10.3.2.</span> <span class="toc-text">AOF</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#evict-1"><span class="toc-number">10.4.</span> <span class="toc-text">evict</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#lru%E7%AD%96%E7%95%A5"><span class="toc-number">10.4.1.</span> <span class="toc-text">LRU策略</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95bug-1"><span class="toc-number">10.4.1.1.</span> <span class="toc-text">测试bug</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#lru%E7%9A%84list%E4%B8%8D%E4%BC%9A%E8%87%AA%E5%8A%A8%E6%B8%85%E9%99%A4%E6%B7%98%E6%B1%B0key"><span class="toc-number">10.4.1.1.1.</span> <span class="toc-text">lru的list不会自动清除淘汰key</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5-1"><span class="toc-number">10.5.</span> <span class="toc-text">淘汰策略</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#lfu-1"><span class="toc-number">10.5.1.</span> <span class="toc-text">lfu</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95bug-2"><span class="toc-number">10.5.1.1.</span> <span class="toc-text">测试bug</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#lfu%E9%9B%86%E5%90%88%E5%86%85%E5%AD%98%E5%86%97%E4%BD%99"><span class="toc-number">10.5.1.1.1.</span> <span class="toc-text">lfu集合内存冗余</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%93%E5%8C%85%E5%8F%91%E5%B8%83"><span class="toc-number">10.6.</span> <span class="toc-text">打包发布</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-number">11.</span> <span class="toc-text">工具类</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6"><span class="toc-number">11.1.</span> <span class="toc-text">文件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95"><span class="toc-number">12.</span> <span class="toc-text">面试</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E6%95%B4%E4%BD%93%E4%BB%8B%E7%BB%8D"><span class="toc-number">12.1.</span> <span class="toc-text">项目整体介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%87%E6%9C%9F%E7%89%B9%E6%80%A7"><span class="toc-number">12.2.</span> <span class="toc-text">过期特性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6"><span class="toc-number">12.2.1.</span> <span class="toc-text">定时</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%92%E5%BA%8F%E9%9B%86%E5%90%88%E4%BC%98%E5%8C%96"><span class="toc-number">12.2.1.1.</span> <span class="toc-text">排序集合优化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%83%B0%E6%80%A7%E5%88%A0%E9%99%A4"><span class="toc-number">12.2.2.</span> <span class="toc-text">惰性删除</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9A%8F%E6%9C%BAkey%E5%88%A0%E9%99%A4"><span class="toc-number">12.2.3.</span> <span class="toc-text">随机key删除</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E9%A9%B1%E9%80%90%E7%AD%96%E7%95%A5"><span class="toc-number">12.3.</span> <span class="toc-text">内存驱逐策略</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#lru"><span class="toc-number">12.3.1.</span> <span class="toc-text">LRU</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8C%E5%90%91%E9%93%BE%E8%A1%A8-hash%E8%A1%A8"><span class="toc-number">12.3.1.1.</span> <span class="toc-text">双向链表 + hash表</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lru-2-1"><span class="toc-number">12.3.2.</span> <span class="toc-text">LRU-2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lru2q-1"><span class="toc-number">12.3.3.</span> <span class="toc-text">LRU2Q</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lfu-2"><span class="toc-number">12.3.4.</span> <span class="toc-text">LFU</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#clock-1"><span class="toc-number">12.3.5.</span> <span class="toc-text">CLOCK</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/02/27/Feed%E6%B5%81%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/" title="Feed流系统设计">Feed流系统设计</a><time datetime="2024-02-27T06:57:38.771Z" title="发表于 2024-02-27 14:57:38">2024-02-27</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/02/27/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E5%9F%BA%E7%A1%80/" title="系统设计基础">系统设计基础</a><time datetime="2024-02-27T03:35:23.450Z" title="发表于 2024-02-27 11:35:23">2024-02-27</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/02/23/Golang-Learn/" title="Golang Learn">Golang Learn</a><time datetime="2024-02-23T07:53:53.680Z" title="发表于 2024-02-23 15:53:53">2024-02-23</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/02/05/leetcode-Hot100%E9%A2%98%E7%9B%AE%E6%B1%87%E6%80%BB/" title="leetcode-Hot100题目汇总">leetcode-Hot100题目汇总</a><time datetime="2024-02-05T01:49:33.095Z" title="发表于 2024-02-05 09:49:33">2024-02-05</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/01/04/2024%E6%98%A5%E6%8B%9B%E6%8A%95%E9%80%92%E8%AE%B0%E5%BD%95/" title="2024春招投递记录">2024春招投递记录</a><time datetime="2024-01-04T03:36:29.885Z" title="发表于 2024-01-04 11:36:29">2024-01-04</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Vlong_shen</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>