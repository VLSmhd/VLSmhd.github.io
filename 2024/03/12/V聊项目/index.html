<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>V聊项目 | VLS_Blog</title><meta name="author" content="Vlong_shen"><meta name="copyright" content="Vlong_shen"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="项目介绍 基于 Netty 实现的高性能分布式 IM 即时通讯系统，它支持对接用户自定义多端登录方式，它实现了消息的四大特性（实时、有序、可靠、幂等），架构层面吸收业界大牛的技术文章以及成熟产品实现。 技术栈 使用 Netty、Redis、Redisson、RabbitMQ、Zookeeper、RPC、Feign 等主流技术栈  Netty 实现高性能消息收发，应用层握手(用户登">
<meta property="og:type" content="article">
<meta property="og:title" content="V聊项目">
<meta property="og:url" content="https://vlsmhd.github.io/2024/03/12/V%E8%81%8A%E9%A1%B9%E7%9B%AE/index.html">
<meta property="og:site_name" content="VLS_Blog">
<meta property="og:description" content="项目介绍 基于 Netty 实现的高性能分布式 IM 即时通讯系统，它支持对接用户自定义多端登录方式，它实现了消息的四大特性（实时、有序、可靠、幂等），架构层面吸收业界大牛的技术文章以及成熟产品实现。 技术栈 使用 Netty、Redis、Redisson、RabbitMQ、Zookeeper、RPC、Feign 等主流技术栈  Netty 实现高性能消息收发，应用层握手(用户登">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://vlsmhd.github.io/img/avatar.jpg">
<meta property="article:published_time" content="2024-03-12T06:37:32.019Z">
<meta property="article:modified_time" content="2024-03-17T13:53:13.238Z">
<meta property="article:author" content="Vlong_shen">
<meta property="article:tag" content="learn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://vlsmhd.github.io/img/avatar.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://vlsmhd.github.io/2024/03/12/V%E8%81%8A%E9%A1%B9%E7%9B%AE/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'V聊项目',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-03-17 21:53:13'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="VLS_Blog" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">118</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">21</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">77</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/photos/"><i class="fa-fw fas fa-images"></i><span> Photo</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="VLS_Blog"><img class="site-icon" src="https://vlsmhd.github.io/img/avatar.jpg"/><span class="site-name">VLS_Blog</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/photos/"><i class="fa-fw fas fa-images"></i><span> Photo</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">V聊项目</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-03-12T06:37:32.019Z" title="发表于 2024-03-12 14:37:32">2024-03-12</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-03-17T13:53:13.238Z" title="更新于 2024-03-17 21:53:13">2024-03-17</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%A1%B9%E7%9B%AE/">项目</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%A1%B9%E7%9B%AE/IM%E7%B3%BB%E7%BB%9F/">IM系统</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="V聊项目"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="项目介绍">项目介绍</h1>
<p>基于 Netty 实现的高性能分布式 IM
即时通讯系统，它支持对接用户自定义多端登录方式，它实现了消息的四大特性（实时、有序、可靠、幂等），架构层面吸收业界大牛的技术文章以及成熟产品实现。</p>
<h2 id="技术栈">技术栈</h2>
<p>使用
<code>Netty</code>、<code>Redis</code>、<code>Redisson</code>、<code>RabbitMQ</code>、<code>Zookeeper</code>、<code>RPC</code>、<code>Feign</code>
等主流技术栈</p>
<ul>
<li>Netty
实现高性能消息收发，应用层握手(用户登录登出)，心跳检测(挂后台)</li>
<li><code>Redis</code> 和 <code>Redisson</code> 客户端实现用户 Session
信息的存储、发布订阅模式实现路由层信息缓存</li>
<li>RabbitMQ 解耦对接 TCP
网关服务和逻辑层交互、保证分布式下消息顺序性</li>
<li>Zookeeper 注册中心及时感知服务节点上线下线情况</li>
<li>Feign RPC 方式解耦消息发送方合法性校验</li>
</ul>
<h2 id="项目模块">项目模块</h2>
<p>采用 DDD
架构思想搭建各个模块层级，并使用大量设计模式优化架构，使项目易阅读、可扩展</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">im-system-vchat</span><br><span class="line">├─ im-codec           接入层：负责网关服务配置文件集成、私有协议包结构定义、消息编解码以及需要发送给 TCP 服务的数据包定义</span><br><span class="line">├─ im-common          基础层：负责定义整个 IM 架构所有常量、状态码、错误码、基础数据模型</span><br><span class="line">├─ im-domain          领域层：负责定义用户、好友、群组等多个领域的逻辑，以及消息的发送服务</span><br><span class="line">├─ im-message-store   消息存储层：通过 MQ 将消息异步持久化落库, 很薄的一层</span><br><span class="line">├─ im-infrastructure  基础层：负责定义底层组件如 redis、zk、mq 的配置逻辑，回调机制和基类消息发送</span><br><span class="line">└─ im-tcp             网关层：负责定义心跳机制、监控用户消息读取以及上线下线、Netty 消息通道以及 WebSocket 全双工通道</span><br></pre></td></tr></table></figure>
<h3 id="ddd架构简述">DDD架构简述</h3>
<p><strong>DDD（领域驱动设计）</strong>是一种软件开发方法，旨在帮助我们设计高质量的软件模型</p>
<ul>
<li><strong>领域驱动设计</strong>（Domain Driven
Design，简称DDD）是一种软件开发方法，专注于设计和实现高质量的领域模型。</li>
<li><strong>通用语言</strong>（Ubiquitous
Language，简称UL）是DDD中最具威力的特性之一。不管你在团队中的角色如何，只要你是团队的一员，你都将使用UL。</li>
<li><strong>限界上下文</strong>（Bounded
Context，简称BC）是DDD中的另一个关键概念。一个业务领域划分成若干个BC，它们之间通过Context
Map进行集成。领域模型存在于BC内。</li>
<li><strong>领域模型</strong>是关于某个特定业务领域的软件模型，通常通过对象模型来实现。领域模型同时包含了数据和行为，并且表达了准确的业务含义。</li>
</ul>
<p><strong>分层架构</strong></p>
<ul>
<li>分层架构是一种设计方法，有助于提高软件质量和性能。</li>
<li>分层架构的一个重要原则是每层只能与位于其下方的层发生耦合。</li>
<li>严格分层架构和松散分层架构是两种常见的分层方式。</li>
<li>分层架构的优点包括结构清晰、易于维护和升级，以及降低层与层之间的依赖。</li>
</ul>
<p><strong>DDD三种模式</strong></p>
<ul>
<li>经典四层架构
<ul>
<li><strong>用户界面层</strong>（User
Interface）：负责向用户显示信息和解释用户命令。</li>
<li><strong>应用层</strong>（Application）：定义软件要完成的任务，并操作领域对象解决实际问题。</li>
<li><strong>领域层</strong>（Domain）：表达业务概念、状态信息和规则，是业务软件的核心。</li>
<li><strong>基础设施层</strong>（Infrastructure）：提供通用的技术能力，如消息传递、持久化机制等。服务于上面三层</li>
</ul></li>
<li>DCI架构
<ul>
<li><strong>DCI架构</strong>（Data, Context,
Interaction）旨在反映最终用户的认知模型中的角色和交互。</li>
</ul></li>
</ul>
<h2 id="项目亮点">项目亮点</h2>
<ul>
<li>设计模式重构
<ul>
<li>使用策略模式重构用户操作指令逻辑</li>
<li>使用状态模式重构用户自定义多端登录方式</li>
<li>使用模板模式重构消息接收器(群聊、单聊的消息接收器逻辑十分相似)</li>
</ul></li>
<li>使用 Redis 缓存用户信息的方式模拟路由层，实现跨服务之间的多 Channel
通讯</li>
<li>使用 Redisson
发布订阅模式，监听用户登录行为，发送用户下线通知。存储用户多端设备的
Session 信息</li>
<li>使用 Rabbitmq 处理分布式消息顺序性,
异步执行历史消息落库持久化等问题, 并且解决线上 MQ
消息积压和消息不一致等问题</li>
<li>使用拦截器机制, 通过 HMAC-SHA256 加密算法实现接口加密防刷,
提升系统安全性</li>
<li>单聊、群聊服务优化改造(实时性、有序性、可靠性、幂等性)
<ul>
<li>实时性: 使用线程池、MQ 异步持久化、RPC
解耦合法性校验大幅提升消息实时性, 接口响应从 400ms 提升至 15ms</li>
<li>可靠性: 通过应用层两次握手, 即发送方接收上、下行 ACK 确保消息可靠性,
解决消息丢失问题。消息丢包率从 6.32% 下降到 1.64%</li>
<li>有序性: 使用 Redis 原子递增 incr 保证消息有序性,
解决消息乱序问题</li>
<li>幂等性: 通过防重 ID,
服务端、客户端缓存消息等幂等性手段遏制消息重复现象,
并限制消息的无限制重试, 接口异常情况从 8.13% 下降到 1.47%</li>
</ul></li>
<li>实现单聊、群聊消息已读和已读回执功能</li>
<li>采用读扩散实现单聊、群聊离线消息拉取</li>
</ul>
<h1 id="架构设计">架构设计</h1>
<p>一般使用WebSocket的架构图：</p>
<p><img src="V聊项目/image-20240314150345646.png" alt="WebSocket的架构图" style="zoom:67%;" /></p>
<h2 id="私有协议">私有协议</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+------------------------------------------------------+</span><br><span class="line">| 指令 4byte     | 协议版本号 4byte  | 消息解析类型 4byte  |</span><br><span class="line">+------------------------------------------------------+</span><br><span class="line">| 设备类型 4byte  | 设备号长度 4byte  | 平台ID 4byte      | </span><br><span class="line">+------------------------------------------------------+</span><br><span class="line">| 数据长度 4byte  | 数据内容(设备号 imei 4byte + 请求体)   |</span><br><span class="line">+------------------------------------------------------+</span><br></pre></td></tr></table></figure>
<p>头部包含28字节。</p>
<h2 id="消息的存储">消息的存储</h2>
<h3 id="数据结构">数据结构</h3>
<p>唯一标识：msgID，特征如下：</p>
<ul>
<li>唯一性：分布式情况下必须全局唯一</li>
<li>趋势递增：在 MySQL InnoDB 引擎中使用的是聚集索引，由于多数 RDBMS
使用 B-tree
的数据结构来存储索引数据，在主键的选择上面我们应该尽量使用有序的主键保证写入性能。</li>
<li>单调递增：保证下一个 ID 一定大于上一个 ID，例如事务版本号，IM
增量消息、排序等等</li>
<li>非连续，无规则：防止安全泄密</li>
</ul>
<p>二、三点的特性，保证消息的可排序性，这样就能根据消息的ID排序，可以解决后续的消息顺序性的问题</p>
<h2 id="消息的投递过程">消息的投递过程</h2>
<p><img src="V聊项目/消息流转.png" alt="一条消息的流转" style="zoom: 67%;" /></p>
<p>流程：</p>
<ol type="1">
<li>客户端A发送消息，消息通过自定义私有协议序列化为二进制，经过操作系统内核处理，与服务端建立TCP连接（三次握手），保证传输层的稳定性（上下行ACK）</li>
<li>服务端将消息发送到消息队列，投递到MQ的生产者
<ol type="1">
<li>生产者将这条消息推送到 MQ 的指定队列 (queue =
pipeline2MessageService) 进行处理</li>
<li>消费者通过订阅消息传输队列接收这条消息</li>
</ol></li>
<li>服务端通过将消息投递到 MQ 指定队列 (queue = MessageService2pipeline)
进行处理</li>
<li>客户端 userB 成功接收服务端投递过来的消息,
完成整个消息的发送接收</li>
</ol>
<h2 id="路由层设计">路由层设计</h2>
<figure>
<img src="V聊项目/分布式路由层.png" alt="分布式路由层" />
<figcaption aria-hidden="true">分布式路由层</figcaption>
</figure>
<p>由于使用了分布式,
用户的信息会因为负载均衡分布在不同的服务器上，怎么保证多 Channel
的跨节点通讯就显得额外的重要。</p>
<p>在这里我们使用了 Redis 来模拟路由层, MQ 进行消息解耦, k-v 分别为
toUserId 和目标用户所在的服务器节点。当然, 可能会出现同一个 toUserId
对应多个路由层节点，对于此我们只取第一个成功获取即可</p>
<p>消息请求通过 Netty
传递到路由层，在路由层上有高速缓存表，可以快速的获取到消息传递的目的地，并且由于路由层是无状态的，可以很方便进行水平扩容，搭建集群</p>
<p>流程如下：</p>
<ol type="1">
<li>发送方将消息发送到自己所在的节点。</li>
<li>发送方所在的节点进行消息路由，根据接收方所在的节点，将消息路由到对应的节点。
<ol type="1">
<li>由于我们在用户的 Session 中设计了 brokerId 和 ip 地址,
因此我们可以获取到对方的节点</li>
<li>之后的通讯通过 MQ 解耦消息的接收,</li>
</ol></li>
<li>接收方在自己所在的节点上接收到消息并处理。</li>
</ol>
<p>在这里我选择使用 MQ 进行服务端和客户端的解耦，理由有二:
如果使用传统方式(点对点、广播)，都需要涉及到消息数据的发送,
怎么保证消息能够发送到对应节点是一个非常难以把控的事情。 因此我使用 MQ +
Redis 的方式, redis 作为集中路由, value 里包含了 brokerId 和 port
每一个机器都绑定自己对应的 MQ 队列</p>
<blockquote>
<p>但其实本质上是集中式路由，所有的消息都通过中央服务器进行路由，中央路由器中央服务器根据消息的接收方信息来决定将消息路由到哪个节点。相比分布式路由，集中式路由实现简单，但是中央服务器成为了系统的瓶颈(单点故障)，可能会限制系统的性能和可扩展性。</p>
</blockquote>
<blockquote>
<p>分布式路由：将消息路由的权力分散到各个节点中，每个节点都可以进行消息的路由请求处理。这种方式可以提高系统的可扩展性和容灾性，但实现会比较复杂。(后续真正实现路由层的时候会考虑分布式路由的架构设计)</p>
</blockquote>
<h2 id="读写扩散群聊单聊">读写扩散——群聊、单聊</h2>
<h4 id="写扩散">写扩散</h4>
<figure>
<img src="V聊项目/写扩散.png" alt="写扩散" />
<figcaption aria-hidden="true">写扩散</figcaption>
</figure>
<ul>
<li>在架构中, 单聊会话消息采用写扩散</li>
</ul>
<p>写扩散优缺：</p>
<p>优点：</p>
<ul>
<li>控制逻辑与数据读取逻辑简单；</li>
<li>用户数据独立，满足更多的业务场景，比如：回执消息、云端删除等等；</li>
<li>一个数据点丢失，不影响其他用户的数据点。</li>
</ul>
<p>缺点：</p>
<ul>
<li>存储空间的增加；</li>
<li>写扩散需要专门的扩散队列；</li>
<li>先写扩散后读，实时性差。</li>
</ul>
<h4 id="读扩散">读扩散</h4>
<figure>
<img src="V聊项目/读扩散.png" alt="读扩散" />
<figcaption aria-hidden="true">读扩散</figcaption>
</figure>
<ul>
<li>在架构中, 群聊会话消息采用读扩散</li>
</ul>
<p>读扩散优缺：</p>
<p>优点：</p>
<ul>
<li>数据实时性高；</li>
<li>写入逻辑简单；</li>
<li>节约存储空间。</li>
</ul>
<p>缺点：</p>
<ul>
<li>数据读取会存在热点问题；</li>
<li>需要维护离线群成员与未读消息的关系。</li>
</ul>
<h2 id="消息同步模型">消息同步模型</h2>
<h3 id="多端消息同步">多端消息同步</h3>
<p>由于 WhaleShark
实现了用户多端同步，因此需要保证一条消息既同步给发送方的其他端，又得保证消息能发送给目标对象的所有端。正常情况一条消息的处理流程如下：</p>
<p><img src="V聊项目/多端消息同步的弊端.png" alt="多端消息同步的弊端-消息裂变" style="zoom:67%;" /></p>
<p>客户端A在IOS端向安卓端的客户端B发送消息，这时候消息需要同步到这两个用户的两个端（可能还会有其它端口）</p>
<h1 id="代码实现">代码实现</h1>
<h2 id="codec模块">CodeC模块</h2>
<h3 id="协议proto定义">协议proto定义</h3>
<p><strong>Message</strong></p>
<p>消息由消息头 + 消息体组成</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Message</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MessageHeader messageHeader;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object messagePack;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>MessageHeader</strong></p>
<p>消息头规定、定义了传输协议需要携带的字段。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageHeader</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息操作指令(4字节) 十六进制 一个消息的开始通常以0x开头</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer command;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 4字节 版本号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer version;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 4字节 端类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer clientType;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 应用ID(4字节)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer appId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据解析类型(4字节) 和具体业务无关</span></span><br><span class="line"><span class="comment">     * 后续根据解析类型解析data数据 0x0:Json,0x1:ProtoBuf,0x2:Xml,默认:0x0</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">messageType</span> <span class="operator">=</span> MessageType.DATA_TYPE_JSON.getCode();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 4字节 imei长度</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer imeiLength;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 4字节 包体长度</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> length;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * imei号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String imei;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>MessagePack</strong></p>
<p>消息服务发送给 TCP的包体信息，TCP 再根据包体协议解析成 Message
发送给客户端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessagePack</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String userId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer appId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 接收方</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String toId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 客户端标识</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> clientType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String messageId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 客户端设备唯一标识</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String imei;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer command;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 业务数据对象，如果是聊天消息则不需要解析直接透传</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="编解码器">编解码器</h3>
<h4 id="socket">Socket</h4>
<p>消息 -&gt; 字节流 字节流 -&gt; 消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageEncoderHandler</span> <span class="keyword">extends</span> <span class="title class_">MessageToByteEncoder</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">encode</span><span class="params">(ChannelHandlerContext ctx, Object msg, ByteBuf out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> MessagePack) &#123;</span><br><span class="line">            <span class="type">MessagePack</span> <span class="variable">msgBody</span> <span class="operator">=</span> (MessagePack) msg;</span><br><span class="line">            <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> JSONObject.toJSONString(msgBody.getData());</span><br><span class="line">            <span class="type">byte</span>[] bytes = s.getBytes();</span><br><span class="line">            out.writeInt(msgBody.getCommand());</span><br><span class="line">            out.writeInt(bytes.length);</span><br><span class="line">            out.writeBytes(bytes);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageDecoderHandler</span> <span class="keyword">extends</span> <span class="title class_">ByteToMessageDecoder</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">decode</span><span class="params">(ChannelHandlerContext ctx,</span></span><br><span class="line"><span class="params">                          ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 解析私有协议</span></span><br><span class="line">        <span class="keyword">if</span> (in.readableBytes() &lt; PACKET_CODEC_LENGTH) &#123;</span><br><span class="line">            ctx.channel().close();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> ByteBufToMessageUtils.transition(in);</span><br><span class="line">        out.add(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="websocket">WebSocket</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketMessageDecoderHandler</span> <span class="keyword">extends</span> <span class="title class_">MessageToMessageDecoder</span>&lt;BinaryWebSocketFrame&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">decode</span><span class="params">(ChannelHandlerContext ctx, BinaryWebSocketFrame msg, List&lt;Object&gt; out)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">content</span> <span class="operator">=</span> msg.content();</span><br><span class="line">        <span class="keyword">if</span> (content.readableBytes() &lt; PACKET_CODEC_LENGTH) &#123;</span><br><span class="line">            ctx.channel().close();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            message = ByteBufToMessageUtils.transition(content);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (message == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        out.add(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketMessageEncoderHandler</span> <span class="keyword">extends</span> <span class="title class_">MessageToMessageEncoder</span>&lt;MessagePack&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">encode</span><span class="params">(ChannelHandlerContext ctx, MessagePack msg, List&lt;Object&gt; out)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> JSONObject.toJSONString(msg);</span><br><span class="line">            <span class="type">ByteBuf</span> <span class="variable">byteBuf</span> <span class="operator">=</span> Unpooled.directBuffer(<span class="number">8</span> + s.length());</span><br><span class="line">            <span class="type">byte</span>[] bytes = s.getBytes();</span><br><span class="line">            byteBuf.writeInt(msg.getCommand());</span><br><span class="line">            byteBuf.writeInt(bytes.length);</span><br><span class="line">            byteBuf.writeBytes(bytes);</span><br><span class="line">            out.add(<span class="keyword">new</span> <span class="title class_">BinaryWebSocketFrame</span>(byteBuf));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="pack">pack</h3>
<p>需要发送给 TCP
服务的数据包定义，基本上都是类中定义的属性，用于指定发送消息的种类</p>
<h2 id="tcp模块">TCP模块</h2>
<h3 id="心跳机制">心跳机制</h3>
<p>Netty部分实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">userEventTriggered</span><span class="params">(ChannelHandlerContext ctx, Object evt)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 判断 evt 是否是 IdleStateEvent (用于触发用户事件，包含 读空闲/写空闲/读写空闲）</span></span><br><span class="line">    <span class="keyword">if</span>(evt <span class="keyword">instanceof</span> IdleStateEvent) &#123;</span><br><span class="line">        <span class="comment">// 强制类型转换</span></span><br><span class="line">        <span class="type">IdleStateEvent</span> <span class="variable">event</span> <span class="operator">=</span> (IdleStateEvent) evt;</span><br><span class="line">        <span class="keyword">if</span> (event.state() == IdleState.READER_IDLE) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;进入读空闲...&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.state() == IdleState.WRITER_IDLE) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;进入写空闲...&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.state() == IdleState.ALL_IDLE) &#123;</span><br><span class="line">            <span class="type">Long</span> <span class="variable">lastReadTime</span> <span class="operator">=</span> (Long) ctx.channel().attr(AttributeKey.valueOf(</span><br><span class="line">                    Constants.ChannelConstants.ReadTime)).get();</span><br><span class="line">            <span class="type">long</span> <span class="variable">nowReadTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (lastReadTime != <span class="literal">null</span> &amp;&amp; nowReadTime - lastReadTime &gt; heartBeatTime) &#123;</span><br><span class="line">                <span class="comment">// 用户退后台</span></span><br><span class="line">                UserChannelRepository.forceOffLine(ctx.channel());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="im-server">IM Server</h3>
<h3 id="websocket-1">WebSocket</h3>
<h2 id="infrastructure-基础层模块">infrastructure 基础层模块</h2>
<h3 id="redission">Redission</h3>
<h4 id="监听登录">监听登录</h4>
<p>监听器定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserLoginMessageListener</span> &#123;</span><br><span class="line">    <span class="comment">//登录模式：单端、双端等</span></span><br><span class="line">    <span class="keyword">private</span> Integer loginModel;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserLoginMessageListener</span><span class="params">(Integer loginModel)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.loginModel = loginModel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenerUserLogin</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 监听者监听 UserLoginChannel 队列</span></span><br><span class="line">        <span class="type">RTopic</span> <span class="variable">topic</span> <span class="operator">=</span> RedissonManager.getRedissonClient().getTopic(Constants.RedisConstants.UserLoginChannel);</span><br><span class="line">        topic.addListener(String.class, (CharSequence charSequence, String msg) -&gt; &#123;</span><br><span class="line">            log.info(<span class="string">&quot;收到用户上线通知 &#123;&#125;&quot;</span>, msg);</span><br><span class="line">            <span class="type">UserClientDto</span> <span class="variable">dto</span> <span class="operator">=</span> JSONObject.parseObject(msg, UserClientDto.class);</span><br><span class="line">            <span class="type">LoginStatusFactory</span> <span class="variable">loginStatusFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LoginStatusFactory</span>();</span><br><span class="line">            loginStatusFactory.chooseLoginStatus(loginModel);</span><br><span class="line">            loginStatusFactory.handleUserLogin(dto);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用户登录逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">systemStrategy</span><span class="params">(CommandExecution commandExecution)</span> &#123;</span><br><span class="line">    <span class="type">ChannelHandlerContext</span> <span class="variable">ctx</span> <span class="operator">=</span> commandExecution.getCtx();</span><br><span class="line">    <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> commandExecution.getMsg();</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">brokeId</span> <span class="operator">=</span> commandExecution.getBrokeId();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析 msg</span></span><br><span class="line">    <span class="type">LoginPack</span> <span class="variable">loginPack</span> <span class="operator">=</span> JSON.parseObject(JSONObject.toJSONString(msg.getMessagePack()),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;LoginPack&gt;() &#123;</span><br><span class="line"></span><br><span class="line">            &#125;.getType());</span><br><span class="line">    <span class="type">UserClientDto</span> <span class="variable">userClientDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserClientDto</span>();</span><br><span class="line">    userClientDto.setUserId(loginPack.getUserId());</span><br><span class="line">    userClientDto.setAppId(msg.getMessageHeader().getAppId());</span><br><span class="line">    userClientDto.setClientType(msg.getMessageHeader().getClientType());</span><br><span class="line">    userClientDto.setImei(msg.getMessageHeader().getImei());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 双向绑定</span></span><br><span class="line">    UserChannelRepository.bind(userClientDto, ctx.channel());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Redisson 高速存储用户 Session</span></span><br><span class="line">    <span class="type">UserSession</span> <span class="variable">userSession</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserSession</span>();</span><br><span class="line">    userSession.setUserId(loginPack.getUserId());</span><br><span class="line">    userSession.setAppId(msg.getMessageHeader().getAppId());</span><br><span class="line">    userSession.setClientType(msg.getMessageHeader().getClientType());</span><br><span class="line">    userSession.setConnectState(ConnectState.CONNECT_STATE_ONLINE.getCode());</span><br><span class="line">    userSession.setImei(userClientDto.getImei());</span><br><span class="line">    userSession.setBrokerId(brokeId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">InetAddress</span> <span class="variable">localHost</span> <span class="operator">=</span> InetAddress.getLocalHost();</span><br><span class="line">        userSession.setBrokerHost(localHost.getHostAddress());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 存储到 Redis</span></span><br><span class="line">    <span class="type">RedissonClient</span> <span class="variable">redissonClient</span> <span class="operator">=</span> RedissonManager.getRedissonClient();</span><br><span class="line">    RMap&lt;String, String&gt; map = redissonClient.getMap(</span><br><span class="line">            msg.getMessageHeader().getAppId() +</span><br><span class="line">                    Constants.RedisConstants.UserSessionConstants +</span><br><span class="line">                    loginPack.getUserId());</span><br><span class="line">    map.put(msg.getMessageHeader().getClientType() + <span class="string">&quot;:&quot;</span></span><br><span class="line">                    + msg.getMessageHeader().getImei(),</span><br><span class="line">            JSONObject.toJSONString(userSession));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 redisson 发布订阅模式实现用户上线通知的消息广播</span></span><br><span class="line">    <span class="type">RTopic</span> <span class="variable">topic</span> <span class="operator">=</span> redissonClient.getTopic(Constants.RedisConstants.UserLoginChannel);</span><br><span class="line">    topic.publish(JSONObject.toJSONString(userClientDto));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="用户下线通知广播">用户下线通知广播</h4>
<p>用户下线，把消息发送到网关层</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发送用户下线消息</span></span><br><span class="line"><span class="comment"> * 并不是真正粗暴清除 channel 里的旧信息，因为需要等待数据包停止传输</span></span><br><span class="line"><span class="comment"> * 在服务器行为中，能清除 channel 里旧信息的方式只有 用户登出 Logout 和 心跳超时 Ping-out</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> userChannel</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sendMutualLoginMsg</span><span class="params">(Channel userChannel, Integer channelClientType, String channelImei, UserClientDto dto)</span> &#123;</span><br><span class="line">    <span class="comment">// 踢掉 channel 所绑定的旧的同端登录状态</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">channelDevice</span> <span class="operator">=</span> parseClientType(channelClientType) + <span class="string">&quot;:&quot;</span> + channelImei;</span><br><span class="line">    <span class="type">String</span> <span class="variable">newChannelDevice</span> <span class="operator">=</span> parseClientType(dto.getClientType()) + <span class="string">&quot;:&quot;</span> + dto.getImei();</span><br><span class="line">    <span class="keyword">if</span> (!(channelDevice).equals(newChannelDevice)) &#123;</span><br><span class="line">        <span class="comment">// 行为埋点</span></span><br><span class="line">        log.info(<span class="string">&quot;第三方平台(appId) [&#123;&#125;] 用户(userId) [&#123;&#125;] 从新端 [&#123;&#125;] 登录(login) , 旧端 [&#123;&#125;] 下线(line) &quot;</span>,</span><br><span class="line">                dto.getAppId(), dto.getUserId(), newChannelDevice, channelDevice);</span><br><span class="line">        MessagePack&lt;Object&gt; pack = <span class="keyword">new</span> <span class="title class_">MessagePack</span>&lt;&gt;();</span><br><span class="line">        pack.setToId((String) userChannel.attr(AttributeKey.valueOf(Constants.ChannelConstants.UserId)).get());</span><br><span class="line">        pack.setUserId((String) userChannel.attr(AttributeKey.valueOf(Constants.ChannelConstants.UserId)).get());</span><br><span class="line">        pack.setCommand(SystemCommand.MUTALOGIN.getCommand());</span><br><span class="line">        userChannel.writeAndFlush(pack);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="路由层">路由层</h2>
<h3 id="结点路由算法">结点路由算法</h3>
<p>基于策略模式搭建</p>
<h4 id="hash">hash</h4>
<p>实现逻辑：</p>
<ol type="1">
<li><p>将地址列表中每一个地址进行hash计算，存到TreeMap中，TreeMap会根据key进行排序，（key为hash，value为地址）</p></li>
<li><p>根据客户端传来的key信息，进行hash计算，在TreeMap中找到与这个hash值最相近的结点，获取它的value，这个value就是请求要发送的地址</p></li>
<li><p>当我们要扩容一个机器，那么TreeMap中就会多存一个数据，这个数据就是新扩容的机器地址，我们所说的一致性，并不是说新增之后所有的数据都能够正常访问，只是相对来说，节点越多，失效的数据越少，因为我们找节点（服务器ip地址）是按照范围来找的</p></li>
</ol>
<h4 id="轮询随机">轮询&amp;随机</h4>
<h3 id="用户登录的路由选择">用户登录的路由选择</h3>
<p>用户登录以后，由于系统是分布式的，所以要给用户分配一个服务地址。每个服务器都在zk中注册了服务地址，就可以将服务器列表和用户登录的客户端id唯一标识，传给路由的函数，路由函数就会根据这个列表创建一颗TreeMap，执行一致性hash算法，得到具体的服务地址，返回给客户端，这样客户端就会一直用这个请求。</p>
<p>与此同时，redis就会存储一个字符串类型的k -
v键值对，以用户id作为Key，服务器结点地址作为value。这样跨结点通讯就能通过访问redis的key获取目标用户的服务地址。</p>
<h2 id="domain">Domain</h2>
<h3 id="conversation">conversation</h3>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://vlsmhd.github.io">Vlong_shen</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://vlsmhd.github.io/2024/03/12/V%E8%81%8A%E9%A1%B9%E7%9B%AE/">https://vlsmhd.github.io/2024/03/12/V%E8%81%8A%E9%A1%B9%E7%9B%AE/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://vlsmhd.github.io" target="_blank">VLS_Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/img/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/03/13/WebSocket/" title="WebSocket"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">WebSocket</div></div></a></div><div class="next-post pull-right"><a href="/2024/03/12/Github%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/" title="Github使用指南"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Github使用指南</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Vlong_shen</div><div class="author-info__description">一名热爱编程的程序员</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">118</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">21</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">77</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/VLSmhd"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/VLSmhd" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="/-" target="_blank" title="联系我QQ：1067853293"><i class="fab fa-qq"></i></a><a class="social-icon" href="/-" target="_blank" title="微信：18956757208"><i class="fa fa-wechat"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">项目介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E6%A0%88"><span class="toc-number">1.1.</span> <span class="toc-text">技术栈</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E6%A8%A1%E5%9D%97"><span class="toc-number">1.2.</span> <span class="toc-text">项目模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ddd%E6%9E%B6%E6%9E%84%E7%AE%80%E8%BF%B0"><span class="toc-number">1.2.1.</span> <span class="toc-text">DDD架构简述</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E4%BA%AE%E7%82%B9"><span class="toc-number">1.3.</span> <span class="toc-text">项目亮点</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">2.</span> <span class="toc-text">架构设计</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A7%81%E6%9C%89%E5%8D%8F%E8%AE%AE"><span class="toc-number">2.1.</span> <span class="toc-text">私有协议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E7%9A%84%E5%AD%98%E5%82%A8"><span class="toc-number">2.2.</span> <span class="toc-text">消息的存储</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">2.2.1.</span> <span class="toc-text">数据结构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E7%9A%84%E6%8A%95%E9%80%92%E8%BF%87%E7%A8%8B"><span class="toc-number">2.3.</span> <span class="toc-text">消息的投递过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E5%B1%82%E8%AE%BE%E8%AE%A1"><span class="toc-number">2.4.</span> <span class="toc-text">路由层设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%BB%E5%86%99%E6%89%A9%E6%95%A3%E7%BE%A4%E8%81%8A%E5%8D%95%E8%81%8A"><span class="toc-number">2.5.</span> <span class="toc-text">读写扩散——群聊、单聊</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%99%E6%89%A9%E6%95%A3"><span class="toc-number">2.5.0.1.</span> <span class="toc-text">写扩散</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BB%E6%89%A9%E6%95%A3"><span class="toc-number">2.5.0.2.</span> <span class="toc-text">读扩散</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E5%90%8C%E6%AD%A5%E6%A8%A1%E5%9E%8B"><span class="toc-number">2.6.</span> <span class="toc-text">消息同步模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E7%AB%AF%E6%B6%88%E6%81%AF%E5%90%8C%E6%AD%A5"><span class="toc-number">2.6.1.</span> <span class="toc-text">多端消息同步</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.</span> <span class="toc-text">代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#codec%E6%A8%A1%E5%9D%97"><span class="toc-number">3.1.</span> <span class="toc-text">CodeC模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%8F%E8%AE%AEproto%E5%AE%9A%E4%B9%89"><span class="toc-number">3.1.1.</span> <span class="toc-text">协议proto定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%A7%A3%E7%A0%81%E5%99%A8"><span class="toc-number">3.1.2.</span> <span class="toc-text">编解码器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#socket"><span class="toc-number">3.1.2.1.</span> <span class="toc-text">Socket</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#websocket"><span class="toc-number">3.1.2.2.</span> <span class="toc-text">WebSocket</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pack"><span class="toc-number">3.1.3.</span> <span class="toc-text">pack</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#tcp%E6%A8%A1%E5%9D%97"><span class="toc-number">3.2.</span> <span class="toc-text">TCP模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BF%83%E8%B7%B3%E6%9C%BA%E5%88%B6"><span class="toc-number">3.2.1.</span> <span class="toc-text">心跳机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#im-server"><span class="toc-number">3.2.2.</span> <span class="toc-text">IM Server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#websocket-1"><span class="toc-number">3.2.3.</span> <span class="toc-text">WebSocket</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#infrastructure-%E5%9F%BA%E7%A1%80%E5%B1%82%E6%A8%A1%E5%9D%97"><span class="toc-number">3.3.</span> <span class="toc-text">infrastructure 基础层模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#redission"><span class="toc-number">3.3.1.</span> <span class="toc-text">Redission</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%91%E5%90%AC%E7%99%BB%E5%BD%95"><span class="toc-number">3.3.1.1.</span> <span class="toc-text">监听登录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E4%B8%8B%E7%BA%BF%E9%80%9A%E7%9F%A5%E5%B9%BF%E6%92%AD"><span class="toc-number">3.3.1.2.</span> <span class="toc-text">用户下线通知广播</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E5%B1%82"><span class="toc-number">3.4.</span> <span class="toc-text">路由层</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%93%E7%82%B9%E8%B7%AF%E7%94%B1%E7%AE%97%E6%B3%95"><span class="toc-number">3.4.1.</span> <span class="toc-text">结点路由算法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#hash"><span class="toc-number">3.4.1.1.</span> <span class="toc-text">hash</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BD%AE%E8%AF%A2%E9%9A%8F%E6%9C%BA"><span class="toc-number">3.4.1.2.</span> <span class="toc-text">轮询&amp;随机</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E7%9A%84%E8%B7%AF%E7%94%B1%E9%80%89%E6%8B%A9"><span class="toc-number">3.4.2.</span> <span class="toc-text">用户登录的路由选择</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#domain"><span class="toc-number">3.5.</span> <span class="toc-text">Domain</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#conversation"><span class="toc-number">3.5.1.</span> <span class="toc-text">conversation</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/03/13/WebSocket/" title="WebSocket">WebSocket</a><time datetime="2024-03-13T09:07:51.702Z" title="发表于 2024-03-13 17:07:51">2024-03-13</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/03/12/V%E8%81%8A%E9%A1%B9%E7%9B%AE/" title="V聊项目">V聊项目</a><time datetime="2024-03-12T06:37:32.019Z" title="发表于 2024-03-12 14:37:32">2024-03-12</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/03/12/Github%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/" title="Github使用指南">Github使用指南</a><time datetime="2024-03-12T05:13:50.541Z" title="发表于 2024-03-12 13:13:50">2024-03-12</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/03/01/%E7%94%A8%E5%8F%8B%E5%AE%9E%E4%B9%A0%E7%BB%8F%E5%8E%86/" title="用友实习经历">用友实习经历</a><time datetime="2024-03-01T05:15:29.005Z" title="发表于 2024-03-01 13:15:29">2024-03-01</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/02/27/Feed%E6%B5%81%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/" title="Feed流系统设计">Feed流系统设计</a><time datetime="2024-02-27T06:57:38.771Z" title="发表于 2024-02-27 14:57:38">2024-02-27</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Vlong_shen</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>